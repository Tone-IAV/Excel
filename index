<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Plataforma Gamificada — Curso de Excel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#217346',
            accent: '#71B340',
            ink: '#0b3d2e'
          },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,.08)' },
          borderRadius: { '2xl':'1.25rem' },
          fontFamily: {
            sans: ['Inter','Segoe UI','system-ui','-apple-system','BlinkMacSystemFont','Roboto','sans-serif']
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <script>
    window.__INITIAL_ROUTE__ = '<?= initialRoute ?>';
  </script>
  <style>
    body { font-family:'Inter','Segoe UI','system-ui','-apple-system','BlinkMacSystemFont','Roboto','sans-serif'; }
    .card { --card-bg:#fff; --card-border:transparent; --card-shadow:0 10px 30px rgba(0,0,0,.08); border-radius:0.75rem; padding:1.25rem; background:var(--card-bg); border:1px solid var(--card-border); box-shadow:var(--card-shadow); }
    .dark .card { --card-bg:#0f172a; --card-border:rgba(71,85,105,.45); --card-shadow:0 10px 30px rgba(15,23,42,.45); }
    .card-flat { --card-bg:rgba(248,250,252,.95); --card-border:rgba(148,163,184,.35); --card-shadow:none; border-radius:0.75rem; }
    .dark .card-flat { --card-bg:rgba(15,23,42,.85); --card-border:rgba(148,163,184,.25); }
    .card-transparent { --card-bg:rgba(255,255,255,.65); --card-border:rgba(148,163,184,.25); --card-shadow:none; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-radius:0.75rem; }
    .dark .card-transparent { --card-bg:rgba(15,23,42,.6); --card-border:rgba(148,163,184,.3); }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .9rem; border-radius:.7rem; border:1px solid transparent; font-weight:600; transition:background-color .2s ease,color .2s ease,box-shadow .2s ease,border-color .2s ease; }
    .btn-primary { background:#217346; color:#fff; box-shadow:0 10px 24px rgba(33,115,70,.2); }
    .btn-primary:hover { background:#1b603b; box-shadow:0 12px 28px rgba(33,115,70,.25); }
    .btn-ghost { background:transparent; color:#1f2937; }
    .btn-ghost:hover { color:#14532d; }
    .dark .btn-ghost { color:#e2e8f0; }
    .btn-google { background:#fff; color:#1f2937; border-color:rgba(148,163,184,.45); box-shadow:0 2px 10px rgba(15,23,42,.05); }
    .btn-google:hover { background:#f8fafc; color:#14532d; border-color:rgba(148,163,184,.6); box-shadow:0 4px 16px rgba(15,23,42,.08); }
    .btn-google[disabled] { box-shadow:none; }
    .dark .btn-google { background:rgba(15,23,42,.7); color:#e2e8f0; border-color:rgba(148,163,184,.35); box-shadow:0 2px 12px rgba(15,23,42,.4); }
    .dark .btn-google:hover { background:rgba(30,41,59,.85); color:#fff; border-color:rgba(148,163,184,.55); }
    .input { width:100%; padding:.55rem .75rem; border-radius:.7rem; border:1px solid #e5e7eb; }
    .dark .input { background:#0f172a; color:#e5e7eb; border-color:#475569; }
    .pill { font-size:.75rem; padding:.2rem .6rem; border-radius:9999px; background:#f1f5f9; color:#475569; }
    .dark .pill { background:#334155; color:#e2e8f0; }
    .hidden-admin { opacity:.6; font-size:.8rem; }
    .feedback { font-size:.85rem; padding:.5rem .75rem; border-radius:.75rem; border:1px solid transparent; }
    .feedback-error { background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .feedback-success { background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .dark .feedback-error { background:rgba(239,68,68,.15); color:#fecaca; border-color:rgba(248,113,113,.4); }
    .dark .feedback-success { background:rgba(34,197,94,.18); color:#bbf7d0; border-color:rgba(134,239,172,.4); }
    .error-text { font-size:.75rem; color:#dc2626; min-height:1rem; }
    .dark .error-text { color:#fca5a5; }
    .hint { font-size:.7rem; color:#64748b; }
    .dark .hint { color:#94a3b8; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .aspect-video { position:relative; padding-top:56.25%; }
    .aspect-video > iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
    .history-tab { padding:.35rem .75rem; border-radius:9999px; border:1px solid rgba(148,163,184,.4); background:#f8fafc; color:#475569; font-size:.75rem; font-weight:600; transition:background-color .2s ease,color .2s ease,border-color .2s ease; }
    .history-tab:hover { background:#e2e8f0; }
    .history-tab-active { background:#217346; color:#fff; border-color:#217346; }
    .dark .history-tab { background:rgba(15,23,42,.9); color:#e2e8f0; border-color:rgba(148,163,184,.35); }
    .dark .history-tab:hover { background:rgba(148,163,184,.2); }
    .dark .history-tab-active { background:#2563eb; border-color:#2563eb; color:#fff; }
    .input-sm { font-size:.85rem; padding:.35rem .6rem; }
    .history-empty { font-size:.85rem; color:#64748b; background:#f8fafc; padding:1rem; border-radius:1rem; border:1px dashed rgba(148,163,184,.4); text-align:center; }
    .dark .history-empty { color:#cbd5f5; background:rgba(15,23,42,.6); border-color:rgba(148,163,184,.25); }
    .level-highlight { transition:transform .3s ease, box-shadow .3s ease; }
    .level-highlight:hover { transform:translateY(-2px); box-shadow:0 18px 32px rgba(249,115,22,.15); }
    .level-label { color:#92400e; letter-spacing:.08em; }
    .dark .level-label { color:#fde68a; }
    .milestone-badge { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .6rem; border-radius:9999px; font-size:.65rem; font-weight:700; background:rgba(251,191,36,.3); color:#78350f; text-transform:uppercase; letter-spacing:.08em; box-shadow:0 2px 8px rgba(249,115,22,.25); }
    .dark .milestone-badge { background:rgba(251,191,36,.2); color:#fde68a; box-shadow:0 2px 8px rgba(251,191,36,.25); }
    .milestone-celebrate { background:linear-gradient(135deg,#fcd34d 0%,#f97316 100%); color:#fff; box-shadow:0 22px 45px rgba(249,115,22,.35); }
    .milestone-celebrate #lvlBox { color:#fff; }
    .milestone-celebrate .level-label { color:#fff; }
    .milestone-celebrate .milestone-badge { background:rgba(255,255,255,.35); color:#7c2d12; box-shadow:0 6px 18px rgba(249,115,22,.35); }
    .dark .milestone-celebrate { background:linear-gradient(135deg,#92400e 0%,#f59e0b 100%); box-shadow:0 22px 45px rgba(234,179,8,.35); }
    .dark .milestone-celebrate .milestone-badge { background:rgba(255,255,255,.85); color:#7c2d12; }
    .milestone-chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .75rem; border-radius:9999px; font-weight:600; font-size:.75rem; background:rgba(226,232,240,.85); color:#1f2937; box-shadow:0 3px 12px rgba(15,23,42,.1); }
    .milestone-chip span { display:inline-flex; align-items:center; }
    .milestone-chip-achieved { background:rgba(134,239,172,.45); color:#047857; box-shadow:0 6px 16px rgba(16,185,129,.3); }
    .milestone-chip-next { background:rgba(253,224,71,.55); color:#92400e; box-shadow:0 6px 16px rgba(251,191,36,.35); }
    .dark .milestone-chip { background:rgba(30,41,59,.65); color:#e2e8f0; box-shadow:0 3px 12px rgba(15,23,42,.25); }
    .dark .milestone-chip-achieved { background:rgba(34,197,94,.3); color:#bbf7d0; }
    .dark .milestone-chip-next { background:rgba(250,204,21,.25); color:#fde68a; }
    #nextLevelBar { transition:width .45s ease; }
    .achievements-scroll { display:flex; gap:1rem; overflow-x:auto; padding-bottom:.5rem; scroll-snap-type:x mandatory; }
    .achievements-scroll::-webkit-scrollbar { height:6px; }
    .achievement-card { min-width:200px; scroll-snap-align:start; border-radius:1rem; padding:1rem; border:1px solid rgba(148,163,184,.25); background:rgba(248,250,252,.95); box-shadow:0 6px 16px rgba(15,23,42,.08); transition:transform .25s ease, box-shadow .25s ease; }
    .achievement-card:hover { transform:translateY(-2px); box-shadow:0 14px 32px rgba(15,23,42,.15); }
    .achievement-card-unlocked { background:linear-gradient(135deg,rgba(34,197,94,.18),rgba(16,185,129,.25)); border-color:rgba(34,197,94,.3); color:#064e3b; }
    .achievement-card-unlocked .achievement-xp { background:rgba(255,255,255,.4); color:#047857; }
    .achievement-card-locked { background:linear-gradient(135deg,rgba(148,163,184,.18),rgba(226,232,240,.45)); color:#1f2937; }
    .achievement-card-ready { border-color:rgba(251,191,36,.65); box-shadow:0 18px 38px rgba(251,191,36,.25); }
    .achievement-card-ready .achievement-progress-bar { background:linear-gradient(135deg,#fbbf24,#f97316); }
    .dark .achievement-card { background:rgba(15,23,42,.85); border-color:rgba(51,65,85,.6); box-shadow:0 8px 24px rgba(15,23,42,.4); color:#e2e8f0; }
    .dark .achievement-card-unlocked { background:linear-gradient(135deg,rgba(16,185,129,.35),rgba(5,150,105,.45)); border-color:rgba(16,185,129,.5); color:#d1fae5; }
    .dark .achievement-card-unlocked .achievement-xp { background:rgba(15,23,42,.35); color:#6ee7b7; }
    .dark .achievement-card-locked { background:linear-gradient(135deg,rgba(30,41,59,.7),rgba(51,65,85,.7)); color:#e2e8f0; }
    .achievement-icon { font-size:1.75rem; line-height:1; }
    .achievement-xp { font-size:.7rem; font-weight:700; padding:.25rem .6rem; border-radius:9999px; background:rgba(255,255,255,.65); color:#1e293b; text-transform:uppercase; letter-spacing:.08em; }
    .achievements-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .achievement-progress-track { height:6px; border-radius:9999px; background:rgba(148,163,184,.35); overflow:hidden; }
    .achievement-progress-bar { height:100%; border-radius:9999px; background:linear-gradient(135deg,#38bdf8,#2563eb); transition:width .35s ease; }
    .dark .achievement-progress-track { background:rgba(71,85,105,.55); }
    .dark .achievement-progress-bar { background:linear-gradient(135deg,#38bdf8,#1d4ed8); }
    .student-nav { display:flex; flex-wrap:wrap; gap:.5rem; }
    .student-nav-btn { display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .95rem; border-radius:9999px; border:1px solid rgba(148,163,184,.45); background:rgba(248,250,252,.75); color:#1e293b; font-weight:600; font-size:.85rem; transition:background-color .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease; }
    .student-nav-btn:hover { background:#e2e8f0; }
    .student-nav-btn-active { background:#217346; border-color:#217346; color:#fff; box-shadow:0 10px 24px rgba(33,115,70,.25); }
    .dark .student-nav-btn { background:rgba(15,23,42,.75); border-color:rgba(71,85,105,.6); color:#e2e8f0; }
    .dark .student-nav-btn:hover { background:rgba(51,65,85,.65); }
    .dark .student-nav-btn-active { background:#2563eb; border-color:#2563eb; box-shadow:0 12px 26px rgba(37,99,235,.35); }
    .mission-list { list-style:none; margin:0; padding:0; display:grid; gap:.75rem; }
    .mission-item { display:flex; gap:.85rem; align-items:flex-start; border:1px solid rgba(148,163,184,.35); border-radius:1rem; padding:.75rem .95rem; background:#fff; box-shadow:0 4px 12px rgba(15,23,42,.04); transition:border-color .2s ease, box-shadow .2s ease, background-color .2s ease; }
    .mission-item:hover { box-shadow:0 10px 24px rgba(15,23,42,.08); }
    .mission-item-complete { border-color:rgba(34,197,94,.45); background:rgba(236,253,245,.8); box-shadow:0 14px 30px rgba(16,185,129,.25); }
    .mission-icon { flex:none; display:inline-flex; align-items:center; justify-content:center; width:2.5rem; height:2.5rem; border-radius:9999px; background:rgba(148,163,184,.2); font-size:1.25rem; color:#0f172a; box-shadow:inset 0 0 0 1px rgba(148,163,184,.3); }
    .mission-item-complete .mission-icon { background:rgba(16,185,129,.15); color:#047857; box-shadow:inset 0 0 0 1px rgba(16,185,129,.3); }
    .mission-content { flex:1; display:flex; flex-direction:column; gap:.35rem; }
    .mission-title { font-weight:600; font-size:.95rem; color:#0f172a; }
    .mission-description { font-size:.85rem; color:#475569; line-height:1.4; }
    .mission-status { font-size:.75rem; font-weight:600; color:#0f172a; display:inline-flex; align-items:center; gap:.35rem; text-transform:uppercase; letter-spacing:.04em; }
    .mission-item-complete .mission-status { color:#047857; }
    .mission-action-btn { align-self:flex-start; font-size:.8rem; padding:.35rem .75rem; border-radius:.6rem; }
    .dark .mission-item { background:rgba(15,23,42,.75); border-color:rgba(71,85,105,.5); box-shadow:0 4px 16px rgba(15,23,42,.35); }
    .dark .mission-item:hover { box-shadow:0 12px 28px rgba(15,23,42,.45); }
    .dark .mission-item-complete { background:rgba(22,163,74,.22); border-color:rgba(34,197,94,.45); box-shadow:0 18px 34px rgba(34,197,94,.3); }
    .dark .mission-icon { background:rgba(30,41,59,.85); color:#e2e8f0; box-shadow:inset 0 0 0 1px rgba(71,85,105,.6); }
    .dark .mission-item-complete .mission-icon { background:rgba(34,197,94,.2); color:#bbf7d0; box-shadow:inset 0 0 0 1px rgba(34,197,94,.45); }
    .dark .mission-title { color:#e2e8f0; }
    .dark .mission-description { color:#cbd5f5; }
    .dark .mission-status { color:#cbd5f5; }
    .dark .mission-item-complete .mission-status { color:#6ee7b7; }
    .app-nav { display:flex; flex-wrap:wrap; gap:.5rem 1.5rem; font-size:.9rem; font-weight:600; }
    .app-nav-link { position:relative; padding:.35rem 0; color:#1f2937; transition:color .2s ease; }
    .app-nav-link::after { content:''; position:absolute; left:0; bottom:-.35rem; width:100%; height:3px; border-radius:999px; background:transparent; transition:background-color .2s ease, transform .2s ease; transform:scaleX(0); transform-origin:left; }
    .app-nav-link:hover { color:#14532d; }
    .app-nav-link-active { color:#14532d; }
    .app-nav-link-active::after { background:#217346; transform:scaleX(1); }
    .app-nav-link[aria-disabled="true"] { color:#94a3b8; cursor:not-allowed; }
    .app-nav-link[aria-disabled="true"]::after { background:transparent; }
    .app-nav-link[aria-disabled="true"]:hover { color:#94a3b8; }
    .attachment-item { display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.65rem .9rem; border-radius:1rem; background:#f8fafc; border:1px solid rgba(148,163,184,.35); }
    .dark .attachment-item { background:rgba(15,23,42,.65); border-color:rgba(71,85,105,.55); }
    .attachment-info { display:flex; align-items:center; gap:.75rem; min-width:0; }
    .attachment-icon { width:2.25rem; height:2.25rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; background:rgba(33,115,70,.12); color:#217346; font-size:1.1rem; }
    .dark .attachment-icon { background:rgba(56,189,248,.15); color:#38bdf8; }
    .attachment-text { display:flex; flex-direction:column; gap:.15rem; min-width:0; }
    .attachment-name { font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .dark .attachment-name { color:#e2e8f0; }
    .attachment-meta { font-size:.75rem; color:#64748b; }
    .dark .attachment-meta { color:#cbd5f5; }
    .attachment-remove { color:#dc2626; font-size:.75rem; font-weight:600; }
    .attachment-remove:hover { color:#b91c1c; }
    .podium-card { position:relative; border-radius:1.5rem; padding:1.5rem 1.25rem; background:linear-gradient(135deg,rgba(148,163,184,.1),rgba(226,232,240,.45)); text-align:center; box-shadow:0 14px 35px rgba(15,23,42,.12); }
    .podium-card-first { background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#78350f; box-shadow:0 24px 45px rgba(251,191,36,.35); }
    .podium-card-second { background:linear-gradient(135deg,#e2e8f0,#cbd5f5); color:#1f2937; }
    .podium-card-third { background:linear-gradient(135deg,#fed7aa,#fdba74); color:#7c2d12; }
    .dark .podium-card { background:linear-gradient(135deg,rgba(30,41,59,.75),rgba(51,65,85,.75)); box-shadow:0 14px 35px rgba(15,23,42,.45); }
    .dark .podium-card-first { background:linear-gradient(135deg,#f59e0b,#b45309); color:#fff; }
    .dark .podium-card-second { background:linear-gradient(135deg,#475569,#334155); color:#e2e8f0; }
    .dark .podium-card-third { background:linear-gradient(135deg,#fbbf24,#f97316); color:#fff; }
    .podium-rank { font-size:.85rem; letter-spacing:.08em; text-transform:uppercase; font-weight:700; opacity:.85; }
    .podium-name { font-size:1.1rem; font-weight:700; margin-top:.35rem; }
    .podium-score { font-size:.85rem; color:rgba(15,23,42,.7); }
    .dark .podium-score { color:rgba(226,232,240,.8); }
    .leaderboard-row { display:grid; grid-template-columns:minmax(0,1fr) auto; gap:.75rem; padding:.65rem 1rem; }
    .leaderboard-row:nth-child(even) { background:rgba(148,163,184,.15); }
    .dark .leaderboard-row:nth-child(even) { background:rgba(30,41,59,.55); }
    .leaderboard-name { font-weight:600; color:#1f2937; }
    .dark .leaderboard-name { color:#e2e8f0; }
    .leaderboard-meta { font-size:.75rem; color:#64748b; }
    .dark .leaderboard-meta { color:#cbd5f5; }
    .privacy-chip { display:inline-flex; align-items:center; gap:.3rem; padding:.25rem .65rem; border-radius:9999px; font-size:.7rem; font-weight:600; background:rgba(59,130,246,.15); color:#1d4ed8; }
    .privacy-chip-private { background:rgba(234,179,8,.18); color:#92400e; }
    .dark .privacy-chip { background:rgba(37,99,235,.25); color:#bfdbfe; }
    .dark .privacy-chip-private { background:rgba(251,191,36,.2); color:#fde68a; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">

  <div id="toastContainer" class="fixed top-4 inset-x-4 sm:inset-x-6 lg:inset-x-auto lg:right-12 lg:left-auto z-50 flex w-full max-w-sm flex-col gap-3 mx-auto lg:mx-0"></div>

<header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-200 dark:border-slate-700">
  <div class="w-full px-6 lg:px-12 py-4 space-y-4">
    <div class="flex flex-col gap-3 md:flex-row md:items-center">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-primary/70">Trilha intensiva de 24 encontros</p>
        <h1 class="text-2xl font-semibold text-primary">Excel do Zero ao Avançado</h1>
      </div>
      <div class="md:ml-auto flex items-center gap-2">
        <span id="userInfo" class="pill">Visitante</span>
        <button id="btnLogout" class="btn btn-ghost hidden">Sair</button>
      </div>
    </div>
    <nav aria-label="Navegação principal">
      <ul id="primaryNav" class="app-nav">
        <li><a href="/inicio" class="app-nav-link" data-app-route="inicio" data-requires-auth="true">Início</a></li>
        <li><a href="/painel" class="app-nav-link" data-app-route="painel" data-requires-auth="true">Painel</a></li>
        <li><a href="/conquistas" class="app-nav-link" data-app-route="conquistas">Conquistas</a></li>
        <li><a href="/aulas" class="app-nav-link" data-app-route="aulas">Aulas &amp; Atividades</a></li>
        <li><a href="/admin" class="app-nav-link" data-app-route="admin" data-requires-auth="true" data-requires-admin="true">Admin</a></li>
        <li><a href="/sobre" class="app-nav-link" data-app-route="sobre">Sobre</a></li>
      </ul>
    </nav>
    <nav id="headerBreadcrumbs" class="hidden text-xs sm:text-sm text-slate-500 dark:text-slate-400" aria-label="Breadcrumb">
      <ol class="flex items-center gap-2">
        <li class="flex items-center gap-2">
          <span class="opacity-75">Início</span>
          <span aria-hidden="true" class="text-slate-300">/</span>
        </li>
        <li id="breadcrumbDashboard" class="flex items-center gap-2 font-semibold text-slate-700 dark:text-slate-100">
          Dashboard
        </li>
        <li id="breadcrumbSubPage" class="hidden items-center gap-2 font-semibold text-slate-700 dark:text-slate-100">
          <span aria-hidden="true" class="text-slate-300">/</span>
          <span id="breadcrumbSubPageLabel"></span>
        </li>
        <li id="breadcrumbAdmin" class="hidden flex items-center gap-2 font-semibold text-slate-700 dark:text-slate-100">
          <span aria-hidden="true" class="text-slate-300">/</span>
          Administração
        </li>
      </ol>
    </nav>
  </div>
</header>

<main class="px-6 lg:px-12 py-6 space-y-8">
  <section data-app-page="inicio" id="inicioPage" class="space-y-8">
  <!-- AUTH -->
  <section id="authSection" class="space-y-6 max-w-3xl mx-auto">
    <div class="card" id="loginCard">
      <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
        <div>
          <p class="pill">Acesso seguro</p>
          <h2 class="text-2xl font-semibold">Bem-vindo de volta</h2>
          <p class="text-sm text-slate-500">Entre com sua conta para acompanhar o painel gamificado.</p>
        </div>
        <button type="button" id="toggleSignup" class="btn btn-ghost text-sm">Ainda não tenho cadastro</button>
      </div>
      <div id="loginMsg" class="feedback hidden"></div>
      <button type="button" id="btnGoogleAuth" class="btn btn-google w-full justify-center">Entrar com Google corporativo</button>
      <p class="text-xs text-slate-500 text-center mt-2">Utilize o mesmo e-mail corporativo que já acessa o Drive compartilhado.</p>
      <form id="loginForm" class="grid gap-4 mt-4">
        <div class="grid gap-2">
          <label for="lEmail" class="text-xs font-semibold uppercase tracking-wide text-slate-500">E-mail</label>
          <input id="lEmail" class="input" placeholder="nome@empresa.com" autocomplete="email" />
        </div>
        <div class="grid gap-2">
          <label for="lPass" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Senha</label>
          <input id="lPass" type="password" class="input" placeholder="Digite sua senha" autocomplete="current-password" />
        </div>
        <div class="flex flex-wrap items-center justify-between gap-2 text-sm text-slate-600">
          <label class="inline-flex items-center gap-2">
            <input id="rememberMe" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-primary focus:ring-primary" />
            <span>Lembrar de mim neste navegador</span>
          </label>
          <span class="text-xs text-slate-400">Sessão expira após 7 dias de inatividade.</span>
        </div>
        <button id="btnLogin" type="submit" class="btn btn-primary">Entrar</button>
      </form>
    </div>

    <div class="card hidden" id="signupCard">
      <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
        <div>
          <p class="pill">Primeiro acesso</p>
          <h2 class="text-2xl font-semibold">Crie sua conta gratuita</h2>
          <p class="text-sm text-slate-500">Preencha os dados abaixo e confirme o cadastro pelo seu e-mail.</p>
        </div>
        <button type="button" id="toggleLogin" class="btn btn-ghost text-sm">Já tenho conta</button>
      </div>
      <div id="signupMsg" class="feedback hidden"></div>
      <div class="grid gap-3">
        <div class="space-y-1">
          <label for="rName" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Nome completo</label>
          <input id="rName" class="input" placeholder="Nome completo" autocomplete="name" />
          <p id="rNameError" class="error-text"></p>
        </div>
        <div class="space-y-1">
          <label for="rEmail" class="text-xs font-semibold uppercase tracking-wide text-slate-500">E-mail corporativo</label>
          <input id="rEmail" class="input" placeholder="nome@empresa.com" title="Utilize um endereço válido (ex.: nome@empresa.com)." autocomplete="email" />
          <p class="hint">Utilize um endereço válido (ex.: nome@empresa.com).</p>
          <p id="rEmailError" class="error-text"></p>
        </div>
        <div class="space-y-1">
          <label for="rPass" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Senha</label>
          <input id="rPass" type="password" class="input" placeholder="Crie uma senha forte" title="Mínimo de 8 caracteres com letras maiúsculas, minúsculas, números e símbolos." autocomplete="new-password" />
          <p class="hint">Mínimo de 8 caracteres com letras maiúsculas, minúsculas, números e símbolos.</p>
          <p id="rPassError" class="error-text"></p>
        </div>
        <div class="hidden-admin space-y-1">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Código de segurança (somente para Administrador)</label>
          <input id="rAdminCode" class="input" placeholder="(opcional)" />
          <p id="rAdminCodeError" class="error-text"></p>
        </div>
        <button id="btnSignup" class="btn btn-primary" disabled>Criar conta</button>
        <p class="text-xs text-slate-500">Obs.: Administrador só é criado com código válido.</p>
      </div>
    </div>

    <div class="card hidden" id="confirmCard">
      <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
        <div>
          <p class="pill">Confirmação necessária</p>
          <h2 class="text-2xl font-semibold">Verifique seu e-mail</h2>
          <p class="text-sm text-slate-500">Enviamos um código de 6 dígitos para ativar o acesso.</p>
        </div>
        <button type="button" id="confirmBackToLogin" class="btn btn-ghost text-sm">Trocar conta</button>
      </div>
      <div id="confirmMsg" class="feedback hidden"></div>
      <form id="confirmForm" class="grid gap-4 mt-2">
        <div class="grid gap-2">
          <label for="confirmationEmail" class="text-xs font-semibold uppercase tracking-wide text-slate-500">E-mail</label>
          <input id="confirmationEmail" class="input" readonly />
        </div>
        <div class="grid gap-2">
          <label for="confirmationCode" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Código de confirmação</label>
          <input id="confirmationCode" class="input tracking-[0.35em] text-center text-lg" maxlength="6" placeholder="000000" inputmode="numeric" autocomplete="one-time-code" />
        </div>
        <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
          <button type="button" id="btnResendConfirmation" class="btn btn-ghost text-sm">Reenviar código</button>
          <span id="confirmationCountdown" class="text-xs text-slate-400"></span>
        </div>
        <button id="btnConfirmSignup" type="submit" class="btn btn-primary">Confirmar acesso</button>
      </form>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashSection" class="hidden space-y-6">
    <div id="studentHeroCard" class="card card-transparent space-y-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="space-y-3 flex-1">
          <div class="flex flex-wrap items-center gap-3">
            <span class="pill">Jornada do aluno</span>
            <div class="student-nav" role="tablist" aria-label="Menu da jornada">
              <button type="button" class="student-nav-btn student-nav-btn-active" data-nav-target="home">Início</button>
              <button type="button" class="student-nav-btn" data-nav-target="next-lesson">Próxima aula</button>
              <button type="button" class="student-nav-btn" data-nav-target="achievements-catalog">Conquistas</button>
            </div>
          </div>
          <h2 class="text-2xl font-semibold" id="studentHeroGreeting">Bem-vindo!</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed" id="studentNarrative">
            Faça login para acompanhar seu progresso diário.
          </p>
          <div class="flex flex-wrap items-center gap-2 text-xs" id="studentHeroStats"></div>
        </div>
        <div class="w-full max-w-sm lg:max-w-xs bg-primary/10 border border-primary/20 rounded-2xl p-4 text-primary shadow-sm">
          <p class="text-xs uppercase tracking-wide font-semibold opacity-80">Próxima parada</p>
          <p class="text-lg font-bold mt-1" id="nextLessonPreview">Faça login para liberar sua próxima aula.</p>
          <p class="text-xs mt-2 opacity-80" id="nextLessonProgressHint"></p>
        </div>
      </div>
      <div class="space-y-4" data-home-only>
        <div>
          <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-200">Continue avançando</h3>
          <p class="text-sm text-slate-500 dark:text-slate-300" id="studentHeroGuidance">
            Mantenha o ritmo com pequenas ações diárias e abra o próximo módulo quando estiver pronto.
          </p>
          <div class="mt-4 space-y-2 sm:flex sm:items-center sm:gap-3 sm:space-y-0">
            <button type="button" class="btn btn-primary sm:w-auto w-full" data-nav-target="next-lesson">Ir para a próxima aula</button>
            <button type="button" class="btn btn-ghost sm:w-auto w-full" data-nav-target="achievements-catalog">Ver todas as conquistas</button>
          </div>
        </div>
      </div>
    </div>

    <div id="studentHomeWrap" class="grid gap-6 lg:grid-cols-12 auto-rows-max" data-home-only>
      <div class="lg:col-span-8 space-y-6">
        <div class="card card-flat">
          <h3 class="text-lg font-semibold mb-2">Sua evolução</h3>
          <div class="grid sm:grid-cols-3 gap-3">
            <div class="rounded-2xl p-4 bg-primary/10">
              <div class="text-xs uppercase tracking-wide text-primary/70">XP total</div>
            <div id="xpBox" class="text-3xl font-bold text-primary">0</div>
          </div>
          <div class="rounded-2xl p-4 bg-emerald-100">
            <div class="text-xs uppercase tracking-wide text-emerald-700/80">Módulos concluídos</div>
            <div id="doneBox" class="text-3xl font-bold text-emerald-900">0</div>
          </div>
          <div id="levelCard" class="rounded-2xl p-4 bg-amber-100 level-highlight relative overflow-hidden">
            <div class="flex items-start justify-between gap-2">
              <div id="levelLabel" class="level-label text-xs uppercase tracking-wide font-semibold">Nível</div>
              <span id="levelBadge" class="milestone-badge hidden">🏆 Marco!</span>
            </div>
            <div id="lvlBox" class="text-3xl font-bold text-amber-900 mt-1">1</div>
          </div>
        </div>
        <div class="mt-4 space-y-4">
          <div id="nextLevelCard" class="rounded-2xl border border-amber-200/70 bg-amber-50/80 px-4 py-4 dark:border-amber-500/40 dark:bg-amber-500/10 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
              <div class="flex items-center gap-2 font-semibold text-amber-700 dark:text-amber-200">
                <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-amber-200/80 text-lg shadow-sm dark:bg-amber-500/30">⚡</span>
                <span id="nextLevelText">Faltam 0 XP para o nível 2</span>
              </div>
              <span id="nextLevelPct" class="text-xs font-semibold text-amber-700/80 dark:text-amber-200/80">0% do nível atual</span>
            </div>
            <div class="h-2.5 rounded-full bg-amber-200/70 dark:bg-amber-500/30 overflow-hidden">
              <div id="nextLevelBar" class="h-full rounded-full bg-amber-500 dark:bg-amber-400" style="width:0%"></div>
            </div>
            <div id="milestoneWrap" class="flex flex-wrap gap-2 text-xs"></div>
          </div>
          <div>
            <div class="flex items-center justify-between text-sm mb-1">
              <span>Progresso nos 24 módulos</span><span id="pctBox">0%</span>
            </div>
            <div class="h-3 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
              <div id="barBox" class="h-3 bg-primary dark:bg-blue-500" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="achievementsCard" class="card card-flat">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
          <h3 class="text-lg font-semibold">Conquistas</h3>
          <span id="achievementsSummary" class="text-xs text-slate-500 dark:text-slate-400"></span>
        </div>
        <div id="achievementsLoading" class="text-sm text-slate-500 dark:text-slate-300">Carregando conquistas...</div>
        <div id="achievementsError" class="text-sm text-rose-600 dark:text-rose-300 hidden"></div>
        <div id="achievementsContent" class="space-y-5 hidden">
          <div>
            <div class="flex items-center justify-between text-sm mb-2">
              <span class="font-semibold">Desbloqueadas</span>
              <span class="text-xs text-slate-500 dark:text-slate-400">Celebre suas conquistas recentes</span>
            </div>
            <div id="achievementsUnlocked" class="achievements-scroll"></div>
            <p id="achievementsUnlockedEmpty" class="text-xs text-slate-500 dark:text-slate-300">Faça login para desbloquear suas primeiras conquistas.</p>
          </div>
          <div>
            <div class="flex items-center justify-between text-sm mb-2">
              <span class="font-semibold">Próximas metas</span>
              <span class="text-xs text-slate-500 dark:text-slate-400">Acompanhe o progresso e continue evoluindo</span>
            </div>
            <div id="achievementsUpcoming" class="achievements-grid"></div>
            <p id="achievementsUpcomingEmpty" class="text-xs text-slate-500 dark:text-slate-300">Participe de check-ins e atividades para liberar novas medalhas.</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
          <h3 class="text-lg font-semibold">Central de materiais</h3>
          <span class="pill" id="embedAdminTag" data-admin-only aria-hidden="true">Modo administrador</span>
        </div>
        <div id="embedAdminControls" class="grid gap-3 mb-4 hidden" data-admin-only aria-hidden="true">
          <div class="grid gap-2">
            <input id="excelLink" class="input" placeholder="Cole link compartilhado do Excel (OneDrive/SharePoint/Drive)"/>
            <input id="pptLink" class="input" placeholder="Cole link compartilhado do PowerPoint"/>
          </div>
          <div class="grid md:grid-cols-2 gap-3">
            <div class="space-y-2">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400" for="resourcesInput">Recursos recomendados</label>
              <textarea id="resourcesInput" class="input min-h-[120px] resize-y" placeholder="Liste cada recurso em uma linha"></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400" for="eventsInput">Próximos eventos</label>
              <textarea id="eventsInput" class="input min-h-[120px] resize-y" placeholder="Adicione eventos futuros, um por linha"></textarea>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 justify-end">
            <button id="btnSaveEmbeds" class="btn btn-primary">Salvar</button>
            <button id="btnLoadEmbeds" class="btn btn-ghost">Atualizar</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <div class="text-xs mb-1">Excel</div>
            <div class="aspect-video bg-slate-200 rounded">
              <iframe id="excelFrame"></iframe>
            </div>
          </div>
          <div>
            <div class="text-xs mb-1">PowerPoint</div>
            <div class="aspect-video bg-slate-200 rounded">
              <iframe id="pptFrame"></iframe>
            </div>
          </div>
        </div>
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold">Recursos recomendados</h4>
            </div>
            <p id="resourcesEmpty" class="text-xs text-slate-500 hidden">Nenhum recurso cadastrado ainda.</p>
            <ul id="resourcesList" class="space-y-2 text-sm list-none p-0 m-0"></ul>
          </div>
          <div>
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold">Próximos eventos</h4>
            </div>
            <p id="eventsEmpty" class="text-xs text-slate-500 hidden">Nenhum evento informado no momento.</p>
            <ul id="eventsList" class="space-y-2 text-sm list-none p-0 m-0"></ul>
          </div>
        </div>
      </div>

    </div>

      <div class="lg:col-span-4 space-y-6">
        <div class="card" data-home-only>
          <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
            <div>
              <h3 class="text-lg font-semibold">Missões do dia</h3>
              <p class="text-sm text-slate-500 dark:text-slate-300">Priorize ações rápidas para manter o ritmo da temporada.</p>
            </div>
            <span class="pill">Streak máx. 24</span>
          </div>
          <ul id="dailyMissionList" class="mission-list"></ul>
        </div>

        <div class="card">
          <h3 class="text-lg font-semibold mb-2">Check-in diário</h3>
          <p class="text-sm text-slate-500 mb-2">Ganhe +XP 1x ao dia e avance sua sequência rumo ao bônus de 300 XP.</p>
          <button id="btnCheckin" class="btn btn-primary">Confirmar presença</button>
          <div id="checkinStreakInfo" class="mt-3 text-xs text-slate-500 dark:text-slate-300 leading-relaxed"></div>
          <div id="checkinMsg" class="text-xs text-emerald-600 mt-2"></div>
        </div>

      <div class="card" id="historyCard">
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <h3 class="text-lg font-semibold">Histórico de XP</h3>
          <div id="historyStreakWrap" class="flex flex-wrap items-center gap-2 text-xs hidden">
            <span id="historyStreakCurrent" class="pill"></span>
            <span id="historyStreakBest" class="pill"></span>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <div class="inline-flex gap-2 bg-slate-100 dark:bg-slate-800/60 p-1 rounded-full">
            <button type="button" class="history-tab history-tab-active" data-history-tab="checkins">Check-ins</button>
            <button type="button" class="history-tab" data-history-tab="activities">Atividades</button>
          </div>
          <div class="ml-auto flex flex-wrap items-center gap-2 text-xs">
            <label for="historyPeriodFilter" class="uppercase tracking-wide text-slate-500 dark:text-slate-400">Período</label>
            <select id="historyPeriodFilter" class="input input-sm">
              <option value="7">7 dias</option>
              <option value="30" selected>30 dias</option>
              <option value="90">90 dias</option>
              <option value="365">1 ano</option>
              <option value="all">Todo o período</option>
            </select>
          </div>
          <div id="historyModuleFilterWrap" class="flex flex-wrap items-center gap-2 text-xs hidden">
            <label for="historyModuleFilter" class="uppercase tracking-wide text-slate-500 dark:text-slate-400">Módulo</label>
            <select id="historyModuleFilter" class="input input-sm">
              <option value="all" selected>Todos os módulos</option>
            </select>
          </div>
        </div>
        <div id="historyList" class="grid gap-2 text-sm"></div>
      </div>

      <div class="card card-flat">
        <h3 class="text-lg font-semibold mb-2">Pronto para praticar?</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300">
          Acesse o quiz oficial do módulo e registre seu progresso direto na atividade real.
        </p>
        <button type="button" class="btn btn-primary mt-2" data-nav-target="next-lesson">
          Ir para a próxima atividade
        </button>
      </div>

      <div class="card">
        <h3 class="text-lg font-semibold mb-2">Ranking</h3>
        <div id="rankWrap" class="space-y-2 text-sm"></div>
      </div>

      <!-- Admin -->
      <div id="adminPanel" class="card hidden">
        <h3 class="text-lg font-semibold mb-2">Painel do Administrador</h3>
        <p class="text-sm text-slate-500 mb-2">Ranking consolidado (apenas alunos). Use para premiações.</p>
        <div id="adminRank" class="space-y-2 text-sm"></div>
      </div>
      </div>
    </div>

    <section id="studentSubPageSection" class="space-y-4 hidden">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="pill">Explorar</p>
          <h2 class="text-xl font-semibold" id="studentSubPageTitle">Conteúdo complementar</h2>
          <p class="text-sm text-slate-500 dark:text-slate-300" id="studentSubPageSubtitle">
            Escolha uma opção para continuar sua jornada.
          </p>
        </div>
        <button type="button" class="btn btn-ghost" data-nav-target="home">Voltar ao início</button>
      </div>
      <div id="studentSubPageLoading" class="card card-flat text-sm text-slate-500 dark:text-slate-300 hidden">
        Carregando conteúdo...
      </div>
      <div id="studentSubPageError" class="feedback feedback-error hidden"></div>
      <div id="studentSubPageContainer" class="space-y-4"></div>
    </section>
  </section>
  </section>

  <section data-app-page="sobre" id="sobrePage" class="hidden space-y-6 max-w-6xl mx-auto">
    <div class="card card-transparent space-y-4">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-2 max-w-3xl">
          <p class="pill">Sobre o programa</p>
          <h2 class="text-2xl font-semibold text-primary">24 encontros guiados para destravar o Excel no dia a dia</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
            Da alfabetização digital às automações com Power Query e Dashboards interativos, a jornada é dividida em quatro grandes blocos (A–D) com foco prático em empresas reais.
          </p>
        </div>
        <div class="text-sm text-slate-600 dark:text-slate-300 max-w-xs">
          <p>Os encontros combinam demonstrações ao vivo, desafios guiados e missões rápidas para que cada aluno aplique imediatamente o que aprendeu.</p>
        </div>
      </div>
      <div id="aboutHighlights" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4"></div>
    </div>

    <div class="card space-y-4">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-semibold">Blocos A–D</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">Cada bloco agrupa 6 encontros (90 minutos) com entregáveis claros e checkpoints de XP.</p>
        </div>
        <button type="button" class="btn btn-ghost" data-app-route="aulas">Ver trilhas completas</button>
      </div>
      <div id="aboutModuleGrid" class="grid gap-4 md:grid-cols-2"></div>
    </div>
  </section>

  <section data-app-page="aulas" id="aulasPage" class="hidden space-y-6 max-w-6xl mx-auto">
    <div class="card card-transparent space-y-3">
      <p class="pill">Trilhas de aprendizagem</p>
      <h2 class="text-2xl font-semibold text-primary">Do básico ao avançado com checkpoints de XP</h2>
      <p class="text-sm text-slate-600 dark:text-slate-300">
        Revise as aulas, desafios e quizzes previstos em cada módulo. Os desafios práticos garantem entre 25 e 60 XP; os quizzes, até 100 XP com bônus de velocidade.
      </p>
    </div>
    <div id="learningTracksContainer" class="space-y-6"></div>
    <div class="card space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <h3 class="text-xl font-semibold">Desafios e quizzes em destaque</h3>
        <span class="pill">XP em jogo</span>
      </div>
      <div id="learningAssessments" class="grid gap-4 lg:grid-cols-2"></div>
    </div>
  </section>

  <section data-app-page="painel" id="painelPage" class="hidden space-y-6 max-w-6xl mx-auto">
    <div class="grid gap-6 xl:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
      <div class="space-y-6">
        <div class="card card-transparent space-y-3">
          <p class="pill">Comunidade</p>
          <h2 class="text-2xl font-semibold text-primary">Central da turma e mural colaborativo</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300">Compartilhe materiais, resoluções e conquistas. Escolha entre publicar para toda a turma ou enviar apenas para destinatários específicos.</p>
        </div>

        <div class="card" id="communityComposerCard">
          <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
            <div>
              <h3 class="text-lg font-semibold">Escreva algo para a turma</h3>
              <p class="text-sm text-slate-500">Mensagens úteis e soluções marcadas rendem XP extra.</p>
            </div>
            <span id="communityLimitBadge" class="pill">240 caracteres</span>
          </div>
          <div id="communityFormWrap" class="space-y-4 hidden">
            <textarea id="communityMessage" class="input min-h-[120px] resize-y" maxlength="240" placeholder="Compartilhe uma novidade, dúvida ou insight com a turma..."></textarea>
            <div class="flex flex-wrap items-center justify-between gap-3 text-xs text-slate-500">
              <span id="communityFormFeedback" class="text-rose-500 hidden" aria-live="polite"></span>
              <span id="communityCounter">0/240</span>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label for="communityPrivacySelect" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Visibilidade</label>
                <select id="communityPrivacySelect" class="input">
                  <option value="public">Público — toda a turma visualiza</option>
                  <option value="private">Privado — escolher destinatários</option>
                </select>
              </div>
              <div id="communityTargetsWrap" class="space-y-1 hidden">
                <label for="communityTargets" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Enviar para</label>
                <select id="communityTargets" class="input min-h-[120px]" multiple></select>
                <p class="hint">Selecione um ou mais colegas ou instrutores.</p>
              </div>
            </div>
            <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/50 p-4 space-y-3">
              <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
                <div class="font-semibold text-slate-600 dark:text-slate-200">Anexos</div>
                <label class="btn btn-ghost text-sm cursor-pointer">
                  <input id="communityAttachmentInput" type="file" class="hidden" multiple />
                  Adicionar arquivo
                </label>
              </div>
              <p class="text-xs text-slate-500">Suporte a imagens, PDFs e planilhas (máx. 10 MB cada). Os arquivos ficam salvos no drive compartilhado da turma.</p>
              <ul id="communityAttachmentList" class="space-y-2 text-sm"></ul>
            </div>
            <div class="flex justify-end">
              <button id="btnCommunityPublish" class="btn btn-primary">Publicar no mural</button>
            </div>
          </div>
          <p id="communityGuestNotice" class="text-sm text-slate-500 hidden">Entre com sua conta para publicar atualizações e anexos.</p>
        </div>

        <div class="card" id="communityWallCard">
          <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
            <div>
              <h3 class="text-lg font-semibold">Linha do tempo da turma</h3>
              <p class="text-sm text-slate-500">Publicações públicas e privadas enviadas para você aparecem aqui.</p>
            </div>
          </div>
          <div id="communityWallList" class="grid gap-4 text-sm"></div>
          <p id="communityWallEmpty" class="history-empty hidden">Ainda não há recados por aqui. Seja o primeiro a compartilhar!</p>
        </div>
      </div>

      <div class="space-y-6">
        <div class="card card-transparent space-y-3">
          <h3 class="text-lg font-semibold">Boas práticas da comunidade</h3>
          <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300 list-disc pl-5">
            <li>Marque colegas quando compartilhar resoluções privadas para que recebam o acesso.</li>
            <li>Use anexos para enviar planilhas, roteiros ou prints relevantes.</li>
            <li>Posts destacados podem render XP bônus definidos pela coordenação.</li>
          </ul>
        </div>
        <div class="card space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h3 class="text-lg font-semibold">Enquetes ativas</h3>
              <p class="text-sm text-slate-600 dark:text-slate-300">Vote e acompanhe o resultado em tempo real. Cada voto registrado rende +3 XP.</p>
            </div>
            <span class="pill">Atualiza em tempo real</span>
          </div>
          <div id="panelPollList" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </section>

  <section data-app-page="conquistas" id="conquistasPage" class="hidden space-y-6 max-w-6xl mx-auto">
    <div class="grid gap-6 xl:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
      <div class="space-y-6">
        <div class="card card-transparent space-y-3">
          <p class="pill">Vitrine de badges</p>
          <h2 class="text-2xl font-semibold text-primary">Celebre cada passo rumo ao nível Mestre</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300">Acompanhe o total de medalhas desbloqueadas, descubra o próximo troféu e monitore o progresso do seu streak.</p>
          <div class="grid gap-3 sm:grid-cols-3" id="achievementsHeroStats"></div>
        </div>

        <div class="card" data-achievements-page data-subpage="achievements-catalog">
          <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
            <div>
              <h3 class="text-xl font-semibold">Catálogo completo de conquistas</h3>
              <p class="text-sm text-slate-600 dark:text-slate-300">Todas as medalhas disponíveis, critérios e recompensas.</p>
            </div>
            <span class="pill" data-role="achievement-summary">0/0 desbloqueadas</span>
          </div>
          <div data-role="achievement-loading" class="text-sm text-slate-500 dark:text-slate-300">Carregando conquistas...</div>
          <div data-role="achievement-error" class="text-sm text-rose-600 dark:text-rose-300 hidden"></div>
          <p data-role="achievement-empty" class="history-empty hidden">Faça login para acompanhar suas conquistas.</p>
          <div data-role="achievement-list" class="achievements-grid"></div>
        </div>
      </div>

      <div class="space-y-6">
        <div class="card card-transparent space-y-4" id="achievementsAdminPanel">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="pill">Hall da fama</p>
              <h3 class="text-xl font-semibold">Ranking da temporada</h3>
              <p class="text-sm text-slate-500">Visão exclusiva para administradores com os alunos mais engajados.</p>
            </div>
            <span class="pill" id="achievementsRankingBadge">Atualização diária</span>
          </div>
          <div id="achievementsAdminNotice" class="text-sm text-slate-500 dark:text-slate-300">Faça login como administrador para acompanhar o ranking da turma.</div>
          <div id="achievementsLeaderboard" class="space-y-5 hidden">
            <div id="achievementsPodium" class="grid gap-3 md:grid-cols-3"></div>
            <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 shadow-sm">
              <div class="flex flex-wrap items-center justify-between gap-3 px-4 pt-4 pb-2">
                <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-200">Top participantes</h4>
                <span class="text-xs text-slate-400">Níveis calculados automaticamente</span>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <tbody id="achievementsLeaderboardTable" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section data-app-page="admin" id="adminPage" class="hidden space-y-6 max-w-6xl mx-auto">
    <div class="card space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="pill">Informativo do administrador</p>
          <h3 class="text-xl font-semibold">Comunicados oficiais da coordenação</h3>
        </div>
        <span class="pill" data-admin-only aria-hidden="true">Modo administrador</span>
      </div>
      <div id="adminBulletinView" class="prose prose-slate dark:prose-invert max-w-none text-sm leading-relaxed"></div>
      <div id="adminBulletinEditor" class="space-y-3 hidden" data-admin-only aria-hidden="true">
        <textarea id="adminBulletinInput" class="input min-h-[140px] resize-y" placeholder="Escreva o informativo a ser publicado para a turma"></textarea>
        <div class="flex flex-wrap justify-end gap-2">
          <button id="btnDiscardBulletin" class="btn btn-ghost">Descartar alterações</button>
          <button id="btnSaveBulletin" class="btn btn-primary">Publicar informativo</button>
        </div>
      </div>
      <p id="adminBulletinEmpty" class="text-xs text-slate-500">Nenhum informativo publicado ainda.</p>
    </div>

    <div class="card space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="pill">Lançar missões</p>
          <h3 class="text-xl font-semibold">Distribua missões diárias ou relâmpago com XP personalizado</h3>
        </div>
        <span class="pill" data-admin-only aria-hidden="true">Administrador</span>
      </div>
      <div class="grid gap-3 lg:grid-cols-2" id="adminMissionForm">
        <div class="space-y-3">
          <div class="space-y-1">
            <label for="missionTitle" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Título da missão</label>
            <input id="missionTitle" class="input" placeholder="Ex.: Revisão de Procv em base real" />
          </div>
          <div class="space-y-1">
            <label for="missionDescription" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Descrição</label>
            <textarea id="missionDescription" class="input min-h-[120px] resize-y" placeholder="Detalhe o objetivo, entregáveis e anexos necessários."></textarea>
          </div>
        </div>
        <div class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div class="space-y-1">
              <label for="missionXP" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">XP</label>
              <input id="missionXP" class="input" type="number" min="5" max="60" step="5" placeholder="Ex.: 25" />
            </div>
            <div class="space-y-1">
              <label for="missionValidity" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Validade</label>
              <input id="missionValidity" class="input" type="date" />
            </div>
          </div>
          <div class="space-y-1">
            <label for="missionAudience" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Público-alvo</label>
            <select id="missionAudience" class="input">
              <option value="all">Todos os alunos</option>
              <option value="moduleA">Bloco A</option>
              <option value="moduleB">Bloco B</option>
              <option value="moduleC">Bloco C</option>
              <option value="moduleD">Bloco D</option>
            </select>
          </div>
          <div class="space-y-1">
            <label for="missionAttachments" class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Links ou anexos</label>
            <textarea id="missionAttachments" class="input min-h-[72px] resize-y" placeholder="Cole URLs ou IDs de arquivos, um por linha."></textarea>
          </div>
          <div class="flex flex-wrap justify-end gap-2">
            <button id="btnResetMission" class="btn btn-ghost">Limpar</button>
            <button id="btnLaunchMission" class="btn btn-primary">Lançar missão</button>
          </div>
        </div>
      </div>
      <div class="space-y-2">
        <h4 class="text-sm font-semibold">Missões lançadas recentemente</h4>
        <ul id="adminMissionList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>
</main>

<script>
  // Estado simples no front
  let currentUser = null;
  let currentSessionToken = null;
  let sessionExpiryNotified = false;
  let rememberPreference = false;
  let pendingConfirmation = null;
  let confirmationTimer = null;
  let currentAuthMode = 'login';
  let hasLoadedEmbeds = false;
  const STORAGE_KEY = 'excelPlatformSession';
  const SESSION_EXPIRED_FALLBACK = 'Sessão expirada. Faça login novamente.';
  const COMMUNITY_ATTACHMENT_MAX_BYTES = 10 * 1024 * 1024;

  function persistSession(token, user, options = {}) {
    if (!token || !user || !user.id) return;
    currentSessionToken = token;
    sessionExpiryNotified = false;
    const remember = options && Object.prototype.hasOwnProperty.call(options, 'remember')
      ? !!options.remember
      : rememberPreference;
    rememberPreference = remember;
    const payload = {
      token,
      userId: user.id,
      name: user.name,
      isAdmin: !!user.isAdmin,
    };
    if (remember) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (err) {
        console.warn('Não foi possível salvar sessão local:', err);
      }
    } else {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (err) {
        console.warn('Não foi possível limpar sessão local:', err);
      }
    }
  }

  function clearStoredSession() {
    currentSessionToken = null;
    rememberPreference = false;
    hasLoadedEmbeds = false;
    if (typeof rememberMeCheckbox !== 'undefined' && rememberMeCheckbox) {
      rememberMeCheckbox.checked = false;
    }
    try {
      localStorage.removeItem(STORAGE_KEY);
    } catch (err) {
      console.warn('Não foi possível limpar sessão local:', err);
    }
  }

  function getSessionToken() {
    if (currentSessionToken) return currentSessionToken;
    const stored = getStoredSession();
    if (stored && stored.token) {
      currentSessionToken = stored.token;
      return currentSessionToken;
    }
    return null;
  }

  function getStoredSession() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') return null;
      if (!parsed.token) return null;
      return parsed;
    } catch (err) {
      console.warn('Não foi possível ler sessão local:', err);
      return null;
    }
  }

  function extractErrorMessage(error) {
    if (!error) return '';
    if (typeof error === 'string') return error;
    if (error && typeof error === 'object' && typeof error.error === 'string') {
      return error.error;
    }
    if (error && typeof error === 'object' && error.error && typeof error.error.message === 'string') {
      return error.error.message;
    }
    if (typeof error.message === 'string') return error.message;
    if (typeof error.details === 'string') return error.details;
    return '';
  }

  function isSessionErrorMessage(message) {
    if (!message) return false;
    const normalized = message.toLowerCase();
    if (!normalized.includes('sessão')) return false;
    return normalized.includes('expirad') || normalized.includes('inválid') || normalized.includes('inval');
  }

  function expireSession(message) {
    const text = (message || '').toString().trim() || SESSION_EXPIRED_FALLBACK;
    const hadUser = !!currentUser;
    clearStoredSession();
    currentUser = null;
    if (hadUser) {
      if (!sessionExpiryNotified) {
        sessionExpiryNotified = true;
        showToast({ message: text, type: 'warning' });
      }
    } else {
      sessionExpiryNotified = false;
    }
    updateUI({ skipAchievements: true, skipCommunity: true, silentAchievements: true });
  }

  function handleSessionExpiredError(error, options = {}) {
    const message = extractErrorMessage(error);
    const isSessionError = isSessionErrorMessage(message)
      || (error && typeof error === 'object' && error.name === 'SessionError');
    if (!isSessionError) return false;
    const finalMessage = message || SESSION_EXPIRED_FALLBACK;
    if (typeof options.onHandled === 'function') {
      try {
        options.onHandled(finalMessage);
      } catch (callbackErr) {
        console.error(callbackErr);
      }
    }
    expireSession(finalMessage);
    return true;
  }

  // Helpers
  const $ = s => document.querySelector(s);
  const normalizeEmbed = url => {
    if (!url) return '';
    if (url.includes('onedrive') || url.includes('sharepoint')) {
      if (url.includes('embed')) return url;
      return 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(url);
    }
    if (url.includes('drive.google.com')) {
      return url.replace('/view?usp=sharing','/preview');
    }
    return url;
  };

  const adminOnlyElements = Array.from(document.querySelectorAll('[data-admin-only]'));
  function escapeHtml(text) {
    return (text || '').toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  const excelLinkInput = $('#excelLink');
  const pptLinkInput = $('#pptLink');
  const excelFrameEl = $('#excelFrame');
  const pptFrameEl = $('#pptFrame');
  const btnSaveEmbeds = $('#btnSaveEmbeds');
  const btnLoadEmbeds = $('#btnLoadEmbeds');
  const resourcesInputEl = $('#resourcesInput');
  const eventsInputEl = $('#eventsInput');
  const resourcesListEl = $('#resourcesList');
  const resourcesEmptyEl = $('#resourcesEmpty');
  const eventsListEl = $('#eventsList');
  const eventsEmptyEl = $('#eventsEmpty');
  const resourcesEmptyDefaultText = resourcesEmptyEl ? resourcesEmptyEl.textContent : '';
  const eventsEmptyDefaultText = eventsEmptyEl ? eventsEmptyEl.textContent : '';
  const loginForm = $('#loginForm');
  const loginCardEl = $('#loginCard');
  const signupCardEl = $('#signupCard');
  const confirmCardEl = $('#confirmCard');
  const btnGoogleAuth = $('#btnGoogleAuth');
  const rememberMeCheckbox = $('#rememberMe');
  const toggleSignupBtn = $('#toggleSignup');
  const toggleLoginBtn = $('#toggleLogin');
  const confirmForm = $('#confirmForm');
  const confirmEmailInput = $('#confirmationEmail');
  const confirmCodeInput = $('#confirmationCode');
  const confirmMsgEl = $('#confirmMsg');
  const btnConfirmSignup = $('#btnConfirmSignup');
  const btnResendConfirmation = $('#btnResendConfirmation');
  const confirmBackToLoginBtn = $('#confirmBackToLogin');
  const confirmationCountdownEl = $('#confirmationCountdown');
  const communityFormWrap = $('#communityFormWrap');
  const communityGuestNotice = $('#communityGuestNotice');
  const communityTextarea = $('#communityMessage');
  const communityCounterEl = $('#communityCounter');
  const communityFeedbackEl = $('#communityFormFeedback');
  const communityPublishBtn = $('#btnCommunityPublish');
  const communityListEl = $('#communityWallList');
  const communityEmptyEl = $('#communityWallEmpty');
  const communityEmptyDefaultText = communityEmptyEl ? communityEmptyEl.textContent : '';
  const communityLimitBadge = $('#communityLimitBadge');
  const communityPrivacySelect = $('#communityPrivacySelect');
  const communityTargetsWrap = $('#communityTargetsWrap');
  const communityTargetsSelect = $('#communityTargets');
  const communityAttachmentInput = $('#communityAttachmentInput');
  const communityAttachmentList = $('#communityAttachmentList');
  const achievementsAdminNoticeEl = $('#achievementsAdminNotice');
  const achievementsLeaderboardEl = $('#achievementsLeaderboard');
  const achievementsPodiumEl = $('#achievementsPodium');
  const achievementsLeaderboardTableEl = $('#achievementsLeaderboardTable');
  const achievementsRankingBadgeEl = $('#achievementsRankingBadge');
  const achievementsAdminNoticeDefaultText = achievementsAdminNoticeEl
    ? achievementsAdminNoticeEl.textContent
    : '';
  const primaryNavEl = $('#primaryNav');
  const appPageSections = Array.from(document.querySelectorAll('[data-app-page]'));
  const appNavLinks = Array.from(document.querySelectorAll('[data-app-route]'));
  const achievementsHeroStatsEl = $('#achievementsHeroStats');
  const aboutHighlightsEl = $('#aboutHighlights');
  const aboutModuleGridEl = $('#aboutModuleGrid');
  const learningTracksContainerEl = $('#learningTracksContainer');
  const learningAssessmentsEl = $('#learningAssessments');
  const panelPollListEl = $('#panelPollList');
  const adminBulletinViewEl = $('#adminBulletinView');
  const adminBulletinEditorEl = $('#adminBulletinEditor');
  const adminBulletinInputEl = $('#adminBulletinInput');
  const adminBulletinEmptyEl = $('#adminBulletinEmpty');
  const btnSaveBulletinEl = $('#btnSaveBulletin');
  const btnDiscardBulletinEl = $('#btnDiscardBulletin');
  const adminMissionListEl = $('#adminMissionList');
  const missionTitleInput = $('#missionTitle');
  const missionDescriptionInput = $('#missionDescription');
  const missionXPInput = $('#missionXP');
  const missionValidityInput = $('#missionValidity');
  const missionAudienceSelect = $('#missionAudience');
  const missionAttachmentsInput = $('#missionAttachments');
  const btnLaunchMission = $('#btnLaunchMission');
  const btnResetMission = $('#btnResetMission');
  const adminMissionFormEl = $('#adminMissionForm');
  const headerBreadcrumbs = $('#headerBreadcrumbs');
  const breadcrumbAdminItem = $('#breadcrumbAdmin');
  const breadcrumbSubPageItem = $('#breadcrumbSubPage');
  const breadcrumbSubPageLabel = $('#breadcrumbSubPageLabel');
  const studentHeroGreetingEl = $('#studentHeroGreeting');
  const studentNarrativeEl = $('#studentNarrative');
  const studentHeroStatsEl = $('#studentHeroStats');
  const nextLessonPreviewEl = $('#nextLessonPreview');
  const nextLessonProgressHintEl = $('#nextLessonProgressHint');
  const studentHeroGuidanceEl = $('#studentHeroGuidance');
  const dailyMissionListEl = $('#dailyMissionList');
  const studentSubPageSection = $('#studentSubPageSection');
  const studentSubPageTitleEl = $('#studentSubPageTitle');
  const studentSubPageSubtitleEl = $('#studentSubPageSubtitle');
  const studentSubPageLoadingEl = $('#studentSubPageLoading');
  const studentSubPageErrorEl = $('#studentSubPageError');
  const studentSubPageContainer = $('#studentSubPageContainer');
  const homeOnlySections = Array.from(document.querySelectorAll('[data-home-only]'));
  let communityCharLimit = 240;
  let isPublishingCommunity = false;
  const communityState = {
    attachments: [],
    uploading: 0,
    shareableUsers: [],
    loadedShareableUsers: false,
    privacy: 'public'
  };
  const communityDateFormatter = typeof Intl !== 'undefined'
    ? new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' })
    : null;
  const shortDateFormatter = typeof Intl !== 'undefined'
    ? new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short' })
    : null;
  const timeFormatter = typeof Intl !== 'undefined'
    ? new Intl.DateTimeFormat('pt-BR', { hour: '2-digit', minute: '2-digit' })
    : null;

  const toastContainer = $('#toastContainer');
  const toastVariants = {
    success: {
      toast: 'bg-emerald-600 text-white focus-visible:ring-emerald-200',
      close: 'bg-white/20 text-white hover:bg-white/30 focus-visible:ring-white'
    },
    error: {
      toast: 'bg-rose-600 text-white focus-visible:ring-rose-200',
      close: 'bg-white/20 text-white hover:bg-white/30 focus-visible:ring-white'
    },
    warning: {
      toast: 'bg-amber-500 text-slate-900 focus-visible:ring-amber-200',
      close: 'bg-black/10 text-slate-900 hover:bg-black/20 focus-visible:ring-amber-700'
    }
  };

  const TOTAL_MODULES = 24;
  const moduleCatalog = [
    { number: 1, title: 'Boas-vindas ao Excel', tagline: 'Explore a interface e prepare sua primeira planilha.', focus: 'Interface e navegação básicas', xpTarget: 30, keySkills: ['Interface do Excel', 'Faixas de opções', 'Atalhos essenciais'] },
    { number: 2, title: 'Formatação Essencial', tagline: 'Deixe as planilhas legíveis e profissionais.', focus: 'Formatação de células e estilos', xpTarget: 35, keySkills: ['Formatos numéricos', 'Estilos e temas', 'Formatação condicional'] },
    { number: 3, title: 'Fórmulas Fundamentais', tagline: 'Crie cálculos com as funções básicas.', focus: 'Funções SOMA, MÉDIA e contagens', xpTarget: 35, keySkills: ['SOMA', 'MÉDIA', 'CONT.SE'] },
    { number: 4, title: 'Funções Condicionais', tagline: 'Tome decisões com SE e comparações.', focus: 'Funções SE, E e OU', xpTarget: 40, keySkills: ['SE', 'SE aninhado', 'E/OU'] },
    { number: 5, title: 'Funções de Texto', tagline: 'Manipule informações textuais.', focus: 'Combinação e limpeza de textos', xpTarget: 35, keySkills: ['CONCAT', 'ESQUERDA/DIREITA', 'PROCURAR'] },
    { number: 6, title: 'Funções de Data e Hora', tagline: 'Controle prazos e agendas com precisão.', focus: 'Cálculos com datas e horas', xpTarget: 35, keySkills: ['HOJE', 'DIASÚTEIS', 'DATEDIF'] },
    { number: 7, title: 'Funções de Pesquisa', tagline: 'Localize dados em tabelas grandes.', focus: 'PROCV, PROCX e CORRESP', xpTarget: 40, keySkills: ['PROCV', 'PROCX', 'ÍNDICE + CORRESP'] },
    { number: 8, title: 'Tabelas Inteligentes', tagline: 'Organize dados com tabelas formatadas.', focus: 'Tabelas estruturadas e filtros dinâmicos', xpTarget: 35, keySkills: ['Formatar como tabela', 'Referências estruturadas', 'Totalizadores automáticos'] },
    { number: 9, title: 'Tabelas Dinâmicas Essenciais', tagline: 'Resuma grandes volumes rapidamente.', focus: 'Construção e análise com tabelas dinâmicas', xpTarget: 45, keySkills: ['Montagem de pivô', 'Segmentações', 'Atualizações e layout'] },
    { number: 10, title: 'Gráficos que Contam Histórias', tagline: 'Transforme números em visualizações impactantes.', focus: 'Gráficos de colunas, linhas e combinação', xpTarget: 40, keySkills: ['Tipos de gráfico', 'Formatar série', 'Linhas de tendência'] },
    { number: 11, title: 'Validação e Proteção', tagline: 'Garanta a qualidade das informações registradas.', focus: 'Validação de dados e proteção de planilhas', xpTarget: 35, keySkills: ['Validação de dados', 'Listas suspensas', 'Proteção de planilhas'] },
    { number: 12, title: 'Filtros Avançados', tagline: 'Crie filtros poderosos e personalizados.', focus: 'Filtros avançados e critérios com fórmulas', xpTarget: 35, keySkills: ['Filtros personalizados', 'Remover duplicatas', 'Segmentações avançadas'] },
    { number: 13, title: 'Análise de Cenários', tagline: 'Projete diferentes cenários de negócio.', focus: 'Tabela de dados e gerente de cenários', xpTarget: 40, keySkills: ['Tabela de dados', 'Gerenciador de cenários', 'Atingir meta'] },
    { number: 14, title: 'Solver e Otimização', tagline: 'Tome decisões ótimas com restrições reais.', focus: 'Solver e análise de sensibilidade', xpTarget: 45, keySkills: ['Solver', 'Restrições', 'Relatórios de resposta'] },
    { number: 15, title: 'Funções Estatísticas', tagline: 'Descubra padrões com estatística aplicada.', focus: 'Indicadores estatísticos no Excel', xpTarget: 40, keySkills: ['MÉDIASES', 'DESVPAD', 'CORREL'] },
    { number: 16, title: 'Dashboards Básicos', tagline: 'Monte painéis limpos e objetivos.', focus: 'Layout e indicadores visuais', xpTarget: 45, keySkills: ['Layout de dashboard', 'Cartões de indicador', 'Gráficos combinados'] },
    { number: 17, title: 'Dashboards Interativos', tagline: 'Dê vida aos seus painéis com interação.', focus: 'Segmentações e controles dinâmicos', xpTarget: 50, keySkills: ['Segmentações', 'Botões', 'Painéis dinâmicos'] },
    { number: 18, title: 'Automação com Macros', tagline: 'Grave rotinas para ganhar tempo todos os dias.', focus: 'Gravação e execução de macros', xpTarget: 45, keySkills: ['Gravar macros', 'Executar macros', 'Botões com macros'] },
    { number: 19, title: 'Introdução ao VBA', tagline: 'Edite código e personalize automações.', focus: 'Estruturas básicas no VBA', xpTarget: 50, keySkills: ['Editor VBA', 'Variáveis', 'Estruturas condicionais'] },
    { number: 20, title: 'Integrações com Office', tagline: 'Conecte o Excel com outras ferramentas da suíte.', focus: 'Integração com PowerPoint e Word', xpTarget: 35, keySkills: ['Copiar especial', 'Atualizar gráficos no PowerPoint', 'Publicar relatórios em PDF'] },
    { number: 21, title: 'Power Query Essencial', tagline: 'Importe e transforme dados rapidamente.', focus: 'ETL com Power Query', xpTarget: 50, keySkills: ['Importar dados', 'Transformações', 'Mesclar consultas'] },
    { number: 22, title: 'Power Pivot e Modelagem', tagline: 'Crie modelos com múltiplas tabelas conectadas.', focus: 'Modelagem relacional e medidas DAX básicas', xpTarget: 55, keySkills: ['Modelagem relacional', 'Medidas DAX', 'KPIs'] },
    { number: 23, title: 'Análise Avançada com DAX', tagline: 'Aprofunde os cálculos do Power Pivot.', focus: 'Funções DAX intermediárias', xpTarget: 60, keySkills: ['CALCULATE', 'Inteligência de tempo', 'Medidas compostas'] },
    { number: 24, title: 'Projeto Final', tagline: 'Consolide tudo em um projeto completo.', focus: 'Projeto integrador e apresentação de insights', xpTarget: 80, keySkills: ['Planejamento do projeto', 'Apresentação final', 'Feedback da turma'] }
  ];

  const weeklySideQuests = [
    { title: 'Planejar a semana', description: 'Revise sua agenda e defina quando você fará o próximo módulo.' },
    { title: 'Revisar anotações recentes', description: 'Leia as notas do último módulo concluído e destaque um aprendizado para aplicar hoje.' },
    { title: 'Praticar atalhos de teclado', description: 'Escolha três atalhos para usar durante o dia e ganhar agilidade nas planilhas.' },
    { title: 'Compartilhar no mural', description: 'Publique uma dica rápida ou insight no mural da comunidade.' },
    { title: 'Atualizar uma planilha real', description: 'Aplique os conceitos do curso em uma planilha do seu cotidiano profissional.' },
    { title: 'Checar conquistas pendentes', description: 'Veja quais conquistas estão próximas e planeje os próximos passos.' },
    { title: 'Organizar materiais de estudo', description: 'Separe arquivos e recursos que serão úteis para o próximo módulo.' }
  ];

  const aboutHighlightsData = [
    { label: 'Encontros ao vivo', value: '24', description: 'Sessões de 60 minutos + laboratório guiado.' },
    { label: 'Meta de XP do ciclo', value: '300 XP', description: 'Soma dos check-ins diários (1 + … + 24).' },
    { label: 'Blocos de conteúdo', value: '4', description: 'Fundamentos, Análise, Automação e Power BI.' },
    { label: 'Formato', value: 'Check-in diário', description: 'Missões rápidas, fórum ativo e leaderboard por temporada.' }
  ];

  function sumXpForRange(start, end) {
    const begin = Math.min(Number(start) || 0, Number(end) || 0);
    const finish = Math.max(Number(start) || 0, Number(end) || 0);
    return moduleCatalog.reduce((total, module) => {
      if (module.number >= begin && module.number <= finish) {
        return total + Number(module.xpTarget || 0);
      }
      return total;
    }, 0);
  }

  function daysFromNow(days) {
    const base = new Date();
    base.setHours(0, 0, 0, 0);
    base.setDate(base.getDate() + Number(days || 0));
    return base.toISOString();
  }

  const macroModulePlan = [
    {
      id: 'A',
      title: 'Bloco A — Fundamentos & Produtividade',
      range: [1, 6],
      summary: 'Interface, formatação profissional, fórmulas essenciais e controle de datas.',
      focus: ['Interface & atalhos', 'Formatação inteligente', 'Fórmulas SOMA/MÉDIA/SE'],
      xpTarget: sumXpForRange(1, 6),
      deliverables: ['Planilha modelo pronta para impressão', 'Checklist de atalhos favoritos'],
      challenge: {
        title: 'Desafio Operador Ninja',
        xp: 30,
        description: 'Aplicar 10 atalhos em uma planilha real e postar o antes/depois no mural.'
      },
      quiz: {
        title: 'Quiz Fundamentos Express',
        xp: 100,
        bonus: '+15 XP se finalizar com 100% em menos de 10 minutos.'
      },
      keyBadges: ['Primeiro Passo', 'Atalhos Ninja', 'Sem Erros (quiz 100%)']
    },
    {
      id: 'B',
      title: 'Bloco B — Análise de Dados Essencial',
      range: [7, 12],
      summary: 'Funções de busca, tabelas inteligentes, gráficos e filtros avançados.',
      focus: ['PROCX & ÍNDICE/CORRESP', 'Tabelas dinâmicas', 'Visualizações impactantes'],
      xpTarget: sumXpForRange(7, 12),
      deliverables: ['Dashboard 1.0 com gráficos conectados', 'Tabela dinâmica automatizada'],
      challenge: {
        title: 'Sprint Dashboard 1.0',
        xp: 45,
        description: 'Montar um mini-dashboard com segmentações e publicar no painel de projetos.'
      },
      quiz: {
        title: 'Quiz Busca & Referência',
        xp: 100,
        bonus: '+20 XP se marcar “Sem Erros”.'
      },
      keyBadges: ['Procura & Referência', 'Tabela Dinâmica Starter', 'Dashboard 1.0']
    },
    {
      id: 'C',
      title: 'Bloco C — Automação & Insights avançados',
      range: [13, 18],
      summary: 'Cenários, Solver, dashboards interativos, macros e introdução ao VBA.',
      focus: ['Análise de cenários', 'Solver e otimização', 'Macros e automações'],
      xpTarget: sumXpForRange(13, 18),
      deliverables: ['Relatório de cenários comparativos', 'Macro gravada com execução rápida'],
      challenge: {
        title: 'Maratona Semanal VBA Starter',
        xp: 55,
        description: 'Automatizar um fluxo simples via macro e compartilhar o vídeo da execução.'
      },
      quiz: {
        title: 'Quiz Automação & Dashboards',
        xp: 100,
        bonus: '+25 XP se entregar vídeo demonstrativo.'
      },
      keyBadges: ['Solver & Otimização', 'Dashboards Interativos', 'Power Query – Primeiros Passos']
    },
    {
      id: 'D',
      title: 'Bloco D — Power BI no Excel & Projeto Final',
      range: [19, 24],
      summary: 'Integrações com Office, Power Query, Power Pivot, DAX e projeto integrador.',
      focus: ['Integrações Office', 'Modelagem Power Pivot', 'Projeto final com apresentação'],
      xpTarget: sumXpForRange(19, 24),
      deliverables: ['Modelo Power Pivot com KPIs', 'Projeto final apresentado para a turma'],
      challenge: {
        title: 'Desafio Capstone',
        xp: 60,
        description: 'Construir um painel completo conectando Power Query + Power Pivot e entregar no painel.'
      },
      quiz: {
        title: 'Quiz Power Platform',
        xp: 100,
        bonus: '+30 XP para quem subir o relatório final com storytelling.'
      },
      keyBadges: ['Power Query – Primeiros Passos', 'Matrizes Dinâmicas', 'Projeto Final']
    }
  ];

  const panelPolls = [
    {
      id: 'poll-review',
      question: 'Qual tema merece reforço na sessão de revisão desta semana?',
      audience: 'Todos os blocos',
      closesAt: daysFromNow(2),
      options: [
        { id: 'atalhos', label: 'Produtividade e atalhos', votes: 18 },
        { id: 'busca', label: 'PROCX / ÍNDICE + CORRESP', votes: 24 },
        { id: 'dash', label: 'Tabelas dinâmicas & dashboards', votes: 20 }
      ]
    },
    {
      id: 'poll-challenge',
      question: 'Qual missão especial devemos lançar para o Bloco B?',
      audience: 'Bloco B',
      closesAt: daysFromNow(4),
      options: [
        { id: 'mini-dashboard', label: 'Mini dashboard com segmentações', votes: 12 },
        { id: 'power-query', label: 'Limpeza de dados com Power Query', votes: 17 },
        { id: 'colaborativo', label: 'Integração Excel + PowerPoint', votes: 9 }
      ]
    }
  ];

  const defaultMissionSamples = [
    {
      id: 'mission-atalhos',
      title: 'Sprint de atalhos',
      xp: 25,
      audience: 'Todos',
      validity: daysFromNow(1),
      description: 'Utilize 5 atalhos diferentes na planilha do dia e registre o GIF no mural.',
      attachments: []
    },
    {
      id: 'mission-procx',
      title: 'Caça aos PROCs',
      xp: 35,
      audience: 'Bloco B',
      validity: daysFromNow(3),
      description: 'Monte uma consulta PROCX em uma base real e compartilhe a fórmula no Painel.',
      attachments: []
    },
    {
      id: 'mission-powerquery',
      title: 'Power Query Relâmpago',
      xp: 40,
      audience: 'Bloco D',
      validity: daysFromNow(5),
      description: 'Importe dados externos via Power Query, aplique transformações básicas e poste o antes/depois.',
      attachments: ['https://support.microsoft.com/powerquery']
    }
  ];

  let panelPollState = panelPolls.map(poll => ({
    id: poll.id,
    question: poll.question,
    audience: poll.audience,
    closesAt: poll.closesAt,
    options: poll.options.map(option => ({ ...option })),
    userChoice: null,
    pendingChoice: null
  }));
  let lastPanelPollUserId = null;

  let adminBulletinState = {
    content: 'Semana 3 aberta! Reserve 15 minutos para revisar o bloco A antes do encontro ao vivo e registre o check-in até 22h.\n\nDica extra: quem postar um insight no mural até sexta participa do sorteio do livro “Excel na Prática”.',
    updatedAt: new Date()
  };

  let adminMissionsState = defaultMissionSamples.slice();

  const SUBPAGE_META = {
    'next-lesson': {
      title: 'Próxima aula',
      subtitle: 'Visualize o roteiro completo do próximo módulo e as atividades avaliativas.'
    },
    'achievements-catalog': {
      title: 'Conquistas do curso',
      subtitle: 'Confira todas as medalhas disponíveis e o que falta para desbloqueá-las.'
    }
  };

  const studentStoryState = {
    xp: 0,
    level: 1,
    modulesCompleted: 0,
    totalModules: TOTAL_MODULES,
    achievementsUnlocked: 0,
    totalAchievements: 0,
    metrics: {},
    checkinToday: false,
    nextModuleNumber: 1
  };

  let activeSubPage = 'home';
  const ROUTE_DEFS = {
    inicio: { slug: 'inicio' },
    sobre: { slug: 'sobre' },
    aulas: { slug: 'aulas' },
    painel: { slug: 'painel', requiresAuth: true },
    conquistas: { slug: 'conquistas' },
    admin: { slug: 'admin', requiresAuth: true, requiresAdmin: true }
  };
  const ROUTE_SLUGS = Object.keys(ROUTE_DEFS);
  let currentAppRoute = 'inicio';
  let appBasePath = '/';

  function normalizeRoute(value) {
    const text = (value || '').toString().toLowerCase().replace(/[^a-z]/g, '');
    return ROUTE_DEFS[text] ? text : 'inicio';
  }

  function computeBasePath(pathname) {
    let base = (pathname || '/').split('?')[0];
    ROUTE_SLUGS.forEach(slug => {
      const suffix = '/' + slug;
      if (base.endsWith(suffix)) {
        base = base.slice(0, -suffix.length);
      }
    });
    if (!base) return '/';
    if (!base.endsWith('/')) base += '/';
    return base;
  }

  function resolveRouteFromPath(pathname) {
    const segments = (pathname || '').split('/').filter(Boolean);
    if (!segments.length) return 'inicio';
    const last = segments[segments.length - 1].toLowerCase();
    return ROUTE_DEFS[last] ? last : 'inicio';
  }

  function syncAdminVisibility() {
    const isAdmin = !!(currentUser && currentUser.isAdmin);
    adminOnlyElements.forEach(el => {
      if (!el) return;
      el.classList.toggle('hidden', !isAdmin);
      if (isAdmin) {
        el.removeAttribute('aria-hidden');
      } else {
        el.setAttribute('aria-hidden', 'true');
      }
    });
  }

  function syncHeaderContext() {
    const isLogged = !!currentUser;
    if (headerBreadcrumbs) {
      headerBreadcrumbs.classList.toggle('hidden', !isLogged);
    }
    if (breadcrumbAdminItem) {
      breadcrumbAdminItem.classList.toggle('hidden', !(currentUser && currentUser.isAdmin));
    }
    if (!isLogged) {
      updateBreadcrumbSubPage(null);
    }
  }

  function renderAboutPage() {
    if (aboutHighlightsEl) {
      aboutHighlightsEl.innerHTML = '';
      aboutHighlightsData.forEach(item => {
        const box = document.createElement('div');
        box.className = 'rounded-2xl border border-slate-200 dark:border-slate-700/70 bg-white/90 dark:bg-slate-900/50 px-4 py-4 shadow-sm';
        const label = document.createElement('p');
        label.className = 'text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400';
        label.textContent = item.label;
        const value = document.createElement('div');
        value.className = 'text-xl font-semibold text-primary';
        value.textContent = item.value;
        const description = document.createElement('p');
        description.className = 'text-sm text-slate-600 dark:text-slate-300 mt-1';
        description.textContent = item.description;
        box.append(label, value, description);
        aboutHighlightsEl.appendChild(box);
      });
    }

    if (aboutModuleGridEl) {
      aboutModuleGridEl.innerHTML = '';
      macroModulePlan.forEach(block => {
        const card = document.createElement('div');
        card.className = 'card card-flat space-y-3';
        const header = document.createElement('div');
        header.className = 'flex flex-wrap items-start justify-between gap-3';
        const title = document.createElement('h4');
        title.className = 'text-lg font-semibold';
        title.textContent = block.title;
        const badge = document.createElement('span');
        badge.className = 'pill';
        badge.textContent = `Módulos ${block.range[0]}–${block.range[1]} • ${block.xpTarget} XP`;
        header.append(title, badge);

        const summary = document.createElement('p');
        summary.className = 'text-sm text-slate-600 dark:text-slate-300';
        summary.textContent = block.summary;

        const focusWrap = document.createElement('div');
        focusWrap.className = 'flex flex-wrap gap-2';
        block.focus.forEach(topic => {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = topic;
          focusWrap.appendChild(chip);
        });

        const deliverables = document.createElement('p');
        deliverables.className = 'text-xs text-slate-500 dark:text-slate-400';
        deliverables.textContent = `Entregáveis sugeridos: ${block.deliverables.join('; ')}`;

        const badges = document.createElement('p');
        badges.className = 'text-xs font-semibold text-primary';
        badges.textContent = `Badges em jogo: ${block.keyBadges.join(', ')}`;

        card.append(header, summary, focusWrap, deliverables, badges);
        aboutModuleGridEl.appendChild(card);
      });
    }
  }

  function renderLearningTracksPage() {
    if (learningTracksContainerEl) {
      learningTracksContainerEl.innerHTML = '';
      macroModulePlan.forEach(block => {
        const modules = moduleCatalog.filter(item => item.number >= block.range[0] && item.number <= block.range[1]);
        const card = document.createElement('div');
        card.className = 'card space-y-4';
        const header = document.createElement('div');
        header.className = 'flex flex-wrap items-start justify-between gap-3';
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-primary';
        title.textContent = block.title;
        const badge = document.createElement('span');
        badge.className = 'pill';
        badge.textContent = `${block.xpTarget} XP nos encontros ${block.range[0]}–${block.range[1]}`;
        header.append(title, badge);

        const moduleList = document.createElement('ul');
        moduleList.className = 'space-y-2 text-sm';
        modules.forEach(module => {
          const li = document.createElement('li');
          li.className = 'rounded-xl border border-slate-200 dark:border-slate-700/60 px-3 py-2 bg-white/90 dark:bg-slate-900/50 shadow-sm';
          li.innerHTML = `<div class="flex items-start justify-between gap-2"><span class="font-semibold">Módulo ${module.number}.</span><span class="text-xs text-slate-500">${module.xpTarget} XP</span></div><p class="text-xs text-slate-600 dark:text-slate-300">${module.title}</p>`;
          moduleList.appendChild(li);
        });

        const assessments = document.createElement('div');
        assessments.className = 'grid gap-3 sm:grid-cols-2';
        const challengeCard = document.createElement('div');
        challengeCard.className = 'rounded-2xl border border-emerald-200/70 dark:border-emerald-500/30 bg-emerald-50/80 dark:bg-emerald-500/10 px-4 py-3 space-y-1';
        challengeCard.innerHTML = `<p class="text-xs uppercase tracking-wide text-emerald-700 dark:text-emerald-300">Desafio</p><h4 class="text-sm font-semibold">${block.challenge.title}</h4><p class="text-sm text-emerald-900 dark:text-emerald-200">${block.challenge.description}</p><span class="pill">+${block.challenge.xp} XP</span>`;
        const quizCard = document.createElement('div');
        quizCard.className = 'rounded-2xl border border-amber-200/70 dark:border-amber-500/30 bg-amber-50/80 dark:bg-amber-500/10 px-4 py-3 space-y-1';
        quizCard.innerHTML = `<p class="text-xs uppercase tracking-wide text-amber-700 dark:text-amber-200">Quiz</p><h4 class="text-sm font-semibold">${block.quiz.title}</h4><p class="text-sm text-amber-900 dark:text-amber-200">Vale ${block.quiz.xp} XP. ${block.quiz.bonus}</p>`;
        assessments.append(challengeCard, quizCard);

        card.append(header, moduleList, assessments);
        learningTracksContainerEl.appendChild(card);
      });
    }

    if (learningAssessmentsEl) {
      learningAssessmentsEl.innerHTML = '';
      macroModulePlan.forEach(block => {
        const wrapper = document.createElement('div');
        wrapper.className = 'card card-flat space-y-3';
        const header = document.createElement('div');
        header.className = 'flex flex-wrap items-center justify-between gap-2';
        header.innerHTML = `<h4 class="text-lg font-semibold">${block.title}</h4><span class="pill">${block.range[0]}–${block.range[1]}</span>`;
        const body = document.createElement('div');
        body.className = 'grid gap-3 sm:grid-cols-2';

        const challenge = document.createElement('div');
        challenge.className = 'rounded-xl border border-emerald-200/70 dark:border-emerald-500/30 bg-white dark:bg-slate-900/60 px-3 py-3 space-y-1';
        challenge.innerHTML = `<p class="text-xs uppercase tracking-wide text-emerald-600 dark:text-emerald-300">Desafio do bloco</p><h5 class="text-sm font-semibold">${block.challenge.title}</h5><p class="text-sm text-slate-600 dark:text-slate-300">${block.challenge.description}</p><span class="pill">+${block.challenge.xp} XP</span>`;

        const quiz = document.createElement('div');
        quiz.className = 'rounded-xl border border-amber-200/70 dark:border-amber-500/30 bg-white dark:bg-slate-900/60 px-3 py-3 space-y-1';
        quiz.innerHTML = `<p class="text-xs uppercase tracking-wide text-amber-600 dark:text-amber-300">Quiz oficial</p><h5 class="text-sm font-semibold">${block.quiz.title}</h5><p class="text-sm text-slate-600 dark:text-slate-300">${block.quiz.bonus}</p><span class="pill">Até ${block.quiz.xp} XP</span>`;

        body.append(challenge, quiz);
        wrapper.append(header, body);
        learningAssessmentsEl.appendChild(wrapper);
      });
    }
  }

  function renderPolls() {
    if (!panelPollListEl) return;
    panelPollListEl.innerHTML = '';
    const hasActiveUser = !!currentUser;
    panelPollState.forEach(poll => {
      const totalVotes = poll.options.reduce((sum, option) => sum + Number(option.votes || 0), 0);
      const card = document.createElement('div');
      card.className = 'card card-flat space-y-3';
      const header = document.createElement('div');
      header.className = 'flex flex-wrap items-start justify-between gap-3';
      const info = document.createElement('div');
      info.innerHTML = `<h4 class="text-base font-semibold">${poll.question}</h4><p class="text-xs text-slate-500 dark:text-slate-400">${poll.audience}</p>`;
      const deadline = document.createElement('span');
      deadline.className = 'pill';
      const expiresText = formatDateShort(poll.closesAt) || '';
      deadline.textContent = expiresText ? `Encerra em ${expiresText}` : 'Enquete ativa';
      header.append(info, deadline);

      const optionsWrap = document.createElement('div');
      optionsWrap.className = 'space-y-2';

      poll.options.forEach(option => {
        const optionId = `${poll.id}-${option.id}`;
        const optionLabel = document.createElement('label');
        optionLabel.className = 'block rounded-xl border border-slate-200 dark:border-slate-700/60 bg-white/95 dark:bg-slate-900/60 px-3 py-2';
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-2';
        const left = document.createElement('div');
        left.className = 'flex items-center gap-2';
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = `poll-${poll.id}`;
        input.value = option.id;
        input.id = optionId;
        const isSelected = hasActiveUser && (poll.pendingChoice ? poll.pendingChoice === option.id : poll.userChoice === option.id);
        input.checked = isSelected;
        input.disabled = !hasActiveUser;
        input.addEventListener('change', () => {
          poll.pendingChoice = option.id;
          renderPolls();
        });
        const labelText = document.createElement('span');
        labelText.className = 'text-sm font-medium';
        labelText.textContent = option.label;
        left.append(input, labelText);
        const voteInfo = document.createElement('span');
        voteInfo.className = 'text-xs text-slate-500';
        voteInfo.textContent = `${option.votes || 0} voto${Number(option.votes || 0) === 1 ? '' : 's'}`;
        row.append(left, voteInfo);

        const bar = document.createElement('div');
        bar.className = 'mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden';
        const fill = document.createElement('div');
        fill.className = 'h-full rounded-full bg-primary/80';
        const pct = totalVotes > 0 ? Math.round((Number(option.votes || 0) / totalVotes) * 100) : 0;
        fill.style.width = `${pct}%`;
        bar.appendChild(fill);

        optionLabel.append(row, bar);
        optionsWrap.appendChild(optionLabel);
      });

      const footer = document.createElement('div');
      footer.className = 'flex flex-wrap items-center justify-between gap-2';
      const totalBadge = document.createElement('span');
      totalBadge.className = 'text-xs text-slate-500 dark:text-slate-400';
      totalBadge.textContent = `${totalVotes} voto${totalVotes === 1 ? '' : 's'} registrados`;
      const voteButton = document.createElement('button');
      voteButton.type = 'button';
      voteButton.className = 'btn btn-primary';
      const nextChoice = poll.pendingChoice || poll.userChoice;
      voteButton.disabled = !hasActiveUser || !poll.pendingChoice || poll.pendingChoice === poll.userChoice;
      voteButton.textContent = poll.userChoice ? 'Atualizar voto' : 'Registrar voto';
      voteButton.addEventListener('click', () => {
        if (!currentUser) {
          showToast({ message: 'Faça login para votar na enquete.', type: 'warning' });
          return;
        }
        const choice = poll.pendingChoice;
        if (!choice) return;
        if (poll.userChoice) {
          const previous = poll.options.find(opt => opt.id === poll.userChoice);
          if (previous) previous.votes = Math.max(0, Number(previous.votes || 0) - 1);
        }
        const selected = poll.options.find(opt => opt.id === choice);
        if (selected) selected.votes = Number(selected.votes || 0) + 1;
        poll.userChoice = choice;
        poll.pendingChoice = choice;
        showToast({ message: 'Voto registrado! +3 XP garantidos na atualização diária.', type: 'success' });
        renderPolls();
      });
      if (!hasActiveUser) {
        voteButton.disabled = true;
      }
      footer.append(totalBadge, voteButton);

      card.append(header, optionsWrap, footer);
      panelPollListEl.appendChild(card);
    });
  }

  function renderPanelPage() {
    renderPolls();
    renderCommunityAttachments();
    setCommunityPrivacy(communityState.privacy);
    renderCommunityTargetsOptions();
    if (currentUser) {
      loadShareableUsers();
    }
  }

  function renderAchievementsShowcase(summary = achievementsState.summary, metrics = achievementsState.metrics) {
    if (!achievementsHeroStatsEl) return;
    achievementsHeroStatsEl.innerHTML = '';
    if (!currentUser) {
      const card = document.createElement('div');
      card.className = 'rounded-2xl border border-slate-200 dark:border-slate-700/60 bg-white/80 dark:bg-slate-900/60 px-4 py-4 shadow-sm';
      card.innerHTML = '<p class="text-sm text-slate-600 dark:text-slate-300">Faça login para acompanhar seu painel de conquistas e streaks.</p>';
      achievementsHeroStatsEl.appendChild(card);
      return;
    }

    const total = Number(summary?.total || 0);
    const unlocked = Number(summary?.unlocked || 0);
    const currentStreak = Number(metrics?.checkinCurrentStreak || metrics?.current || 0);
    const bestStreak = Number(metrics?.checkinBestStreak || metrics?.best || 0);
    const totalCheckins = Number(metrics?.totalCheckins || 0);

    const stats = [
      { label: 'Badges desbloqueadas', value: `${unlocked}/${total}`, description: 'Progresso total de conquistas.' },
      { label: 'Streak atual', value: `${currentStreak} dia${currentStreak === 1 ? '' : 's'}`, description: 'Check-ins consecutivos.', highlight: currentStreak >= 7 },
      { label: 'Recorde pessoal', value: `${bestStreak} dia${bestStreak === 1 ? '' : 's'}`, description: `${totalCheckins} check-ins no total.` }
    ];

    stats.forEach(item => {
      const box = document.createElement('div');
      box.className = 'rounded-2xl border border-slate-200 dark:border-slate-700/60 bg-white/90 dark:bg-slate-900/60 px-4 py-4 shadow-sm';
      const label = document.createElement('p');
      label.className = 'text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400';
      label.textContent = item.label;
      const value = document.createElement('div');
      value.className = 'text-xl font-semibold text-primary';
      value.textContent = item.value;
      if (item.highlight) value.classList.add('text-emerald-600', 'dark:text-emerald-300');
      const desc = document.createElement('p');
      desc.className = 'text-xs text-slate-500 dark:text-slate-400 mt-1';
      desc.textContent = item.description;
      box.append(label, value, desc);
      achievementsHeroStatsEl.appendChild(box);
    });
  }

  function formatAudienceLabel(value) {
    switch ((value || '').toString()) {
      case 'moduleA':
        return 'Bloco A';
      case 'moduleB':
        return 'Bloco B';
      case 'moduleC':
        return 'Bloco C';
      case 'moduleD':
        return 'Bloco D';
      case 'Todos':
      case 'all':
        return 'Todos os alunos';
      default:
        return value || 'Todos os alunos';
    }
  }

  function renderAdminBulletin() {
    if (!adminBulletinViewEl || !adminBulletinEmptyEl) return;
    const content = (adminBulletinState && adminBulletinState.content) ? adminBulletinState.content.trim() : '';
    if (content) {
      const paragraphs = content.split(/\n{2,}/).map(par => par.trim()).filter(Boolean);
      adminBulletinViewEl.innerHTML = paragraphs.map(par => `<p>${escapeHtml(par)}</p>`).join('');
      adminBulletinEmptyEl.classList.add('hidden');
    } else {
      adminBulletinViewEl.innerHTML = '';
      adminBulletinEmptyEl.classList.remove('hidden');
    }
    if (currentUser?.isAdmin && adminBulletinInputEl) {
      adminBulletinInputEl.value = content;
    }
  }

  function renderAdminMissionList() {
    if (!adminMissionListEl) return;
    adminMissionListEl.innerHTML = '';
    if (!adminMissionsState.length) {
      const empty = document.createElement('li');
      empty.className = 'text-xs text-slate-500 dark:text-slate-400';
      empty.textContent = 'Nenhuma missão lançada ainda. Utilize o formulário acima para publicar a primeira missão.';
      adminMissionListEl.appendChild(empty);
      return;
    }
    adminMissionsState
      .slice()
      .sort((a, b) => {
        const aTime = parseDateValue(a.validity)?.getTime() || 0;
        const bTime = parseDateValue(b.validity)?.getTime() || 0;
        return aTime - bTime;
      })
      .forEach(mission => {
        const li = document.createElement('li');
        li.className = 'rounded-2xl border border-slate-200 dark:border-slate-700/60 bg-white/90 dark:bg-slate-900/60 px-4 py-3 space-y-2';
        const header = document.createElement('div');
        header.className = 'flex flex-wrap items-start justify-between gap-2';
        header.innerHTML = `<h5 class="text-sm font-semibold">${escapeHtml(mission.title)}</h5><span class="pill">+${mission.xp} XP</span>`;
        const meta = document.createElement('p');
        meta.className = 'text-xs text-slate-500 dark:text-slate-400';
        const validityText = formatDateShort(mission.validity);
        meta.textContent = `${formatAudienceLabel(mission.audience)} • válido até ${validityText || '—'}`;
        const description = document.createElement('p');
        description.className = 'text-sm text-slate-600 dark:text-slate-300';
        description.textContent = mission.description || '';
        li.append(header, meta, description);
        if (Array.isArray(mission.attachments) && mission.attachments.length) {
          const attachList = document.createElement('ul');
          attachList.className = 'space-y-1 text-xs';
          mission.attachments.forEach(link => {
            const clean = (link || '').toString().trim();
            if (!clean) return;
            const item = document.createElement('li');
            item.innerHTML = `<a class="text-primary hover:underline" href="${escapeHtml(clean)}" target="_blank" rel="noopener">${escapeHtml(clean)}</a>`;
            attachList.appendChild(item);
          });
          if (attachList.childElementCount > 0) {
            const attachTitle = document.createElement('p');
            attachTitle.className = 'text-xs font-semibold text-slate-500 dark:text-slate-400';
            attachTitle.textContent = 'Links e anexos';
            li.append(attachTitle, attachList);
          }
        }
        adminMissionListEl.appendChild(li);
      });
  }

  function setNavActive(route) {
    const normalized = normalizeRoute(route);
    appNavLinks.forEach(link => {
      const linkRoute = normalizeRoute(link.getAttribute('data-app-route'));
      const isActive = linkRoute === normalized;
      link.classList.toggle('app-nav-link-active', isActive);
      if (isActive) {
        link.setAttribute('aria-current', 'page');
      } else {
        link.removeAttribute('aria-current');
      }
    });
  }

  function syncNavAvailability() {
    appNavLinks.forEach(link => {
      const route = normalizeRoute(link.getAttribute('data-app-route'));
      const def = ROUTE_DEFS[route];
      const requiresAuth = !!(def && def.requiresAuth);
      const requiresAdmin = !!(def && def.requiresAdmin);
      const disabled = (requiresAuth && !currentUser) || (requiresAdmin && !(currentUser && currentUser.isAdmin));
      link.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      link.tabIndex = disabled ? -1 : 0;
      const li = link.closest('li');
      const guestVisible = route === 'inicio' || route === 'sobre';
      const hideForGuest = !currentUser && !guestVisible;
      const hideForAdmin = requiresAdmin && !(currentUser && currentUser.isAdmin);
      if (li) {
        li.classList.toggle('hidden', hideForGuest || hideForAdmin);
      }
    });
  }

  function ensureRouteAfterAuthChange() {
    const def = ROUTE_DEFS[currentAppRoute] || ROUTE_DEFS.inicio;
    if (def.requiresAdmin && !(currentUser && currentUser.isAdmin)) {
      navigateTo(currentUser ? 'inicio' : 'sobre', { replace: true, silent: true });
      return;
    }
    if (def.requiresAuth && !currentUser) {
      navigateTo('inicio', { replace: true, silent: true });
      return;
    }
    if (!currentUser && def.slug !== 'inicio' && def.slug !== 'sobre') {
      navigateTo('sobre', { replace: true, silent: true });
    }
  }

  function updateHistoryForRoute(route, replace) {
    if (typeof window === 'undefined' || !window.history || !window.location) return;
    const def = ROUTE_DEFS[route] || ROUTE_DEFS.inicio;
    const slug = def.slug || 'inicio';
    const base = appBasePath || '/';
    const url = base + slug;
    const state = { appRoute: route };
    if (replace) {
      window.history.replaceState(state, '', url);
    } else {
      window.history.pushState(state, '', url);
    }
  }

  function renderRouteEntry(route) {
    const normalized = normalizeRoute(route);
    if (normalized === 'sobre') {
      renderAboutPage();
    } else if (normalized === 'aulas') {
      renderLearningTracksPage();
    } else if (normalized === 'painel') {
      renderPanelPage();
    } else if (normalized === 'conquistas') {
      renderAchievementsShowcase();
      populateAchievementsCatalog();
    } else if (normalized === 'admin') {
      renderAdminBulletin();
      renderAdminMissionList();
    }
  }

  function applyRoute(route, options = {}) {
    const normalized = normalizeRoute(route);
    const force = !!options.force;
    if (currentAppRoute === normalized && !force) {
      if (!options.skipHistory) updateHistoryForRoute(normalized, !!options.replaceHistory);
      return;
    }
    currentAppRoute = normalized;
    appPageSections.forEach(section => {
      const page = normalizeRoute(section.getAttribute('data-app-page'));
      const visible = page === normalized;
      section.classList.toggle('hidden', !visible);
    });
    setNavActive(normalized);
    if (!options.skipHistory) {
      updateHistoryForRoute(normalized, !!options.replaceHistory);
    }
    renderRouteEntry(normalized);
  }

  function navigateTo(route, options = {}) {
    const normalized = normalizeRoute(route);
    const def = ROUTE_DEFS[normalized];
    let target = normalized;
    let replaceHistory = !!options.replace;
    const silent = !!options.silent;
    if (def?.requiresAdmin && !(currentUser && currentUser.isAdmin)) {
      if (!silent) {
        showToast({ message: 'Somente administradores podem acessar esta área.', type: 'warning' });
      }
      target = currentUser ? 'inicio' : 'sobre';
      replaceHistory = true;
    } else if (def?.requiresAuth && !currentUser) {
      if (!silent) {
        showToast({ message: 'Faça login para acessar esta área.', type: 'warning' });
      }
      target = 'inicio';
      replaceHistory = true;
    }
    applyRoute(target, { replaceHistory, skipHistory: !!options.skipHistory, force: !!options.force });
  }

  function bootstrapRouter() {
    if (typeof window === 'undefined') return;
    appBasePath = computeBasePath(window.location.pathname || '/');
    const initialRouteRaw = typeof window !== 'undefined' && window.__INITIAL_ROUTE__
      ? window.__INITIAL_ROUTE__.toString()
      : '';
    const pathRoute = resolveRouteFromPath(window.location.pathname || '/');
    const initialRoute = normalizeRoute(initialRouteRaw || pathRoute);
    appNavLinks.forEach(link => {
      link.addEventListener('click', event => {
        event.preventDefault();
        if (link.getAttribute('aria-disabled') === 'true') return;
        const route = normalizeRoute(link.getAttribute('data-app-route'));
        navigateTo(route);
      });
    });
    applyRoute(initialRoute, { replaceHistory: true, force: true });
    window.addEventListener('popstate', event => {
      const stateRoute = event.state && event.state.appRoute
        ? event.state.appRoute
        : resolveRouteFromPath(window.location.pathname || '/');
      applyRoute(stateRoute, { replaceHistory: true, skipHistory: true, force: true });
    });
  }

  function getFirstName(name) {
    const text = (name || '').toString().trim();
    if (!text) return '';
    const parts = text.split(/\s+/);
    return parts.length ? parts[0] : text;
  }

  function computeNextModuleNumber() {
    const scores = studentStoryState.metrics && studentStoryState.metrics.moduleBestScores
      ? studentStoryState.metrics.moduleBestScores
      : {};
    for (let i = 1; i <= TOTAL_MODULES; i += 1) {
      const key = String(i);
      const score = Number(scores[key] || 0);
      if (!Number.isFinite(score) || score < 70) {
        return i;
      }
    }
    return null;
  }

  function getModuleInfo(moduleNumber) {
    const number = Number(moduleNumber);
    if (!Number.isFinite(number)) {
      return { number: null, title: 'Módulo em construção', tagline: '', focus: '', xpTarget: 40, keySkills: [] };
    }
    const found = moduleCatalog.find(item => Number(item.number) === number);
    if (found) return found;
    return {
      number,
      title: `Módulo ${number}`,
      tagline: 'Conteúdo em desenvolvimento.',
      focus: 'Fundamentos do Excel',
      xpTarget: 40,
      keySkills: []
    };
  }

  function buildLessonActivities(moduleData) {
    const focusText = (moduleData && moduleData.focus) ? moduleData.focus.toLowerCase() : 'o conteúdo do módulo';
    const totalXP = Math.max(15, Number(moduleData && moduleData.xpTarget ? moduleData.xpTarget : 40));
    let xpIntro = Math.max(5, Math.round(totalXP * 0.3));
    let xpQuiz = Math.max(5, Math.round(totalXP * 0.2));
    let xpPractice = totalXP - xpIntro - xpQuiz;
    if (xpPractice < 10) {
      xpPractice = 10;
      const remaining = totalXP - xpPractice;
      xpIntro = Math.max(5, Math.round(remaining * 0.6));
      xpQuiz = Math.max(5, remaining - xpIntro);
    }
    let xpReview = totalXP - xpIntro - xpPractice;
    if (xpReview < 5) {
      xpReview = 5;
      xpPractice = Math.max(10, totalXP - xpIntro - xpReview);
    }
    const diff = totalXP - (xpIntro + xpPractice + xpReview);
    if (diff !== 0) {
      xpPractice += diff;
    }
    return [
      { icon: '📘', title: 'Aquecimento guiado', xp: xpIntro, description: `Revise as aulas rápidas sobre ${focusText}.` },
      { icon: '💻', title: 'Projeto aplicado', xp: xpPractice, description: `Replique o passo a passo em uma planilha real envolvendo ${focusText}.` },
      { icon: '🎯', title: 'Desafio relâmpago', xp: Math.max(5, xpReview), description: `Responda ao quiz para validar os conceitos de ${focusText}.` }
    ];
  }

  function formatShortDate(value) {
    const parsed = parseDateValue(value);
    if (!parsed) return '';
    if (shortDateFormatter) {
      try {
        return shortDateFormatter.format(parsed);
      } catch (err) {
        // fallback below
      }
    }
    return parsed.toLocaleDateString('pt-BR');
  }

  function hasCheckinToday() {
    if (!Array.isArray(historyState.checkins)) return false;
    const today = new Date();
    const todayIso = today.toISOString().slice(0, 10);
    return historyState.checkins.some(item => {
      if (!item) return false;
      const day = (item.day || '').toString().slice(0, 10);
      return day === todayIso;
    });
  }

  function setActiveSubPageButtons(target) {
    const buttons = Array.from(document.querySelectorAll('.student-nav-btn[data-nav-target]'));
    buttons.forEach(btn => {
      const key = btn.getAttribute('data-nav-target');
      const isActive = key === target;
      btn.classList.toggle('student-nav-btn-active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function updateBreadcrumbSubPage(pageKey) {
    if (!breadcrumbSubPageItem || !breadcrumbSubPageLabel) return;
    if (!currentUser || !pageKey || pageKey === 'home') {
      breadcrumbSubPageItem.classList.add('hidden');
      breadcrumbSubPageLabel.textContent = '';
      return;
    }
    const meta = SUBPAGE_META[pageKey];
    breadcrumbSubPageLabel.textContent = meta && meta.title ? meta.title : 'Explorar';
    breadcrumbSubPageItem.classList.remove('hidden');
  }

  function setSubPageHeader(pageKey) {
    if (!studentSubPageTitleEl || !studentSubPageSubtitleEl) return;
    if (!pageKey || pageKey === 'home') {
      studentSubPageTitleEl.textContent = 'Conteúdo complementar';
      studentSubPageSubtitleEl.textContent = 'Escolha uma opção para continuar sua jornada.';
      return;
    }
    const meta = SUBPAGE_META[pageKey] || {};
    studentSubPageTitleEl.textContent = meta.title || 'Conteúdo complementar';
    studentSubPageSubtitleEl.textContent = meta.subtitle || 'Selecione uma opção para continuar evoluindo.';
  }

  function buildDailyMissions() {
    if (!currentUser) {
      return [
        {
          id: 'login',
          icon: '🔐',
          title: 'Entre na plataforma',
          description: 'Crie uma conta ou faça login para liberar as missões do dia.',
          status: 'pending',
          statusLabel: 'Aguardando login',
          actionLabel: 'Fazer login',
          action: () => {
            const input = $('#lEmail');
            if (input) {
              input.focus({ preventScroll: true });
            }
          }
        }
      ];
    }

    const missions = [];
    missions.push({
      id: 'checkin',
      icon: '✅',
      title: 'Registrar o check-in diário',
      description: studentStoryState.checkinToday
        ? 'Presença confirmada. Volte amanhã para manter a sequência ativa!'
        : 'Confirme sua presença de hoje para garantir XP e manter a sequência de estudos.',
      status: studentStoryState.checkinToday ? 'done' : 'pending',
      statusLabel: studentStoryState.checkinToday ? 'Concluído' : 'Disponível',
      actionLabel: studentStoryState.checkinToday ? null : 'Fazer check-in',
      action: studentStoryState.checkinToday
        ? null
        : () => {
            const btn = $('#btnCheckin');
            if (btn) {
              btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
              btn.focus({ preventScroll: true });
            }
          }
    });

    const dayIndex = (new Date()).getDay();
    const quest = weeklySideQuests[dayIndex] || weeklySideQuests[0];
    missions.push({
      id: 'weekly',
      icon: '🗓️',
      title: quest.title,
      description: quest.description,
      status: 'pending',
      statusLabel: 'Sugestão do dia'
    });

    const nextModuleNumber = computeNextModuleNumber();
    if (nextModuleNumber) {
      const moduleData = getModuleInfo(nextModuleNumber);
      missions.push({
        id: 'module-preview',
        icon: '🎯',
        title: `Preparar módulo ${nextModuleNumber}`,
        description: `Reserve um tempo para avançar em “${moduleData.title}” e registrar seu desempenho.`,
        status: 'pending',
        statusLabel: 'Vale XP',
        actionLabel: 'Ver roteiro',
        action: () => openStudentSubPage('next-lesson')
      });
    } else {
      missions.push({
        id: 'review',
        icon: '🌟',
        title: 'Revisar conquistas',
        description: 'Você concluiu todos os módulos! Revise as conquistas e celebre os resultados com a turma.',
        status: 'done',
        statusLabel: 'Curso completo'
      });
    }

    return missions;
  }

  function renderDailyMissions() {
    if (!dailyMissionListEl) return;
    const missions = buildDailyMissions();
    dailyMissionListEl.innerHTML = '';
    if (!missions.length) {
      const empty = document.createElement('li');
      empty.className = 'text-xs text-slate-500 dark:text-slate-400';
      empty.textContent = 'Sem missões disponíveis no momento.';
      dailyMissionListEl.appendChild(empty);
      return;
    }
    missions.forEach(mission => {
      const li = document.createElement('li');
      li.className = 'mission-item' + (mission.status === 'done' ? ' mission-item-complete' : '');
      const icon = document.createElement('div');
      icon.className = 'mission-icon';
      icon.textContent = mission.icon || '⭐';
      const content = document.createElement('div');
      content.className = 'mission-content';
      const title = document.createElement('div');
      title.className = 'mission-title';
      title.textContent = mission.title;
      const description = document.createElement('p');
      description.className = 'mission-description';
      description.textContent = mission.description;
      const status = document.createElement('span');
      status.className = 'mission-status';
      status.textContent = mission.statusLabel || (mission.status === 'done' ? 'Concluído' : 'Disponível');
      content.appendChild(title);
      content.appendChild(description);
      content.appendChild(status);
      if (typeof mission.action === 'function' && mission.status !== 'done' && mission.actionLabel) {
        const actionBtn = document.createElement('button');
        actionBtn.type = 'button';
        actionBtn.className = 'btn btn-primary mission-action-btn';
        actionBtn.textContent = mission.actionLabel;
        actionBtn.addEventListener('click', event => {
          event.preventDefault();
          mission.action();
        });
        content.appendChild(actionBtn);
      }
      li.appendChild(icon);
      li.appendChild(content);
      dailyMissionListEl.appendChild(li);
    });
  }

  function renderStudentHero() {
    const firstName = currentUser ? getFirstName(currentUser.name) : '';
    if (studentHeroGreetingEl) {
      studentHeroGreetingEl.textContent = currentUser ? `Olá, ${firstName}!` : 'Bem-vindo!';
    }

    if (studentNarrativeEl) {
      if (!currentUser) {
        studentNarrativeEl.textContent = 'Crie uma conta ou faça login para acompanhar sua história de evolução no Excel.';
      } else {
        const xpText = `${formatNumber(studentStoryState.xp)} XP`;
        const modulesText = `${studentStoryState.modulesCompleted}/${studentStoryState.totalModules} módulos concluídos`;
        const achievementsTotal = studentStoryState.totalAchievements || 0;
        const achievementsText = achievementsTotal > 0
          ? `${studentStoryState.achievementsUnlocked}/${achievementsTotal} conquistas desbloqueadas`
          : 'Conquistas aguardando seus primeiros desbloqueios';
        const streak = Number(studentStoryState.metrics.checkinCurrentStreak || 0);
        const streakText = streak > 0
          ? `Sua sequência de check-ins está em ${streak} dia${streak > 1 ? 's' : ''}.`
          : 'Comece agora com o check-in diário para criar sua sequência.';
        studentNarrativeEl.textContent = `Você já acumulou ${xpText} e concluiu ${modulesText}. ${achievementsText}. ${streakText}`;
      }
    }

    if (studentHeroStatsEl) {
      studentHeroStatsEl.innerHTML = '';
      if (!currentUser) {
        const chip = document.createElement('span');
        chip.className = 'pill';
        chip.textContent = 'Missões personalizadas liberadas após o login.';
        studentHeroStatsEl.appendChild(chip);
      } else {
        const stats = [];
        stats.push(`${formatNumber(studentStoryState.xp)} XP`);
        stats.push(`${studentStoryState.modulesCompleted}/${studentStoryState.totalModules} módulos`);
        if (studentStoryState.totalAchievements > 0) {
          stats.push(`${studentStoryState.achievementsUnlocked}/${studentStoryState.totalAchievements} conquistas`);
        }
        const streak = Number(studentStoryState.metrics.checkinCurrentStreak || 0);
        if (streak > 0) {
          stats.push(`Streak: ${streak} dia${streak > 1 ? 's' : ''}`);
        }
        stats.forEach(text => {
          const chip = document.createElement('span');
          chip.className = 'milestone-chip';
          chip.textContent = text;
          studentHeroStatsEl.appendChild(chip);
        });
      }
    }

    const nextModuleNumber = computeNextModuleNumber();
    if (nextLessonPreviewEl) {
      if (!currentUser) {
        nextLessonPreviewEl.textContent = 'Faça login para liberar sua próxima aula.';
      } else if (!nextModuleNumber) {
        nextLessonPreviewEl.textContent = 'Trilha concluída! Revise o projeto final e celebre seus resultados.';
      } else {
        const moduleData = getModuleInfo(nextModuleNumber);
        nextLessonPreviewEl.textContent = `Módulo ${nextModuleNumber} · ${moduleData.title}`;
      }
    }

    if (nextLessonProgressHintEl) {
      if (!currentUser) {
        nextLessonProgressHintEl.textContent = '';
      } else if (!nextModuleNumber) {
        nextLessonProgressHintEl.textContent = 'Aproveite para compartilhar aprendizados e apoiar colegas no mural.';
      } else {
        const moduleData = getModuleInfo(nextModuleNumber);
        const scores = studentStoryState.metrics && studentStoryState.metrics.moduleBestScores
          ? studentStoryState.metrics.moduleBestScores
          : {};
        const bestScore = Number(scores[String(nextModuleNumber)] || 0);
        if (bestScore > 0 && bestScore < 70) {
          nextLessonProgressHintEl.textContent = `Você já tentou este módulo e alcançou ${bestScore}%. Revise a aula e tente novamente para conquistar a pontuação cheia.`;
        } else {
          nextLessonProgressHintEl.textContent = moduleData.tagline || 'Prepare-se para avançar ao próximo nível.';
        }
      }
    }

    if (studentHeroGuidanceEl) {
      if (!currentUser) {
        studentHeroGuidanceEl.textContent = 'Acompanhe aqui as missões do dia e libere a próxima aula após o login.';
      } else if (!nextModuleNumber) {
        studentHeroGuidanceEl.textContent = 'Continue praticando, revise conquistas e compartilhe dicas com a turma.';
      } else {
        studentHeroGuidanceEl.textContent = `Reserve um momento hoje para avançar no módulo ${nextModuleNumber} e registrar o resultado em "Enviar atividade".`;
      }
    }

    renderDailyMissions();
  }

  function updateStudentStoryState(partial = {}) {
    if (!partial || typeof partial !== 'object') return;
    if (partial.xp !== undefined) {
      studentStoryState.xp = Math.max(0, Number(partial.xp) || 0);
    }
    if (partial.level !== undefined) {
      studentStoryState.level = Math.max(1, Number(partial.level) || 1);
    }
    if (partial.modulesCompleted !== undefined) {
      studentStoryState.modulesCompleted = Math.max(0, Number(partial.modulesCompleted) || 0);
    }
    if (partial.achievementsUnlocked !== undefined) {
      studentStoryState.achievementsUnlocked = Math.max(0, Number(partial.achievementsUnlocked) || 0);
    }
    if (partial.totalAchievements !== undefined) {
      studentStoryState.totalAchievements = Math.max(0, Number(partial.totalAchievements) || 0);
    }
    if (partial.checkinToday !== undefined) {
      studentStoryState.checkinToday = !!partial.checkinToday;
    }
    if (partial.metrics) {
      const nextMetrics = Object.assign({}, studentStoryState.metrics, partial.metrics);
      if (partial.metrics.moduleBestScores) {
        nextMetrics.moduleBestScores = Object.assign(
          {},
          studentStoryState.metrics.moduleBestScores || {},
          partial.metrics.moduleBestScores
        );
      }
      studentStoryState.metrics = nextMetrics;
      if (partial.metrics.modulesCompleted !== undefined) {
        studentStoryState.modulesCompleted = Math.max(0, Number(partial.metrics.modulesCompleted) || 0);
      }
      if (partial.metrics.xpTotal !== undefined && Number.isFinite(Number(partial.metrics.xpTotal))) {
        studentStoryState.xp = Math.max(0, Number(partial.metrics.xpTotal));
      }
    }
    studentStoryState.nextModuleNumber = computeNextModuleNumber();
    renderStudentHero();
    if (activeSubPage === 'next-lesson') {
      populateNextLessonPage();
    }
    if (activeSubPage === 'achievements-catalog') {
      populateAchievementsCatalog();
    }
  }

  function resetStudentStoryState() {
    studentStoryState.xp = 0;
    studentStoryState.level = 1;
    studentStoryState.modulesCompleted = 0;
    studentStoryState.achievementsUnlocked = 0;
    studentStoryState.totalAchievements = 0;
    studentStoryState.metrics = {};
    studentStoryState.checkinToday = false;
    studentStoryState.nextModuleNumber = 1;
    renderStudentHero();
  }

  function populateNextLessonPage() {
    if (!studentSubPageContainer) return;
    const container = studentSubPageContainer.querySelector('[data-subpage="next-lesson"]');
    if (!container) return;
    const moduleNumber = computeNextModuleNumber();
    const mainSection = container.querySelector('[data-role="lesson-main"]');
    const completeSection = container.querySelector('[data-role="lesson-complete"]');

    if (!moduleNumber) {
      if (mainSection) mainSection.classList.add('hidden');
      if (completeSection) {
        completeSection.classList.remove('hidden');
        const completeTitle = completeSection.querySelector('[data-role="lesson-complete-title"]');
        if (completeTitle) completeTitle.textContent = 'Parabéns! Você concluiu todos os módulos principais.';
      }
      return;
    }

    if (mainSection) mainSection.classList.remove('hidden');
    if (completeSection) completeSection.classList.add('hidden');

    const moduleData = getModuleInfo(moduleNumber);
    const titleEl = container.querySelector('[data-role="lesson-title"]');
    if (titleEl) titleEl.textContent = `Módulo ${moduleNumber} · ${moduleData.title}`;
    const summaryEl = container.querySelector('[data-role="lesson-summary"]');
    if (summaryEl) summaryEl.textContent = moduleData.tagline || '';
    const focusEl = container.querySelector('[data-role="lesson-focus"]');
    if (focusEl) focusEl.textContent = moduleData.focus || '';
    const xpEl = container.querySelector('[data-role="lesson-xp"]');
    if (xpEl) xpEl.textContent = `${moduleData.xpTarget || 40} XP em jogo`;
    const statusEl = container.querySelector('[data-role="lesson-status"]');
    if (statusEl) {
      const scores = studentStoryState.metrics.moduleBestScores || {};
      const bestScore = Number(scores[String(moduleNumber)] || 0);
      statusEl.textContent = bestScore >= 70
        ? `Melhor nota registrada: ${Math.round(bestScore)}%`
        : 'Ainda sem envio de atividade — prepare-se para registrar seu resultado.';
    }
    const planIntroEl = container.querySelector('[data-role="lesson-plan-intro"]');
    if (planIntroEl) {
      planIntroEl.textContent = `Use este roteiro para dominar ${moduleData.focus.toLowerCase()} e somar XP na plataforma.`;
    }
    const skillsList = container.querySelector('[data-role="lesson-skills"]');
    if (skillsList) {
      skillsList.innerHTML = '';
      const skills = Array.isArray(moduleData.keySkills) ? moduleData.keySkills : [];
      if (!skills.length) {
        const li = document.createElement('li');
        li.className = 'text-xs text-slate-500 dark:text-slate-400';
        li.textContent = 'Habilidades serão disponibilizadas em breve.';
        skillsList.appendChild(li);
      } else {
        skills.forEach(skill => {
          const li = document.createElement('li');
          li.className = 'milestone-chip';
          li.textContent = skill;
          skillsList.appendChild(li);
        });
      }
    }

    const planHighlights = container.querySelector('[data-role="lesson-plan-highlights"]');
    if (planHighlights) {
      planHighlights.innerHTML = '';
      const highlights = [
        {
          icon: '🧭',
          title: 'Preparação rápida',
          description: 'Reserve 10 minutos para revisar as notas do módulo anterior e montar uma lista de dúvidas.'
        },
        {
          icon: '🚀',
          title: 'Aplicação imediata',
          description: 'Replique o exemplo da aula em uma planilha real e registre o resultado em “Enviar atividade”.'
        }
      ];
      highlights.forEach(item => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border border-slate-200 dark:border-slate-700/70 bg-white/80 dark:bg-slate-900/60 p-4 shadow-sm';
        card.innerHTML = `
          <div class="text-2xl mb-2">${item.icon}</div>
          <h4 class="text-sm font-semibold mb-1">${item.title}</h4>
          <p class="text-sm text-slate-500 dark:text-slate-300">${item.description}</p>
        `;
        planHighlights.appendChild(card);
      });
    }

    const activitiesList = container.querySelector('[data-role="lesson-activities"]');
    const activitiesPointsEl = container.querySelector('[data-role="lesson-activities-points"]');
    if (activitiesPointsEl) {
      activitiesPointsEl.textContent = `${moduleData.xpTarget || 40} XP distribuídos`;
    }
    if (activitiesList) {
      activitiesList.innerHTML = '';
      const activities = buildLessonActivities(moduleData);
      activities.forEach((activity, index) => {
        const li = document.createElement('li');
        li.className = 'mission-item';
        const icon = document.createElement('div');
        icon.className = 'mission-icon';
        icon.textContent = activity.icon || '📚';
        const content = document.createElement('div');
        content.className = 'mission-content';
        const title = document.createElement('div');
        title.className = 'mission-title';
        title.textContent = `${index + 1}. ${activity.title}`;
        const description = document.createElement('p');
        description.className = 'mission-description';
        description.textContent = activity.description;
        const status = document.createElement('span');
        status.className = 'mission-status';
        status.textContent = `+${formatNumber(activity.xp || 0)} XP`;
        content.appendChild(title);
        content.appendChild(description);
        content.appendChild(status);
        li.appendChild(icon);
        li.appendChild(content);
        activitiesList.appendChild(li);
      });
    }
  }

  function populateAchievementsCatalog() {
    if (!studentSubPageContainer) return;
    const container = studentSubPageContainer.querySelector('[data-subpage="achievements-catalog"]');
    if (!container) return;
    const loadingEl = container.querySelector('[data-role="achievement-loading"]');
    const errorEl = container.querySelector('[data-role="achievement-error"]');
    const listEl = container.querySelector('[data-role="achievement-list"]');
    const emptyEl = container.querySelector('[data-role="achievement-empty"]');
    const summaryEl = container.querySelector('[data-role="achievement-summary"]');

    if (summaryEl) {
      const unlockedNow = achievementsState.summary && achievementsState.summary.unlocked
        ? achievementsState.summary.unlocked
        : 0;
      const totalNow = achievementsState.summary && achievementsState.summary.total
        ? achievementsState.summary.total
        : 0;
      summaryEl.textContent = `${formatNumber(unlockedNow)}/${formatNumber(totalNow)} desbloqueadas`;
    }

    if (achievementsState.loading) {
      if (loadingEl) loadingEl.classList.remove('hidden');
      if (errorEl) errorEl.classList.add('hidden');
      if (listEl) listEl.classList.add('hidden');
      if (emptyEl) emptyEl.classList.add('hidden');
      return;
    }

    if (loadingEl) loadingEl.classList.add('hidden');

    if (achievementsState.error) {
      if (errorEl) {
        errorEl.textContent = achievementsState.error;
        errorEl.classList.remove('hidden');
      }
      if (listEl) listEl.classList.add('hidden');
      if (emptyEl) emptyEl.classList.add('hidden');
      return;
    }

    if (errorEl) errorEl.classList.add('hidden');

    const achievements = achievementsState.achievements || [];
    if (!achievements.length) {
      if (listEl) listEl.classList.add('hidden');
      if (emptyEl) {
        emptyEl.textContent = currentUser
          ? 'Nenhuma conquista cadastrada ainda.'
          : 'Faça login para visualizar as conquistas disponíveis.';
        emptyEl.classList.remove('hidden');
      }
      return;
    }

    if (listEl) {
      listEl.innerHTML = '';
      listEl.classList.remove('hidden');
      achievements.forEach(item => {
        const card = document.createElement('article');
        const classes = ['achievement-card'];
        classes.push(item.unlocked ? 'achievement-card-unlocked' : 'achievement-card-locked');
        if (!item.unlocked && item.readyToUnlock) {
          classes.push('achievement-card-ready');
        }
        card.className = classes.join(' ');
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-3';
        header.innerHTML = `
          <span class="achievement-icon">${item.icon || '🏆'}</span>
          <span class="achievement-xp">${formatNumber(item.rewardXP || 0)} XP</span>
        `;
        const title = document.createElement('h4');
        title.className = 'text-base font-semibold';
        title.textContent = item.title || 'Conquista';
        const description = document.createElement('p');
        description.className = 'text-sm text-slate-500 dark:text-slate-300 mb-3';
        description.textContent = item.description || '';
        const status = document.createElement('p');
        status.className = 'text-xs font-semibold text-slate-500 dark:text-slate-300 mb-2';
        if (item.unlocked) {
          const unlockedAt = item.unlockedAt ? formatShortDate(item.unlockedAt) : '';
          status.textContent = unlockedAt ? `Desbloqueada em ${unlockedAt}` : 'Conquista desbloqueada';
        } else if (item.readyToUnlock) {
          status.textContent = 'Pronto para resgatar — finalize o requisito e atualize o painel.';
        } else {
          status.textContent = item.progressLabel || 'Em andamento';
        }
        const track = document.createElement('div');
        track.className = 'achievement-progress-track';
        const progress = document.createElement('div');
        progress.className = 'achievement-progress-bar';
        const pct = Math.max(0, Math.min(100, Number(item.progressPct || 0)));
        progress.style.width = `${pct}%`;
        track.appendChild(progress);
        card.appendChild(header);
        card.appendChild(title);
        card.appendChild(description);
        card.appendChild(status);
        card.appendChild(track);
        listEl.appendChild(card);
      });
    }

    if (emptyEl) emptyEl.classList.add('hidden');
  }

  function attachNavListeners(scope = document) {
    if (!scope) return;
    const nodes = Array.from(scope.querySelectorAll('[data-nav-target]'));
    nodes.forEach(node => {
      if (node.dataset.navBound === 'true') return;
      node.dataset.navBound = 'true';
      node.addEventListener('click', event => {
        event.preventDefault();
        const target = node.getAttribute('data-nav-target') || 'home';
        openStudentSubPage(target);
      });
    });
  }

  function openStudentSubPage(target) {
    const normalized = (target || 'home').toString();
    if (normalized !== 'home' && !currentUser) {
      showToast({ message: 'Faça login para acessar esta área.', type: 'warning' });
      return;
    }

    const isHome = normalized === 'home';
    homeOnlySections.forEach(section => {
      if (!section) return;
      section.classList.toggle('hidden', !isHome);
    });

    if (isHome) {
      activeSubPage = 'home';
      setActiveSubPageButtons('home');
      updateBreadcrumbSubPage(null);
      setSubPageHeader(null);
      if (studentSubPageSection) studentSubPageSection.classList.add('hidden');
      if (studentSubPageLoadingEl) studentSubPageLoadingEl.classList.add('hidden');
      if (studentSubPageErrorEl) studentSubPageErrorEl.classList.add('hidden');
      if (studentSubPageContainer) studentSubPageContainer.innerHTML = '';
      return;
    }

    activeSubPage = normalized;
    setActiveSubPageButtons(normalized);
    updateBreadcrumbSubPage(normalized);
    setSubPageHeader(normalized);
    if (studentSubPageSection) studentSubPageSection.classList.remove('hidden');
    if (studentSubPageLoadingEl) studentSubPageLoadingEl.classList.remove('hidden');
    if (studentSubPageErrorEl) studentSubPageErrorEl.classList.add('hidden');
    if (studentSubPageContainer) studentSubPageContainer.innerHTML = '';

    const expectedPage = normalized;
    google.script.run
      .withFailureHandler(err => {
        if (activeSubPage !== expectedPage) return;
        if (studentSubPageLoadingEl) studentSubPageLoadingEl.classList.add('hidden');
        if (studentSubPageErrorEl) {
          studentSubPageErrorEl.textContent = err?.message || 'Não foi possível carregar a página agora.';
          studentSubPageErrorEl.classList.remove('hidden');
        }
      })
      .withSuccessHandler(html => {
        if (activeSubPage !== expectedPage) return;
        if (studentSubPageLoadingEl) studentSubPageLoadingEl.classList.add('hidden');
        if (studentSubPageErrorEl) studentSubPageErrorEl.classList.add('hidden');
        if (studentSubPageContainer) {
          studentSubPageContainer.innerHTML = html || '';
          attachNavListeners(studentSubPageContainer);
        }
        if (studentSubPageSection && typeof studentSubPageSection.scrollIntoView === 'function') {
          studentSubPageSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        if (expectedPage === 'next-lesson') {
          populateNextLessonPage();
        } else if (expectedPage === 'achievements-catalog') {
          populateAchievementsCatalog();
        }
      })
      .renderStudentSubPage({ page: normalized, userId: currentUser ? currentUser.id : null });
  }

  function renderHighlightList(listEl, items, emptyEl) {
    if (!listEl) return;
    listEl.innerHTML = '';
    const data = Array.isArray(items) ? items.map(item => (item || '').toString().trim()).filter(Boolean) : [];
    if (!data.length) {
      if (emptyEl) emptyEl.classList.remove('hidden');
      return;
    }
    if (emptyEl) emptyEl.classList.add('hidden');
    data.forEach(text => {
      const li = document.createElement('li');
      li.className = 'rounded-xl bg-slate-100 dark:bg-slate-800/70 px-3 py-2 shadow-sm';
      li.textContent = text;
      listEl.appendChild(li);
    });
  }

  function collectTextareaList(textarea) {
    if (!textarea) return [];
    const lines = textarea.value.split('\n');
    const result = [];
    lines.forEach(line => {
      const text = line.trim();
      if (!text) return;
      if (!result.includes(text)) result.push(text);
    });
    return result;
  }

  function setCommunityLimit(limit) {
    const numeric = Number(limit);
    if (!Number.isFinite(numeric) || numeric <= 0) return;
    communityCharLimit = numeric;
    if (communityLimitBadge) communityLimitBadge.textContent = `Até ${numeric} caracteres`;
    if (communityTextarea) communityTextarea.maxLength = numeric;
    updateCommunityCounter();
  }

  function updateCommunityCounter() {
    if (!communityCounterEl) return;
    const value = communityTextarea ? communityTextarea.value : '';
    const length = value ? value.length : 0;
    communityCounterEl.textContent = `${length}/${communityCharLimit}`;
    communityCounterEl.classList.toggle('text-rose-500', length > communityCharLimit);
  }

  function showCommunityError(message) {
    if (!communityFeedbackEl) return;
    const text = (message || '').toString().trim();
    communityFeedbackEl.textContent = text;
    communityFeedbackEl.classList.toggle('hidden', !text);
  }

  function formatFileSize(bytes) {
    const size = Number(bytes);
    if (!Number.isFinite(size) || size <= 0) return '';
    if (size >= 1024 * 1024) return `${(size / (1024 * 1024)).toFixed(1)} MB`;
    if (size >= 1024) return `${(size / 1024).toFixed(1)} KB`;
    return `${size} B`;
  }

  function getSelectedCommunityTargets() {
    if (!communityTargetsSelect) return [];
    return Array.from(communityTargetsSelect.selectedOptions || [])
      .map(option => option.value)
      .filter(value => value);
  }

  function setCommunityPrivacy(value) {
    const normalized = value === 'private' ? 'private' : 'public';
    communityState.privacy = normalized;
    if (communityPrivacySelect) communityPrivacySelect.value = normalized;
    if (communityTargetsWrap) communityTargetsWrap.classList.toggle('hidden', normalized !== 'private');
    if (normalized === 'private') {
      loadShareableUsers();
    }
    updateCommunityPublishState();
  }

  function renderCommunityAttachments() {
    if (!communityAttachmentList) return;
    communityAttachmentList.innerHTML = '';
    if (!communityState.attachments.length) {
      const empty = document.createElement('li');
      empty.className = 'text-xs text-slate-500';
      empty.textContent = 'Nenhum arquivo anexado até o momento.';
      communityAttachmentList.appendChild(empty);
      return;
    }
    communityState.attachments.forEach(att => {
      const li = document.createElement('li');
      li.className = 'attachment-item';

      const info = document.createElement('div');
      info.className = 'attachment-info';
      const icon = document.createElement('span');
      icon.className = 'attachment-icon';
      icon.textContent = '📎';
      const textWrap = document.createElement('div');
      textWrap.className = 'attachment-text';
      const nameLink = document.createElement('a');
      nameLink.className = 'attachment-name';
      nameLink.textContent = att && att.name ? att.name : 'Arquivo';
      if (att && att.url) {
        nameLink.href = att.url;
        nameLink.target = '_blank';
        nameLink.rel = 'noopener';
      } else {
        nameLink.href = '#';
        nameLink.addEventListener('click', event => event.preventDefault());
      }
      const meta = document.createElement('span');
      meta.className = 'attachment-meta';
      meta.textContent = formatFileSize(att && att.sizeBytes);
      textWrap.append(nameLink, meta);
      info.append(icon, textWrap);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'attachment-remove';
      removeBtn.textContent = 'Remover';
      removeBtn.addEventListener('click', () => discardDraftAttachment(att, removeBtn));

      li.append(info, removeBtn);
      communityAttachmentList.appendChild(li);
    });
  }

  function discardDraftAttachment(att, button) {
    if (!att || !att.id) return;
    const index = communityState.attachments.findIndex(item => item.id === att.id);
    if (index === -1) return;
    const finalize = () => {
      communityState.attachments.splice(index, 1);
      renderCommunityAttachments();
      updateCommunityPublishState();
    };
    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      finalize();
      return;
    }
    const originalLabel = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = 'Removendo...';
    }
    google.script.run
      .withFailureHandler(err => {
        if (button) {
          button.disabled = false;
          button.textContent = originalLabel || 'Remover';
        }
        showCommunityError(err?.message || 'Não foi possível remover o anexo agora.');
      })
      .withSuccessHandler(() => {
        if (button) {
          button.disabled = false;
          button.textContent = originalLabel || 'Remover';
        }
        showCommunityError('');
        finalize();
      })
      .discardCommunityAttachment({ token, attachmentId: att.id });
  }

  function renderCommunityTargetsOptions() {
    if (!communityTargetsSelect) return;
    const previouslySelected = new Set(
      Array.from(communityTargetsSelect.options || [])
        .filter(option => option.selected)
        .map(option => option.value)
        .filter(Boolean)
    );
    communityTargetsSelect.innerHTML = '';
    if (!communityState.shareableUsers.length) {
      const empty = document.createElement('option');
      empty.disabled = true;
      empty.textContent = 'Nenhum participante disponível';
      communityTargetsSelect.appendChild(empty);
      updateCommunityPublishState();
      return;
    }
    communityState.shareableUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name + (user.isAdmin ? ' • Coordenação' : '');
      option.selected = previouslySelected.has(user.id);
      communityTargetsSelect.appendChild(option);
    });
    updateCommunityPublishState();
  }

  function loadShareableUsers() {
    if (!currentUser || communityState.loadedShareableUsers) return;
    const token = getSessionToken();
    if (!token) return;
    google.script.run
      .withFailureHandler(err => {
        console.warn('Falha ao carregar destinatários:', err);
      })
      .withSuccessHandler(res => {
        const list = res && Array.isArray(res.users) ? res.users : [];
        communityState.shareableUsers = list;
        communityState.loadedShareableUsers = true;
        renderCommunityTargetsOptions();
      })
      .listShareableUsers({ token });
  }

  function uploadCommunityAttachmentFile(file) {
    if (!file) return;
    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      return;
    }
    if (file.size > COMMUNITY_ATTACHMENT_MAX_BYTES) {
      showCommunityError(`O arquivo ${file.name} excede o limite de 10 MB.`);
      return;
    }
    communityState.uploading += 1;
    updateCommunityPublishState();
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      google.script.run
        .withFailureHandler(err => {
          communityState.uploading = Math.max(0, communityState.uploading - 1);
          updateCommunityPublishState();
          showCommunityError(err?.message || 'Não foi possível enviar o arquivo agora.');
        })
        .withSuccessHandler(res => {
          communityState.uploading = Math.max(0, communityState.uploading - 1);
          updateCommunityPublishState();
          const attachment = res && res.attachment;
          if (attachment && attachment.id) {
            communityState.attachments.push(attachment);
            renderCommunityAttachments();
            showCommunityError('');
          }
        })
        .uploadCommunityAttachment({
          token,
          fileName: file.name,
          mimeType: file.type || 'application/octet-stream',
          data: dataUrl
        });
    };
    reader.onerror = () => {
      communityState.uploading = Math.max(0, communityState.uploading - 1);
      updateCommunityPublishState();
      showCommunityError('Não foi possível ler o arquivo selecionado.');
    };
    reader.readAsDataURL(file);
  }

  function updateCommunityPublishState() {
    if (!communityPublishBtn) return;
    const message = communityTextarea ? communityTextarea.value.trim() : '';
    const hasText = !!message;
    const hasAttachments = communityState.attachments.length > 0;
    const selectedTargets = getSelectedCommunityTargets();
    const isPrivate = communityState.privacy === 'private';
    const invalidTargets = isPrivate && selectedTargets.length === 0;
    const disabled = !currentUser
      || (!hasText && !hasAttachments)
      || message.length > communityCharLimit
      || isPublishingCommunity
      || communityState.uploading > 0
      || invalidTargets;
    communityPublishBtn.disabled = disabled;
  }

  function updateCommunityAccess() {
    const loggedIn = !!currentUser;
    if (communityFormWrap) communityFormWrap.classList.toggle('hidden', !loggedIn);
    if (communityGuestNotice) communityGuestNotice.classList.toggle('hidden', loggedIn);
    if (!loggedIn && communityTextarea) {
      communityTextarea.value = '';
      showCommunityError('');
      updateCommunityCounter();
    }
    if (!loggedIn) {
      communityState.attachments = [];
      communityState.uploading = 0;
      communityState.shareableUsers = [];
      communityState.loadedShareableUsers = false;
      renderCommunityAttachments();
      setCommunityPrivacy('public');
      if (communityTargetsSelect) communityTargetsSelect.innerHTML = '';
    }
    renderCommunityTargetsOptions();
    updateCommunityPublishState();
  }

  function formatCommunityDate(value) {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    if (communityDateFormatter) {
      try {
        return communityDateFormatter.format(date);
      } catch (err) {
        // fallback para toLocaleString
      }
    }
    try {
      return date.toLocaleString('pt-BR');
    } catch (err) {
      return date.toISOString();
    }
  }

  function renderCommunityWall(entries) {
    if (!communityListEl) return;
    communityListEl.innerHTML = '';
    const list = Array.isArray(entries) ? entries : [];
    if (!list.length) {
      if (communityEmptyEl) communityEmptyEl.classList.remove('hidden');
      return;
    }
    if (communityEmptyEl) communityEmptyEl.classList.add('hidden');

    list.forEach(entry => {
      const card = document.createElement('article');
      card.className = 'rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/70 p-4 shadow-sm flex flex-col gap-3';
      card.dataset.id = entry && entry.id ? entry.id : '';

      const header = document.createElement('div');
      header.className = 'flex flex-wrap items-start justify-between gap-3';

      const meta = document.createElement('div');
      meta.className = 'flex flex-col';

      const nameEl = document.createElement('span');
      nameEl.className = 'font-semibold text-slate-700 dark:text-slate-100';
      nameEl.textContent = (entry && entry.authorName) ? entry.authorName : 'Participante';
      meta.appendChild(nameEl);

      const timeEl = document.createElement('span');
      timeEl.className = 'text-xs text-slate-500 dark:text-slate-400';
      timeEl.textContent = formatCommunityDate(entry && entry.createdAt) || 'Agora mesmo';
      meta.appendChild(timeEl);

      header.appendChild(meta);

      const actions = document.createElement('div');
      actions.className = 'flex flex-col items-end gap-2 text-right';
      const visibility = entry && entry.visibility === 'private' ? 'private' : 'public';
      const visibilityChip = document.createElement('span');
      visibilityChip.className = 'privacy-chip' + (visibility === 'private' ? ' privacy-chip-private' : '');
      visibilityChip.textContent = visibility === 'private' ? 'Privado' : 'Público';
      actions.appendChild(visibilityChip);

      if (currentUser?.isAdmin) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.dataset.action = 'remove-wall-entry';
        removeBtn.dataset.id = entry && entry.id ? entry.id : '';
        removeBtn.className = 'text-xs font-semibold text-rose-600 hover:text-rose-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 rounded px-2 py-1 transition';
        removeBtn.textContent = 'Remover';
        actions.appendChild(removeBtn);
      }

      if (actions.children.length) {
        header.appendChild(actions);
      }

      const messageEl = document.createElement('p');
      messageEl.className = 'text-sm text-slate-700 dark:text-slate-200 whitespace-pre-line leading-relaxed';
      messageEl.textContent = (entry && entry.message) ? entry.message : '';

      card.appendChild(header);
      card.appendChild(messageEl);

      const targetNames = entry && Array.isArray(entry.targetUserNames)
        ? entry.targetUserNames.filter(Boolean)
        : [];
      if (visibility === 'private' && targetNames.length) {
        const recipients = document.createElement('p');
        recipients.className = 'text-xs text-slate-500 dark:text-slate-400';
        recipients.textContent = 'Destinatários: ' + targetNames.join(', ');
        card.appendChild(recipients);
      }

      const attachments = entry && Array.isArray(entry.attachments) ? entry.attachments : [];
      if (attachments.length) {
        const attachmentList = document.createElement('ul');
        attachmentList.className = 'space-y-2';
        attachments.forEach(att => {
          if (!att || !att.id) return;
          const li = document.createElement('li');
          li.className = 'attachment-item';

          const info = document.createElement('div');
          info.className = 'attachment-info';
          const icon = document.createElement('span');
          icon.className = 'attachment-icon';
          icon.textContent = '📎';
          const textWrap = document.createElement('div');
          textWrap.className = 'attachment-text';
          const nameLink = document.createElement('a');
          nameLink.className = 'attachment-name';
          nameLink.textContent = att.name || 'Arquivo';
          if (att.url) {
            nameLink.href = att.url;
            nameLink.target = '_blank';
            nameLink.rel = 'noopener';
          } else {
            nameLink.href = '#';
            nameLink.addEventListener('click', event => event.preventDefault());
          }
          const metaEl = document.createElement('span');
          metaEl.className = 'attachment-meta';
          metaEl.textContent = formatFileSize(att.sizeBytes);
          textWrap.append(nameLink, metaEl);
          info.append(icon, textWrap);

          li.appendChild(info);
          attachmentList.appendChild(li);
        });
        card.appendChild(attachmentList);
      }

      communityListEl.appendChild(card);
    });
  }

  function refreshCommunityWall() {
    if (!communityListEl) return;
    const token = getSessionToken();
    const payload = token ? { token } : {};
    google.script.run
      .withFailureHandler(err => {
        console.error('Falha ao carregar mural:', err);
      })
      .withSuccessHandler(res => {
        if (res && typeof res.limit === 'number') {
          setCommunityLimit(res.limit);
        }
        const entries = res && Array.isArray(res.entries) ? res.entries : [];
        renderCommunityWall(entries);
      })
      .listCommunityWallEntries(payload);
  }

  const achievementsState = {
    loading: false,
    error: '',
    achievements: [],
    summary: { total: 0, unlocked: 0 },
    metrics: {}
  };

  function showToast({ message, type = 'success', duration = 4000 } = {}) {
    const text = (message ?? '').toString().trim();
    if (!toastContainer || !text) return;

    const variant = toastVariants[type] ? type : 'success';
    const activeElement = document.activeElement;
    const returnFocusTo = activeElement instanceof HTMLElement
      && activeElement !== document.body
      && !toastContainer.contains(activeElement)
      ? activeElement
      : null;
    const toast = document.createElement('div');
    toast.setAttribute('role', variant === 'error' ? 'alert' : 'status');
    toast.setAttribute('aria-live', variant === 'error' ? 'assertive' : 'polite');
    toast.setAttribute('aria-atomic', 'true');
    toast.setAttribute('tabindex', '-1');
    toast.className = [
      'pointer-events-auto',
      'flex items-start gap-3 rounded-xl px-4 py-3 text-sm shadow-lg ring-1 ring-slate-900/10 transition duration-200 ease-out',
      'focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2',
      'dark:ring-white/10',
      'dark:focus-visible:ring-offset-slate-900',
      toastVariants[variant].toast
    ].join(' ');
    toast.classList.add('opacity-0');

    const textWrapper = document.createElement('div');
    textWrapper.className = 'flex-1 leading-snug';
    textWrapper.textContent = text;
    toast.appendChild(textWrapper);

    const closeBtn = document.createElement('button');
    closeBtn.type = 'button';
    closeBtn.setAttribute('aria-label', 'Fechar notificação');
    closeBtn.className = [
      'flex h-7 w-7 flex-none items-center justify-center rounded-full text-base transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2',
      toastVariants[variant].close
    ].join(' ');
    closeBtn.innerHTML = '<span aria-hidden="true">&times;</span>';
    toast.appendChild(closeBtn);

    toastContainer.appendChild(toast);

    const removeToast = () => {
      if (!toast.isConnected) return;
      if (hideTimer) {
        window.clearTimeout(hideTimer);
        hideTimer = null;
      }
      let fallbackTimer = null;
      const handleTransitionEnd = () => {
        toast.removeEventListener('transitionend', handleTransitionEnd);
        if (fallbackTimer) {
          window.clearTimeout(fallbackTimer);
          fallbackTimer = null;
        }
        if (toast.parentElement) toast.parentElement.removeChild(toast);
        if (returnFocusTo && returnFocusTo.isConnected) {
          try {
            returnFocusTo.focus({ preventScroll: true });
          } catch (err) {
            returnFocusTo.focus();
          }
        }
      };
      const wasVisible = toast.classList.contains('opacity-100');
      toast.classList.remove('opacity-100');
      toast.classList.add('opacity-0');
      if (!wasVisible) {
        handleTransitionEnd();
        return;
      }
      fallbackTimer = window.setTimeout(handleTransitionEnd, 250);
      toast.addEventListener('transitionend', handleTransitionEnd);
    };

    let hideTimer = null;
    const durationMs = Number(duration);
    if (!Number.isNaN(durationMs) && durationMs > 0) {
      hideTimer = window.setTimeout(() => removeToast(), durationMs);
    }

    closeBtn.addEventListener('click', () => {
      if (hideTimer) window.clearTimeout(hideTimer);
      removeToast();
    });

    toast.addEventListener('keydown', event => {
      if (event.key === 'Escape' || event.key === 'Esc') {
        event.preventDefault();
        if (hideTimer) window.clearTimeout(hideTimer);
        removeToast();
      }
    });

    requestAnimationFrame(() => {
      toast.classList.remove('opacity-0');
      toast.classList.add('opacity-100');
      try {
        toast.focus({ preventScroll: true });
      } catch (err) {
        toast.focus();
      }
    });
  }

  const nextLevelTextEl = $('#nextLevelText');
  const nextLevelPctEl = $('#nextLevelPct');
  const nextLevelBarEl = $('#nextLevelBar');
  const milestoneWrap = $('#milestoneWrap');
  const levelCardEl = $('#levelCard');
  const levelBadgeEl = $('#levelBadge');
  const achievementsCardEl = $('#achievementsCard');
  const achievementsSummaryEl = $('#achievementsSummary');
  const achievementsUnlockedWrap = $('#achievementsUnlocked');
  const achievementsUnlockedEmpty = $('#achievementsUnlockedEmpty');
  const achievementsUpcomingWrap = $('#achievementsUpcoming');
  const achievementsUpcomingEmpty = $('#achievementsUpcomingEmpty');
  const achievementsLoadingEl = $('#achievementsLoading');
  const achievementsErrorEl = $('#achievementsError');
  const achievementsContentEl = $('#achievementsContent');
  const checkinStreakInfoEl = $('#checkinStreakInfo');

  function resetLevelIndicator() {
    if (nextLevelTextEl) nextLevelTextEl.textContent = 'Faça login para acompanhar seus marcos.';
    if (nextLevelPctEl) nextLevelPctEl.textContent = '0% do nível atual';
    if (nextLevelBarEl) nextLevelBarEl.style.width = '0%';
    if (milestoneWrap) milestoneWrap.innerHTML = '';
    if (levelCardEl) levelCardEl.classList.remove('milestone-celebrate');
    if (levelBadgeEl) {
      levelBadgeEl.classList.add('hidden');
      levelBadgeEl.textContent = '';
    }
  }

  function setLevelIndicatorLoading() {
    if (nextLevelTextEl) nextLevelTextEl.textContent = 'Calculando progresso de nível...';
    if (nextLevelPctEl) nextLevelPctEl.textContent = '...';
    if (nextLevelBarEl) nextLevelBarEl.style.width = '0%';
    if (milestoneWrap) milestoneWrap.innerHTML = '';
    if (levelCardEl) levelCardEl.classList.remove('milestone-celebrate');
    if (levelBadgeEl) {
      levelBadgeEl.classList.add('hidden');
      levelBadgeEl.textContent = '';
    }
  }

  function renderMilestoneBadges(level, nextLevel) {
    if (!milestoneWrap) return;
    milestoneWrap.innerHTML = '';
    const step = 5;
    const minMilestones = 3;
    const safeLevel = Number.isFinite(level) ? level : 0;
    const safeNext = Number.isFinite(nextLevel) ? nextLevel : safeLevel + 1;
    const target = Math.max(safeLevel, safeNext);
    const highest = Math.max(step * minMilestones, Math.ceil((target + step) / step) * step);
    let nextHighlighted = false;
    for (let milestone = step; milestone <= highest; milestone += step) {
      const chip = document.createElement('span');
      chip.className = 'milestone-chip';
      if (milestone <= safeLevel) {
        const icon = milestone % 10 === 0 ? '🌟' : '🏆';
        chip.classList.add('milestone-chip-achieved');
        chip.innerHTML = `<span>${icon}</span><span>Nível ${milestone}</span>`;
      } else if (!nextHighlighted) {
        nextHighlighted = true;
        const icon = milestone % 10 === 0 ? '🚀' : '🎯';
        const label = milestone % 10 === 0 ? `Rumo ao ${milestone}` : `Meta: ${milestone}`;
        chip.classList.add('milestone-chip-next');
        chip.innerHTML = `<span>${icon}</span><span>${label}</span>`;
      } else {
        chip.innerHTML = `<span>Nível ${milestone}</span>`;
      }
      milestoneWrap.appendChild(chip);
    }
    if (!milestoneWrap.children.length) {
      const span = document.createElement('span');
      span.className = 'text-xs text-slate-500 dark:text-slate-300';
      span.textContent = 'Conquiste níveis para desbloquear marcos!';
      milestoneWrap.appendChild(span);
    }
  }

  function formatNumber(value) {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) return value;
    try {
      return new Intl.NumberFormat('pt-BR').format(numeric);
    } catch (err) {
      return numeric.toString();
    }
  }

  function formatAchievementDate(value) {
    const parsed = parseDateValue(value);
    if (!parsed) return 'agora mesmo';
    try {
      return new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }).format(parsed);
    } catch (err) {
      return parsed.toLocaleDateString('pt-BR');
    }
  }

  function getAchievementTimestamp(value) {
    if (!value) return 0;
    const parsed = parseDateValue(value);
    if (parsed) return parsed.getTime();
    const date = new Date(value);
    const time = date.getTime();
    return Number.isNaN(time) ? 0 : time;
  }

  function normalizeAchievementsResponse(data) {
    if (!data || typeof data !== 'object') {
      return {
        achievements: [],
        summary: { total: 0, unlocked: 0 },
        metrics: {}
      };
    }
    const achievements = Array.isArray(data.achievements)
      ? data.achievements.map(item => ({
          id: item?.id || '',
          title: item?.title || '',
          description: item?.description || '',
          category: item?.category || '',
          icon: item?.icon || '',
          rewardXP: Number(item?.rewardXP || 0),
          unlocked: !!item?.unlocked,
          achieved: !!item?.achieved,
          unlockedAt: item?.unlockedAt ? String(item.unlockedAt) : '',
          target: Number(item?.target || 0),
          progressValue: Number(item?.progressValue || item?.progress || 0),
          progress: Number(item?.progress || item?.progressValue || 0),
          progressPct: Math.max(0, Math.min(100, Number(item?.progressPct || 0))),
          progressLabel: item?.progressLabel || '',
          readyToUnlock: !!item?.readyToUnlock,
          extra: item?.extra || {}
        }))
      : [];
    const summary = {
      total: Number(data.summary?.total || achievements.length || 0),
      unlocked: Number(data.summary?.unlocked || achievements.filter(a => a.unlocked).length || 0)
    };
    const metrics = data.metrics && typeof data.metrics === 'object' ? data.metrics : {};
    return { achievements, summary, metrics };
  }

  function createUnlockedAchievementBadge(item) {
    const badge = document.createElement('div');
    badge.className = 'achievement-card achievement-card-unlocked';
    const icon = item?.icon || '🏆';
    const reward = Number(item?.rewardXP || 0);
    const rewardLabel = reward > 0 ? `+${formatNumber(reward)} XP` : 'Badge';
    const unlockedLabel = item?.unlockedAt ? formatAchievementDate(item.unlockedAt) : 'agora mesmo';
    badge.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <span class="achievement-icon">${icon}</span>
        <span class="achievement-xp">${rewardLabel}</span>
      </div>
      <div class="text-sm font-semibold leading-snug mb-1">${item?.title || 'Conquista desbloqueada'}</div>
      <p class="text-xs leading-relaxed opacity-80">${item?.description || 'Continue participando para acumular ainda mais.'}</p>
      <div class="text-[0.65rem] uppercase tracking-wide mt-3 opacity-70">Desbloqueada em ${unlockedLabel}</div>
    `;
    return badge;
  }

  function createUpcomingAchievementCard(item) {
    const card = document.createElement('div');
    const classes = ['achievement-card', 'achievement-card-locked'];
    if (item?.readyToUnlock) classes.push('achievement-card-ready');
    card.className = classes.join(' ');
    const icon = item?.icon || '🎯';
    const reward = Number(item?.rewardXP || 0);
    const rewardLabel = reward > 0 ? `+${formatNumber(reward)} XP` : 'Meta';
    const progressPct = Math.max(0, Math.min(100, Number(item?.progressPct || 0)));
    const progressLabel = item?.progressLabel || '';
    const encouragement = item?.readyToUnlock
      ? 'Pronto! Realize a próxima ação para conquistar.'
      : 'Continue acumulando progresso para desbloquear.';
    card.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <span class="achievement-icon">${icon}</span>
        <span class="achievement-xp">${rewardLabel}</span>
      </div>
      <div class="text-sm font-semibold leading-snug mb-1">${item?.title || 'Próxima meta'}</div>
      <p class="text-xs leading-relaxed opacity-80 mb-3">${item?.description || ''}</p>
      <div class="space-y-1">
        <div class="flex items-center justify-between text-[0.65rem] uppercase tracking-wide opacity-75">
          <span>${progressLabel}</span>
          <span>${progressPct}%</span>
        </div>
        <div class="achievement-progress-track">
          <div class="achievement-progress-bar" style="width:${progressPct}%"></div>
        </div>
      </div>
      <div class="text-[0.65rem] mt-3 opacity-70">${encouragement}</div>
    `;
    return card;
  }

  function updateCheckinStreakInfo(metrics) {
    if (!checkinStreakInfoEl) return;
    if (!currentUser) {
      checkinStreakInfoEl.textContent = 'Faça login para iniciar sua sequência de check-ins.';
      checkinStreakInfoEl.classList.remove('text-emerald-600', 'dark:text-emerald-300', 'font-semibold');
      checkinStreakInfoEl.classList.add('text-slate-500', 'dark:text-slate-300');
      return;
    }
    const current = Number(metrics?.checkinCurrentStreak || metrics?.current || 0);
    const best = Number(metrics?.checkinBestStreak || metrics?.best || 0);
    const total = Number(metrics?.totalCheckins || metrics?.total || 0);
    if (!current && !best && !total) {
      checkinStreakInfoEl.textContent = 'Registre seu primeiro check-in para iniciar uma sequência!';
      checkinStreakInfoEl.classList.remove('text-emerald-600', 'dark:text-emerald-300', 'font-semibold');
      checkinStreakInfoEl.classList.add('text-slate-500', 'dark:text-slate-300');
      return;
    }
    const parts = [];
    if (current > 0) {
      parts.push(`🔥 Streak atual: ${current} dia${current > 1 ? 's' : ''}`);
    } else {
      parts.push('Sem streak ativo no momento.');
    }
    if (best > 0) {
      parts.push(`Recorde: ${best} dia${best > 1 ? 's' : ''}`);
    }
    if (total > 0) {
      parts.push(`${total} check-in${total > 1 ? 's' : ''} no total`);
    }
    checkinStreakInfoEl.textContent = parts.join(' • ');
    const highlight = current >= 3;
    if (highlight) {
      checkinStreakInfoEl.classList.add('text-emerald-600', 'dark:text-emerald-300', 'font-semibold');
      checkinStreakInfoEl.classList.remove('text-slate-500', 'dark:text-slate-300');
    } else {
      checkinStreakInfoEl.classList.remove('text-emerald-600', 'dark:text-emerald-300', 'font-semibold');
      checkinStreakInfoEl.classList.add('text-slate-500', 'dark:text-slate-300');
    }
  }

  function renderAchievements() {
    renderAchievementsShowcase(achievementsState.summary, achievementsState.metrics);
    if (!achievementsCardEl) return;

    if (!currentUser) {
      if (achievementsSummaryEl) {
        achievementsSummaryEl.textContent = 'Faça login para acompanhar suas conquistas.';
      }
      if (achievementsContentEl) achievementsContentEl.classList.add('hidden');
      if (achievementsLoadingEl) achievementsLoadingEl.classList.add('hidden');
      if (achievementsErrorEl) achievementsErrorEl.classList.add('hidden');
      if (achievementsUnlockedWrap) achievementsUnlockedWrap.innerHTML = '';
      if (achievementsUpcomingWrap) achievementsUpcomingWrap.innerHTML = '';
      if (achievementsUnlockedEmpty) achievementsUnlockedEmpty.classList.remove('hidden');
      if (achievementsUpcomingEmpty) achievementsUpcomingEmpty.classList.remove('hidden');
      updateCheckinStreakInfo(null);
      return;
    }

    const { loading, error, achievements, summary, metrics } = achievementsState;
    if (achievementsLoadingEl) achievementsLoadingEl.classList.toggle('hidden', !loading);
    if (achievementsErrorEl) {
      achievementsErrorEl.textContent = error || '';
      achievementsErrorEl.classList.toggle('hidden', !error);
    }
    const canShowContent = !loading && !error;
    if (achievementsContentEl) achievementsContentEl.classList.toggle('hidden', !canShowContent);

    const total = Number(summary?.total || achievements.length || 0);
    const unlockedCount = Number(summary?.unlocked || achievements.filter(item => item.unlocked).length || 0);
    if (achievementsSummaryEl) {
      achievementsSummaryEl.textContent = total > 0
        ? `${unlockedCount}/${total} desbloqueadas`
        : 'Nenhuma conquista cadastrada ainda.';
    }

    updateCheckinStreakInfo(metrics);

    if (!canShowContent) {
      if (achievementsUnlockedWrap) achievementsUnlockedWrap.innerHTML = '';
      if (achievementsUpcomingWrap) achievementsUpcomingWrap.innerHTML = '';
      if (achievementsUnlockedEmpty) achievementsUnlockedEmpty.classList.toggle('hidden', !!loading || !!error);
      if (achievementsUpcomingEmpty) achievementsUpcomingEmpty.classList.toggle('hidden', !!loading || !!error);
      return;
    }

    const unlocked = achievements
      .filter(item => item.unlocked)
      .sort((a, b) => getAchievementTimestamp(b.unlockedAt) - getAchievementTimestamp(a.unlockedAt));
    const upcoming = achievements
      .filter(item => !item.unlocked)
      .sort((a, b) => Number(b.progressPct || 0) - Number(a.progressPct || 0));
    const upcomingLimited = upcoming.slice(0, 6);

    if (achievementsUnlockedWrap) {
      achievementsUnlockedWrap.innerHTML = '';
      unlocked.forEach(item => achievementsUnlockedWrap.appendChild(createUnlockedAchievementBadge(item)));
      achievementsUnlockedWrap.classList.toggle('hidden', unlocked.length === 0);
    }
    if (achievementsUnlockedEmpty) {
      achievementsUnlockedEmpty.textContent = unlocked.length > 0
        ? ''
        : 'Ainda sem conquistas desbloqueadas. Faça check-ins e conclua atividades para começar!';
      achievementsUnlockedEmpty.classList.toggle('hidden', unlocked.length > 0);
    }

    if (achievementsUpcomingWrap) {
      achievementsUpcomingWrap.innerHTML = '';
      upcomingLimited.forEach(item => achievementsUpcomingWrap.appendChild(createUpcomingAchievementCard(item)));
      achievementsUpcomingWrap.classList.toggle('hidden', upcomingLimited.length === 0);
    }
    if (achievementsUpcomingEmpty) {
      let message = 'Participe de check-ins e atividades para liberar novas medalhas.';
      if (!upcomingLimited.length && achievements.length > 0) {
        message = 'Todas as conquistas disponíveis foram desbloqueadas! 🎉';
      }
      achievementsUpcomingEmpty.textContent = message;
      achievementsUpcomingEmpty.classList.toggle('hidden', upcomingLimited.length > 0);
    }
  }

  function handleAchievementToasts(list) {
    if (!Array.isArray(list) || !list.length) return;
    list.forEach(item => {
      const icon = item?.icon || '🏆';
      const reward = Number(item?.rewardXP || 0);
      const rewardText = reward > 0 ? ` +${formatNumber(reward)} XP` : '';
      const title = item?.title || 'Nova conquista';
      showToast({ message: `${icon} Conquista desbloqueada: ${title}!${rewardText}`, type: 'success' });
    });
  }

  function applyAchievementsUpdate(overview, unlockedList = [], options = {}) {
    if (!overview) return;
    const normalized = normalizeAchievementsResponse(overview);
    achievementsState.loading = false;
    achievementsState.error = '';
    achievementsState.achievements = normalized.achievements;
    achievementsState.summary = normalized.summary;
    achievementsState.metrics = normalized.metrics || {};
    renderAchievements();
    const summaryInfo = normalized.summary || { total: 0, unlocked: 0 };
    updateStudentStoryState({
      achievementsUnlocked: summaryInfo.unlocked || 0,
      totalAchievements: summaryInfo.total || 0,
      metrics: normalized.metrics || {}
    });
    if (!options?.silent && Array.isArray(unlockedList) && unlockedList.length) {
      handleAchievementToasts(unlockedList);
    }
  }

  function resetAchievementsUI() {
    achievementsState.loading = false;
    achievementsState.error = '';
    achievementsState.achievements = [];
    achievementsState.summary = { total: 0, unlocked: 0 };
    achievementsState.metrics = {};
    renderAchievements();
    updateStudentStoryState({ achievementsUnlocked: 0, totalAchievements: 0, metrics: {} });
  }

  function loadAchievementsOverview() {
    if (!currentUser || !currentUser.id) {
      resetAchievementsUI();
      return;
    }
    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      return;
    }
    const expectedUserId = currentUser.id;
    achievementsState.loading = true;
    achievementsState.error = '';
    renderAchievements();
    google.script.run
      .withFailureHandler(err => {
        if (handleSessionExpiredError(err, {
          onHandled: () => {
            achievementsState.loading = false;
            achievementsState.error = '';
            achievementsState.metrics = {};
            renderAchievements();
          }
        })) {
          return;
        }
        if (!currentUser || currentUser.id !== expectedUserId) return;
        achievementsState.loading = false;
        achievementsState.error = err?.message || 'Não foi possível carregar as conquistas.';
        achievementsState.metrics = {};
        renderAchievements();
      })
      .withSuccessHandler(data => {
        if (!currentUser || currentUser.id !== expectedUserId) return;
        const normalized = normalizeAchievementsResponse(data);
        achievementsState.loading = false;
        achievementsState.error = '';
        achievementsState.achievements = normalized.achievements;
        achievementsState.summary = normalized.summary;
        achievementsState.metrics = normalized.metrics || {};
        renderAchievements();
      })
      .getUserAchievementsOverview({ token, userId: currentUser.id });
  }

  function updateLevelIndicator(state) {
    if (!state) return;
    const levelValue = Number(state.level || 1);
    const nextLevelValue = Number.isFinite(Number(state.nextLevel)) ? Number(state.nextLevel) : levelValue + 1;
    const xpPerLevelRaw = Number(state.xpPerLevel);
    const xpPerLevel = Number.isFinite(xpPerLevelRaw) && xpPerLevelRaw > 0 ? xpPerLevelRaw : null;
    const xpToNextRaw = Number(state.xpToNextLevel);
    const xpToNext = Number.isFinite(xpToNextRaw) ? Math.max(0, Math.round(xpToNextRaw)) : null;
    const xpIntoLevel = xpPerLevel !== null && xpToNext !== null ? Math.max(0, xpPerLevel - xpToNext) : 0;
    const pct = xpPerLevel !== null && xpPerLevel > 0 && xpToNext !== null
      ? Math.round((xpIntoLevel / xpPerLevel) * 100)
      : 0;
    const pctClamped = Math.max(0, Math.min(100, pct));

    if (nextLevelTextEl) {
      if (xpToNext === null) {
        nextLevelTextEl.textContent = 'Progresso de nível indisponível no momento.';
      } else if (xpToNext === 0) {
        nextLevelTextEl.textContent = `Pronto para alcançar o nível ${nextLevelValue}!`;
      } else {
        const xpLabel = xpToNext === 1 ? 'Falta 1 XP' : `Faltam ${xpToNext} XP`;
        nextLevelTextEl.textContent = `${xpLabel} para o nível ${nextLevelValue}`;
      }
    }
    if (nextLevelPctEl) {
      nextLevelPctEl.textContent = `${pctClamped}% do nível atual`;
    }
    if (nextLevelBarEl) {
      nextLevelBarEl.style.width = `${pctClamped}%`;
    }

    if (levelCardEl) {
      const isMilestone = levelValue > 0 && levelValue % 5 === 0;
      levelCardEl.classList.toggle('milestone-celebrate', isMilestone);
    }
    if (levelBadgeEl) {
      const isMilestone = levelValue > 0 && levelValue % 5 === 0;
      if (isMilestone) {
        const isEpic = levelValue % 10 === 0;
        levelBadgeEl.classList.remove('hidden');
        levelBadgeEl.textContent = isEpic ? '🌟 Nível épico!' : '🏆 Marco!';
      } else {
        levelBadgeEl.classList.add('hidden');
        levelBadgeEl.textContent = '';
      }
    }

    renderMilestoneBadges(levelValue, nextLevelValue);
  }

  function formatLevelProgressMessage(info) {
    if (!info) return '';
    const xpToNextRaw = Number(info.xpToNextLevel ?? info.remainingXP);
    const nextLevelRaw = Number(info.nextLevel);
    const levelRaw = Number(info.level);
    const nextLevelValue = Number.isFinite(nextLevelRaw)
      ? nextLevelRaw
      : (Number.isFinite(levelRaw) ? levelRaw + 1 : null);
    if (!Number.isFinite(xpToNextRaw) || xpToNextRaw < 0 || !Number.isFinite(nextLevelValue)) {
      return '';
    }
    const xpToNext = Math.max(0, Math.round(xpToNextRaw));
    if (xpToNext === 0) {
      return ` Você está pronto(a) para alcançar o nível ${nextLevelValue}!`;
    }
    const xpLabel = xpToNext === 1 ? 'Falta 1 XP' : `Faltam ${xpToNext} XP`;
    return ` ${xpLabel} para o nível ${nextLevelValue}.`;
  }

  resetLevelIndicator();

  const historyTabs = Array.from(document.querySelectorAll('[data-history-tab]'));
  const historyListEl = $('#historyList');
  const historyPeriodSelect = $('#historyPeriodFilter');
  const historyModuleSelect = $('#historyModuleFilter');
  const historyModuleWrap = $('#historyModuleFilterWrap');
  const historyStreakWrap = $('#historyStreakWrap');
  const historyStreakCurrent = $('#historyStreakCurrent');
  const historyStreakBest = $('#historyStreakBest');
  const MS_PER_DAY = 24 * 60 * 60 * 1000;

  const historyState = {
    checkins: [],
    activities: [],
    streak: { current: 0, best: 0 },
    loading: { checkins: false, activities: false },
    errors: { checkins: '', activities: '' }
  };
  let activeHistoryTab = 'checkins';

  historyTabs.forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.getAttribute('data-history-tab') || 'checkins';
      if (tab === activeHistoryTab) return;
      activeHistoryTab = tab;
      historyTabs.forEach(btn => {
        const btnTab = btn.getAttribute('data-history-tab');
        btn.classList.toggle('history-tab-active', btnTab === activeHistoryTab);
      });
      renderHistory();
    });
  });

  if (historyPeriodSelect) {
    historyPeriodSelect.addEventListener('change', () => renderHistory());
  }

  if (historyModuleSelect) {
    historyModuleSelect.addEventListener('change', () => renderHistory());
  }

  function resetHistorySection() {
    historyState.checkins = [];
    historyState.activities = [];
    historyState.streak = { current: 0, best: 0 };
    historyState.loading.checkins = false;
    historyState.loading.activities = false;
    historyState.errors.checkins = '';
    historyState.errors.activities = '';
    activeHistoryTab = 'checkins';
    if (historyPeriodSelect) historyPeriodSelect.value = '30';
    if (historyModuleSelect) historyModuleSelect.value = 'all';
    historyTabs.forEach(btn => {
      const tab = btn.getAttribute('data-history-tab');
      btn.classList.toggle('history-tab-active', tab === activeHistoryTab);
    });
    updateHistoryModuleFilterOptions();
    renderHistory();
  }

  function renderHistory() {
    if (!historyListEl) return;
    if (!currentUser) {
      historyListEl.innerHTML = '<p class="history-empty">Faça login para acompanhar seu histórico.</p>';
      if (historyModuleWrap) historyModuleWrap.classList.add('hidden');
      if (historyStreakWrap) historyStreakWrap.classList.add('hidden');
      return;
    }

    if (historyModuleWrap) {
      historyModuleWrap.classList.toggle('hidden', activeHistoryTab !== 'activities');
    }

    const stateKey = activeHistoryTab === 'activities' ? 'activities' : 'checkins';
    const isLoading = historyState.loading[stateKey];
    const errorMessage = historyState.errors[stateKey];
    const periodValue = historyPeriodSelect ? historyPeriodSelect.value : 'all';
    const moduleValue = historyModuleSelect ? historyModuleSelect.value : 'all';

    if (activeHistoryTab !== 'activities' && historyModuleWrap) {
      historyModuleWrap.classList.add('hidden');
    } else if (activeHistoryTab === 'activities') {
      updateHistoryModuleFilterOptions();
    }

    historyListEl.innerHTML = '';

    if (isLoading) {
      const loadingText = activeHistoryTab === 'activities' ? 'Carregando atividades...' : 'Carregando check-ins...';
      historyListEl.innerHTML = `<p class="history-empty">${loadingText}</p>`;
      renderStreakInfo();
      return;
    }

    if (errorMessage) {
      historyListEl.innerHTML = `<p class="history-empty text-rose-600 dark:text-rose-300">${errorMessage}</p>`;
      renderStreakInfo();
      return;
    }

    let items = (historyState[stateKey] || []).slice();

    if (periodValue !== 'all') {
      const days = Number(periodValue);
      if (!Number.isNaN(days) && days > 0) {
        const now = Date.now();
        items = items.filter(item => {
          const ts = getItemTimestamp(item);
          if (!Number.isFinite(ts)) return false;
          const diffDays = Math.floor((now - ts) / MS_PER_DAY);
          return diffDays < days;
        });
      }
    }

    if (activeHistoryTab === 'activities' && moduleValue !== 'all') {
      items = items.filter(item => String(item.moduleId || '') === moduleValue);
    }

    items.sort((a, b) => {
      const aTime = getItemTimestamp(a);
      const bTime = getItemTimestamp(b);
      return (Number.isFinite(bTime) ? bTime : -Infinity) - (Number.isFinite(aTime) ? aTime : -Infinity);
    });

    if (!items.length) {
      const emptyText = activeHistoryTab === 'activities'
        ? 'Nenhuma atividade registrada para os filtros selecionados.'
        : 'Ainda não há check-ins no período selecionado. Registre sua presença para começar um streak!';
      historyListEl.innerHTML = `<p class="history-empty">${emptyText}</p>`;
      renderStreakInfo();
      return;
    }

    items.forEach(item => {
      historyListEl.appendChild(
        activeHistoryTab === 'activities' ? renderActivityItem(item) : renderCheckinItem(item)
      );
    });

    renderStreakInfo();
  }

  function renderStreakInfo() {
    if (!historyStreakWrap) return;
    if (activeHistoryTab !== 'checkins' || historyState.loading.checkins || historyState.errors.checkins || !currentUser) {
      historyStreakWrap.classList.add('hidden');
      return;
    }
    if (!historyState.checkins.length) {
      historyStreakWrap.classList.add('hidden');
      return;
    }

    const { current, best } = historyState.streak;
    historyStreakWrap.classList.remove('hidden');

    if (historyStreakCurrent) {
      historyStreakCurrent.textContent = current > 0
        ? `🔥 Streak atual: ${current} dia${current > 1 ? 's' : ''}`
        : 'Sem streak ativo';
      historyStreakCurrent.classList.toggle('bg-emerald-100', current >= 3);
      historyStreakCurrent.classList.toggle('text-emerald-700', current >= 3);
      historyStreakCurrent.classList.toggle('dark:bg-emerald-500/10', current >= 3);
      historyStreakCurrent.classList.toggle('dark:text-emerald-300', current >= 3);
    }

    if (historyStreakBest) {
      historyStreakBest.textContent = best > 0
        ? `Recorde: ${best} dia${best > 1 ? 's' : ''}`
        : '';
      historyStreakBest.classList.toggle('hidden', best <= 0);
    }
  }

  function getItemTimestamp(item) {
    if (!item) return NaN;
    if (typeof item.timestamp === 'number' && !Number.isNaN(item.timestamp)) return item.timestamp;
    const parsed = parseDateValue(item.date || item.day);
    return parsed ? parsed.getTime() : NaN;
  }

  function parseDateValue(value) {
    if (!value) return null;
    if (value instanceof Date) return value;
    const str = String(value).trim();
    if (!str) return null;
    const normalized = str.length === 10 ? `${str}T00:00:00Z` : str;
    const date = new Date(normalized);
    return Number.isNaN(date.getTime()) ? null : date;
  }

  function formatHistoryDate(item) {
    const ts = getItemTimestamp(item);
    if (!Number.isFinite(ts)) {
      const day = item && item.day ? String(item.day) : '';
      return day ? day.split('-').reverse().join('/') : 'Data indisponível';
    }
    try {
      return new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }).format(new Date(ts));
    } catch (err) {
      return new Date(ts).toLocaleDateString('pt-BR');
    }
  }

  function renderCheckinItem(item) {
    const element = document.createElement('div');
    element.className = 'flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-200 dark:border-slate-700/70 bg-white dark:bg-slate-900/60 px-4 py-3';
    const xpValue = Number(item?.xp || 0);
    element.innerHTML = `
      <div class="flex-1">
        <div class="font-semibold">${formatHistoryDate(item)}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">Check-in diário</div>
      </div>
      <div class="text-sm font-semibold text-emerald-600 dark:text-emerald-400">+${xpValue} XP</div>
    `;
    return element;
  }

  function renderActivityItem(item) {
    const element = document.createElement('div');
    element.className = 'flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-200 dark:border-slate-700/70 bg-white dark:bg-slate-900/60 px-4 py-3';
    const moduleLabel = Number.isFinite(item?.moduleId) && item.moduleId > 0 ? `Módulo ${item.moduleId}` : 'Atividade';
    const xpValue = Number(item?.earnedXP || 0);
    const scoreValue = Number(item?.scorePct || 0);
    const progressValue = Number(item?.progressPct || 0);
    element.innerHTML = `
      <div class="flex-1">
        <div class="font-semibold">${moduleLabel}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">${formatHistoryDate(item)}</div>
      </div>
      <div class="flex flex-col items-end gap-1 text-xs text-slate-500 dark:text-slate-400">
        <span class="text-sm font-semibold text-primary dark:text-blue-400">+${xpValue} XP</span>
        <span>Nota: ${scoreValue}%</span>
        <span>Evolução: ${progressValue}% do curso</span>
      </div>
    `;
    return element;
  }

  function updateHistoryModuleFilterOptions() {
    if (!historyModuleSelect) return;
    const previousValue = historyModuleSelect.value;
    historyModuleSelect.innerHTML = '';

    const optionAll = document.createElement('option');
    optionAll.value = 'all';
    optionAll.textContent = 'Todos os módulos';
    historyModuleSelect.appendChild(optionAll);

    const modules = Array.from(new Set(historyState.activities
      .map(item => Number(item?.moduleId || 0))
      .filter(id => Number.isFinite(id) && id > 0)))
      .sort((a, b) => a - b);

    modules.forEach(id => {
      const opt = document.createElement('option');
      opt.value = String(id);
      opt.textContent = `Módulo ${id}`;
      historyModuleSelect.appendChild(opt);
    });

    if (modules.includes(Number(previousValue))) {
      historyModuleSelect.value = previousValue;
    } else {
      historyModuleSelect.value = 'all';
    }

    if (historyModuleWrap) {
      historyModuleWrap.classList.toggle('hidden', activeHistoryTab !== 'activities' || modules.length === 0);
    }
  }

  function computeCheckinStreak(items) {
    if (!Array.isArray(items) || !items.length) return { current: 0, best: 0 };
    const timestamps = Array.from(new Set(items
      .map(entry => getItemTimestamp(entry))
      .filter(ts => Number.isFinite(ts)))).sort((a, b) => a - b);
    if (!timestamps.length) return { current: 0, best: 0 };

    let best = 1;
    let streak = 1;
    for (let i = 1; i < timestamps.length; i++) {
      const diffDays = Math.round((timestamps[i] - timestamps[i - 1]) / MS_PER_DAY);
      if (diffDays === 0) {
        continue;
      } else if (diffDays === 1) {
        streak += 1;
      } else {
        if (streak > best) best = streak;
        streak = 1;
      }
    }
    if (streak > best) best = streak;

    const desc = timestamps.slice().sort((a, b) => b - a);
    let current = 0;
    let previous = null;
    for (let i = 0; i < desc.length; i++) {
      const ts = desc[i];
      if (i === 0) {
        current = 1;
        previous = ts;
        continue;
      }
      const diffDays = Math.round((previous - ts) / MS_PER_DAY);
      if (diffDays === 0) {
        continue;
      }
      if (diffDays === 1) {
        current += 1;
        previous = ts;
      } else {
        break;
      }
    }

    return { current, best };
  }

  function normalizeCheckinHistory(data) {
    if (!Array.isArray(data)) return [];
    return data.map(item => {
      const day = item?.day ? String(item.day) : '';
      const date = item?.date ? String(item.date) : '';
      const parsed = parseDateValue(date || day);
      const timestamp = parsed ? parsed.getTime() : (typeof item?.timestamp === 'number' && !Number.isNaN(item.timestamp) ? item.timestamp : null);
      return {
        day,
        date,
        xp: Number(item?.xp || 0),
        timestamp: Number.isFinite(timestamp) ? timestamp : null
      };
    });
  }

  function normalizeActivityHistory(data) {
    if (!Array.isArray(data)) return [];
    return data.map(item => {
      const day = item?.day ? String(item.day) : '';
      const date = item?.date ? String(item.date) : '';
      const parsed = parseDateValue(date || day);
      const timestampCandidate = typeof item?.timestamp === 'number' && !Number.isNaN(item.timestamp)
        ? item.timestamp
        : (parsed ? parsed.getTime() : null);
      return {
        moduleId: Number(item?.moduleId || item?.module || 0),
        earnedXP: Number(item?.earnedXP || item?.xp || 0),
        scorePct: Math.round(Number(item?.scorePct || item?.score || 0)),
        progressPct: Math.max(0, Math.min(100, Math.round(Number(item?.progressPct || item?.progress || 0)))),
        day,
        date,
        timestamp: Number.isFinite(timestampCandidate) ? timestampCandidate : null
      };
    });
  }

  function loadHistoryForCurrentUser() {
    if (!currentUser || !currentUser.id) return;

    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      return;
    }

    const expectedUserId = currentUser.id;
    historyState.loading.checkins = true;
    historyState.errors.checkins = '';
    historyState.loading.activities = true;
    historyState.errors.activities = '';
    renderHistory();

    google.script.run
      .withFailureHandler(err => {
        if (handleSessionExpiredError(err, {
          onHandled: message => {
            historyState.loading.checkins = false;
            historyState.errors.checkins = message;
            historyState.checkins = [];
            historyState.streak = { current: 0, best: 0 };
            renderHistory();
          }
        })) {
          return;
        }
        if (!currentUser || currentUser.id !== expectedUserId) return;
        historyState.loading.checkins = false;
        historyState.errors.checkins = err?.message || 'Não foi possível carregar o histórico de check-ins.';
        historyState.checkins = [];
        historyState.streak = { current: 0, best: 0 };
        renderHistory();
      })
      .withSuccessHandler(data => {
        if (!currentUser || currentUser.id !== expectedUserId) return;
        historyState.loading.checkins = false;
        historyState.checkins = normalizeCheckinHistory(data);
        historyState.streak = computeCheckinStreak(historyState.checkins);
        historyState.errors.checkins = '';
        updateCheckinStreakInfo({
          checkinCurrentStreak: historyState.streak.current,
          checkinBestStreak: historyState.streak.best,
          totalCheckins: historyState.checkins.length
        });
        updateStudentStoryState({
          checkinToday: hasCheckinToday(),
          metrics: {
            checkinCurrentStreak: historyState.streak.current,
            checkinBestStreak: historyState.streak.best,
            totalCheckins: historyState.checkins.length
          }
        });
        renderHistory();
      })
      .getCheckinHistory({ token, userId: currentUser.id });

    google.script.run
      .withFailureHandler(err => {
        if (handleSessionExpiredError(err, {
          onHandled: message => {
            historyState.loading.activities = false;
            historyState.errors.activities = message;
            historyState.activities = [];
            updateHistoryModuleFilterOptions();
            renderHistory();
          }
        })) {
          return;
        }
        if (!currentUser || currentUser.id !== expectedUserId) return;
        historyState.loading.activities = false;
        historyState.errors.activities = err?.message || 'Não foi possível carregar o histórico de atividades.';
        historyState.activities = [];
        updateHistoryModuleFilterOptions();
        renderHistory();
      })
      .withSuccessHandler(data => {
        if (!currentUser || currentUser.id !== expectedUserId) return;
        historyState.loading.activities = false;
        historyState.activities = normalizeActivityHistory(data);
        historyState.errors.activities = '';
        updateHistoryModuleFilterOptions();
        renderHistory();
      })
      .getActivityHistory({ token, userId: currentUser.id });
  }

  const signupMessageEl = $('#signupMsg');
  const loginMessageEl  = $('#loginMsg');

  if (btnGoogleAuth) {
    const googleButtonDefaultLabel = btnGoogleAuth.innerHTML;
    btnGoogleAuth.addEventListener('click', () => {
      if (btnGoogleAuth.disabled) return;
      clearCardMessage(loginMessageEl);
      btnGoogleAuth.disabled = true;
      btnGoogleAuth.setAttribute('aria-busy', 'true');
      btnGoogleAuth.innerHTML = 'Conectando...';
      google.script.run
        .withFailureHandler(err => {
          btnGoogleAuth.disabled = false;
          btnGoogleAuth.removeAttribute('aria-busy');
          btnGoogleAuth.innerHTML = googleButtonDefaultLabel;
          renderCardMessage(loginMessageEl, 'error', err?.message || 'Não foi possível conectar ao Google agora.');
        })
        .withSuccessHandler(profile => {
          btnGoogleAuth.disabled = false;
          btnGoogleAuth.removeAttribute('aria-busy');
          btnGoogleAuth.innerHTML = googleButtonDefaultLabel;
          const email = profile && profile.email ? profile.email.toString().trim() : '';
          if (email) {
            if (loginEmailInput) {
              loginEmailInput.value = email;
            }
            if (signupFields.email?.input) {
              signupFields.email.input.value = email;
              signupFields.email.touched = true;
              evaluateField('email', { force: true });
            }
            const sanitizedEmail = escapeHtml(email);
            renderCardMessage(loginMessageEl, 'success', `Identificamos o e-mail corporativo ${sanitizedEmail}. Informe sua senha para continuar.`);
          } else {
            renderCardMessage(loginMessageEl, 'error', 'Conexão realizada, mas não foi possível identificar o e-mail corporativo deste acesso.');
          }
        })
        .getActiveUserProfile();
    });
  }

  function renderCardMessage(el, type, message) {
    if (!el) return;
    const text = (message || '').toString();
    el.textContent = text;
    el.classList.remove('feedback-error', 'feedback-success');
    if (!text) {
      el.classList.add('hidden');
      return;
    }
    el.classList.remove('hidden');
    el.classList.add(type === 'success' ? 'feedback-success' : 'feedback-error');
  }

  function clearCardMessage(el) {
    renderCardMessage(el, '', '');
  }

  function resetConfirmationCountdown() {
    if (confirmationTimer) {
      clearInterval(confirmationTimer);
      confirmationTimer = null;
    }
    if (confirmationCountdownEl) confirmationCountdownEl.textContent = '';
  }

  function startConfirmationCountdown() {
    resetConfirmationCountdown();
    if (!pendingConfirmation || !pendingConfirmation.expiresAt || !confirmationCountdownEl) return;
    const expires = new Date(pendingConfirmation.expiresAt);
    if (Number.isNaN(expires.getTime())) return;
    const updateCountdown = () => {
      const remaining = expires.getTime() - Date.now();
      if (remaining <= 0) {
        confirmationCountdownEl.textContent = 'Código expirado — solicite um novo envio.';
        resetConfirmationCountdown();
        return;
      }
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      confirmationCountdownEl.textContent = `Código expira em ${minutes}m ${String(seconds).padStart(2, '0')}s`;
    };
    updateCountdown();
    confirmationTimer = setInterval(updateCountdown, 1000);
  }

  function showAuthView(mode = 'login') {
    const normalized = mode === 'signup' || mode === 'confirm' ? mode : 'login';
    currentAuthMode = normalized;
    if (loginCardEl) loginCardEl.classList.toggle('hidden', normalized !== 'login');
    if (signupCardEl) signupCardEl.classList.toggle('hidden', normalized !== 'signup');
    if (confirmCardEl) confirmCardEl.classList.toggle('hidden', normalized !== 'confirm');
    if (normalized !== 'confirm') {
      resetConfirmationCountdown();
      if (normalized === 'login') {
        pendingConfirmation = null;
      }
    } else {
      startConfirmationCountdown();
    }
    if (normalized === 'login' && loginEmailInput) {
      setTimeout(() => loginEmailInput.focus(), 60);
    } else if (normalized === 'signup' && signupFields.name.input) {
      setTimeout(() => signupFields.name.input.focus(), 60);
    } else if (normalized === 'confirm' && confirmCodeInput) {
      setTimeout(() => confirmCodeInput.focus(), 60);
    }
  }

  function openConfirmationView(confirmation, options = {}) {
    const remember = options && Object.prototype.hasOwnProperty.call(options, 'remember')
      ? !!options.remember
      : rememberPreference;
    rememberPreference = remember;
    if (rememberMeCheckbox) {
      rememberMeCheckbox.checked = rememberPreference;
    }
    pendingConfirmation = {
      email: confirmation && confirmation.email ? confirmation.email : (pendingConfirmation && pendingConfirmation.email) || '',
      userId: confirmation && confirmation.userId ? confirmation.userId : (pendingConfirmation && pendingConfirmation.userId) || '',
      expiresAt: confirmation && confirmation.expiresAt ? confirmation.expiresAt : (pendingConfirmation && pendingConfirmation.expiresAt) || '',
      remember
    };
    if (confirmEmailInput) confirmEmailInput.value = pendingConfirmation.email || '';
    if (confirmCodeInput) confirmCodeInput.value = '';
    clearCardMessage(confirmMsgEl);
    showAuthView('confirm');
  }

  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const requiredSignupKeys = ['name','email','password'];
  const signupFields = {
    name: {
      input: $('#rName'),
      error: $('#rNameError'),
      touched: false,
      customError: null,
      validator: value => {
        if (!value) return { valid:false, message:'Informe o nome completo.' };
        if (value.length < 3) return { valid:false, message:'O nome deve ter pelo menos 3 caracteres.' };
        return { valid:true, message:'' };
      }
    },
    email: {
      input: $('#rEmail'),
      error: $('#rEmailError'),
      touched: false,
      customError: null,
      validator: value => {
        if (!value) return { valid:false, message:'Informe o e-mail.' };
        if (!emailPattern.test(value)) return { valid:false, message:'Formato de e-mail inválido.' };
        return { valid:true, message:'' };
      }
    },
    password: {
      input: $('#rPass'),
      error: $('#rPassError'),
      touched: false,
      customError: null,
      validator: value => {
        const missing = [];
        if (value.length < 8) missing.push('no mínimo 8 caracteres');
        if (!/[A-Z]/.test(value)) missing.push('uma letra maiúscula');
        if (!/[a-z]/.test(value)) missing.push('uma letra minúscula');
        if (!/\d/.test(value)) missing.push('um número');
        if (!/[^A-Za-z0-9]/.test(value)) missing.push('um símbolo');
        if (missing.length) {
          const last = missing.pop();
          const message = missing.length ? `A senha deve conter ${missing.join(', ')} e ${last}.` : `A senha deve conter ${last}.`;
          return { valid:false, message };
        }
        return { valid:true, message:'' };
      }
    },
    adminCode: {
      input: $('#rAdminCode'),
      error: $('#rAdminCodeError'),
      touched: false,
      customError: null,
      validator: () => ({ valid:true, message:'' })
    }
  };

  const btnSignup = $('#btnSignup');
  const loginEmailInput = $('#lEmail');
  const loginPasswordInput = $('#lPass');
  const btnLogin = $('#btnLogin');
  let isSignupSubmitting = false;
  let isLoginSubmitting = false;
  let isConfirmSubmitting = false;

  function evaluateField(key, opts = {}) {
    const field = signupFields[key];
    if (!field || !field.input) return true;
    const rawValue = field.input.value || '';
    const value = rawValue.trim();
    const shouldShow = opts.force || field.touched || rawValue.length > 0;

    if (field.customError) {
      if (field.error) field.error.textContent = shouldShow ? field.customError : '';
      return false;
    }

    const result = field.validator(value, rawValue);
    if (field.error) field.error.textContent = shouldShow ? result.message : '';
    return !!result.valid;
  }

  function updateSignupButton() {
    const allValid = requiredSignupKeys.every(key => evaluateField(key));
    if (btnSignup) btnSignup.disabled = !allValid || isSignupSubmitting;
  }

  function updateLoginButton() {
    if (!btnLogin) return;
    btnLogin.disabled = !!isLoginSubmitting;
    btnLogin.textContent = isLoginSubmitting ? 'Entrando...' : 'Entrar';
  }

  function updateConfirmButton() {
    if (!btnConfirmSignup) return;
    btnConfirmSignup.disabled = !!isConfirmSubmitting;
    btnConfirmSignup.textContent = isConfirmSubmitting ? 'Confirmando...' : 'Confirmar acesso';
  }

  Object.entries(signupFields).forEach(([key, field]) => {
    if (!field.input) return;
    field.input.addEventListener('input', () => {
      field.customError = null;
      clearCardMessage(signupMessageEl);
      evaluateField(key);
      updateSignupButton();
    });
    field.input.addEventListener('blur', () => {
      field.touched = true;
      evaluateField(key, { force: true });
      updateSignupButton();
    });
  });

  updateSignupButton();
  updateLoginButton();
  updateConfirmButton();

  if (toggleSignupBtn) {
    toggleSignupBtn.addEventListener('click', () => {
      clearCardMessage(loginMessageEl);
      showAuthView('signup');
    });
  }
  if (toggleLoginBtn) {
    toggleLoginBtn.addEventListener('click', () => {
      clearCardMessage(signupMessageEl);
      showAuthView('login');
    });
  }
  if (confirmBackToLoginBtn) {
    confirmBackToLoginBtn.addEventListener('click', () => {
      clearCardMessage(confirmMsgEl);
      showAuthView('login');
    });
  }
  if (rememberMeCheckbox) {
    rememberMeCheckbox.addEventListener('change', () => {
      rememberPreference = !!rememberMeCheckbox.checked;
    });
  }

  [loginEmailInput, loginPasswordInput].forEach(input => {
    if (!input) return;
    input.addEventListener('input', () => clearCardMessage(loginMessageEl));
  });

  if (communityTextarea) {
    communityTextarea.addEventListener('input', () => {
      showCommunityError('');
      updateCommunityCounter();
      updateCommunityPublishState();
    });
  }

  if (communityAttachmentInput) {
    communityAttachmentInput.addEventListener('change', event => {
      const input = event.target;
      const files = input && input.files ? Array.from(input.files) : [];
      if (files.length) {
        files.forEach(file => uploadCommunityAttachmentFile(file));
      }
      if (input) {
        input.value = '';
      }
    });
  }

  if (communityPrivacySelect) {
    communityPrivacySelect.addEventListener('change', event => {
      const value = event && event.target ? event.target.value : communityState.privacy;
      setCommunityPrivacy(value);
    });
  }

  if (communityTargetsSelect) {
    communityTargetsSelect.addEventListener('change', () => {
      updateCommunityPublishState();
    });
  }

  if (communityPublishBtn) {
    communityPublishBtn.addEventListener('click', () => {
      if (!currentUser) {
        showToast({ message: 'Entre com sua conta para publicar no mural.', type: 'warning' });
        return;
      }
      const token = getSessionToken();
      if (!token) {
        expireSession(SESSION_EXPIRED_FALLBACK);
        return;
      }
      const message = communityTextarea ? communityTextarea.value.trim() : '';
      const attachments = communityState.attachments
        .map(att => att && att.id ? att.id : '')
        .filter(Boolean);
      const visibility = communityState.privacy === 'private' ? 'private' : 'public';
      const selectedTargets = getSelectedCommunityTargets();
      if (!message) {
        showCommunityError('Escreva uma mensagem para publicar.');
        if (communityTextarea) {
          try { communityTextarea.focus({ preventScroll: true }); } catch (err) { communityTextarea.focus(); }
        }
        return;
      }
      if (message.length > communityCharLimit) {
        showCommunityError(`A mensagem deve ter até ${communityCharLimit} caracteres.`);
        return;
      }
      if (visibility === 'private' && selectedTargets.length === 0) {
        showCommunityError('Selecione ao menos um destinatário para a publicação privada.');
        if (communityTargetsSelect) {
          try { communityTargetsSelect.focus({ preventScroll: true }); } catch (err) { communityTargetsSelect.focus(); }
        }
        return;
      }
      isPublishingCommunity = true;
      updateCommunityPublishState();
      showCommunityError('');
      google.script.run
        .withFailureHandler(err => {
          isPublishingCommunity = false;
          updateCommunityPublishState();
          if (handleSessionExpiredError(err, { onHandled: message => showCommunityError(message) })) {
            return;
          }
          showCommunityError(err?.message || 'Não foi possível publicar agora.');
        })
        .withSuccessHandler(() => {
          isPublishingCommunity = false;
          updateCommunityPublishState();
          if (communityTextarea) communityTextarea.value = '';
          communityState.attachments = [];
          renderCommunityAttachments();
          if (visibility === 'private' && communityTargetsSelect) {
            Array.from(communityTargetsSelect.options || []).forEach(option => { option.selected = false; });
          }
          updateCommunityCounter();
          updateCommunityPublishState();
          showCommunityError('');
          showToast({ message: 'Mensagem publicada no mural!', type: 'success' });
          refreshCommunityWall();
        })
        .addCommunityWallEntry({
          token,
          message,
          visibility,
          attachments,
          targetUserIds: visibility === 'private' ? selectedTargets : []
        });
    });
  }

  if (communityListEl) {
    communityListEl.addEventListener('click', event => {
      const target = event.target instanceof HTMLElement
        ? event.target.closest('[data-action="remove-wall-entry"]')
        : null;
      if (!target) return;
      event.preventDefault();
      if (!currentUser?.isAdmin) {
        showToast({ message: 'Apenas administradores podem remover publicações.', type: 'error' });
        return;
      }
      const postId = target.getAttribute('data-id') || '';
      if (!postId) return;
      const token = getSessionToken();
      if (!token) {
        expireSession(SESSION_EXPIRED_FALLBACK);
        return;
      }
      const button = target instanceof HTMLButtonElement ? target : target.closest('button');
      if (button) {
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
      }
      google.script.run
        .withFailureHandler(err => {
          if (button) {
            button.disabled = false;
            button.removeAttribute('aria-busy');
          }
          if (handleSessionExpiredError(err)) {
            return;
          }
          showToast({ message: err?.message || 'Não foi possível remover agora.', type: 'error' });
        })
        .withSuccessHandler(() => {
          showToast({ message: 'Publicação removida do mural.', type: 'success' });
          refreshCommunityWall();
        })
        .removeCommunityWallEntry({ token, postId });
    });
  }

  attachNavListeners(document);
  setActiveSubPageButtons(activeSubPage);
  renderStudentHero();
  updateCommunityCounter();
  renderCommunityAttachments();
  renderCommunityTargetsOptions();

  // UI switches
  function updateUI(options = {}) {
    const keepLevelIndicator = !!(options && options.keepLevelIndicator);
    const skipAchievements = !!(options && options.skipAchievements);
    const skipCommunity = !!(options && options.skipCommunity);
    const achievementsData = options && options.achievementsData;
    const achievementsUnlocked = options && options.achievementsUnlocked;
    const achievementsSilent = !!(options && options.silentAchievements);
    syncNavAvailability();
    ensureRouteAfterAuthChange();

    const activeUserId = currentUser?.id ?? null;
    const hasUserChanged = activeUserId !== lastPanelPollUserId;
    if (!currentUser || hasUserChanged) {
      panelPollState.forEach(poll => {
        poll.userChoice = null;
        poll.pendingChoice = null;
      });
    }
    lastPanelPollUserId = activeUserId;

    if (!currentUser) {
      $('#authSection').classList.remove('hidden');
      showAuthView('login');
      $('#dashSection').classList.add('hidden');
      $('#userInfo').textContent = 'Visitante';
      $('#btnLogout').classList.add('hidden');
      hasLoadedEmbeds = false;
      if (excelFrameEl) excelFrameEl.removeAttribute('src');
      if (pptFrameEl) pptFrameEl.removeAttribute('src');
      if (resourcesListEl) resourcesListEl.innerHTML = '';
      if (resourcesEmptyEl) {
        resourcesEmptyEl.textContent = 'Faça login com seu e-mail corporativo para visualizar os materiais compartilhados.';
        resourcesEmptyEl.classList.remove('hidden');
      }
      if (eventsListEl) eventsListEl.innerHTML = '';
      if (eventsEmptyEl) {
        eventsEmptyEl.textContent = 'Faça login com seu e-mail corporativo para acompanhar os próximos eventos.';
        eventsEmptyEl.classList.remove('hidden');
      }
      renderCommunityWall([]);
      if (communityEmptyEl) {
        communityEmptyEl.textContent = 'Faça login com sua conta corporativa para visualizar o mural da turma.';
        communityEmptyEl.classList.remove('hidden');
      }
      resetStudentStoryState();
      openStudentSubPage('home');
      resetHistorySection();
      resetLevelIndicator();
      resetAchievementsUI();
      syncAdminVisibility();
      updateCommunityAccess();
      syncHeaderContext();
      renderPolls();
      renderAdminBulletin();
      renderAdminMissionList();
      if (achievementsAdminNoticeEl) {
        if (achievementsAdminNoticeDefaultText) {
          achievementsAdminNoticeEl.textContent = achievementsAdminNoticeDefaultText;
        }
        achievementsAdminNoticeEl.classList.remove('hidden');
      }
      if (achievementsLeaderboardEl) achievementsLeaderboardEl.classList.add('hidden');
      if (achievementsPodiumEl) achievementsPodiumEl.innerHTML = '';
      if (achievementsLeaderboardTableEl) achievementsLeaderboardTableEl.innerHTML = '';
      if (achievementsRankingBadgeEl) achievementsRankingBadgeEl.textContent = 'Restrito à coordenação';
      return;
    }

    $('#authSection').classList.add('hidden');
    $('#dashSection').classList.remove('hidden');
    $('#btnLogout').classList.remove('hidden');
    $('#userInfo').textContent = currentUser.name + (currentUser.isAdmin ? ' (Admin)' : '');
    if (resourcesEmptyEl && resourcesEmptyDefaultText) resourcesEmptyEl.textContent = resourcesEmptyDefaultText;
    if (eventsEmptyEl && eventsEmptyDefaultText) eventsEmptyEl.textContent = eventsEmptyDefaultText;
    if (communityEmptyEl && communityEmptyDefaultText) communityEmptyEl.textContent = communityEmptyDefaultText;
    if (!hasLoadedEmbeds) {
      loadEmbeds();
    }
    setActiveSubPageButtons(activeSubPage);
    syncHeaderContext();
    renderPolls();
    loadShareableUsers();

    if (!keepLevelIndicator) {
      setLevelIndicatorLoading();
    }

    if (achievementsData) {
      applyAchievementsUpdate(achievementsData, achievementsUnlocked || [], { silent: achievementsSilent });
    } else if (!skipAchievements) {
      loadAchievementsOverview();
    }

    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        if (handleSessionExpiredError(err, {
          onHandled: message => {
            if (!keepLevelIndicator) {
              if (nextLevelTextEl) nextLevelTextEl.textContent = message;
              if (nextLevelPctEl) nextLevelPctEl.textContent = '—';
            }
          }
        })) {
          return;
        }
        console.error('Falha ao obter estado do usuário:', err);
        if (!keepLevelIndicator) {
          if (nextLevelTextEl) nextLevelTextEl.textContent = 'Não foi possível carregar o progresso agora.';
          if (nextLevelPctEl) nextLevelPctEl.textContent = '—';
        }
      })
      .withSuccessHandler(s => {
        $('#xpBox').textContent = s.xp;
        $('#lvlBox').textContent = s.level;
        $('#doneBox').textContent = s.concluidos;
        const pct = Math.round((s.concluidos / TOTAL_MODULES) * 100);
        $('#pctBox').textContent = pct + '%';
        $('#barBox').style.width = pct + '%';
        updateLevelIndicator(s);
        updateStudentStoryState({
          xp: s.xp,
          level: s.level,
          modulesCompleted: s.concluidos,
          metrics: { xpTotal: s.xp, modulesCompleted: s.concluidos }
        });
      })
      .getUserState({ token, userId: currentUser.id });

    loadHistoryForCurrentUser();
    refreshRanking();
    $('#adminPanel').classList.toggle('hidden', !currentUser.isAdmin);
    syncAdminVisibility();
    renderAdminBulletin();
    renderAdminMissionList();
    updateCommunityAccess();
    if (!skipCommunity) refreshCommunityWall();
  }

  function refreshRanking() {
    const simpleWrap = $('#rankWrap');
    const adminWrap = $('#adminRank');
    const isAdmin = !!(currentUser && currentUser.isAdmin);

    const renderSimpleList = entries => {
      if (simpleWrap) {
        simpleWrap.innerHTML = '';
        if (!entries.length) {
          const empty = document.createElement('div');
          empty.className = 'text-xs text-slate-500 dark:text-slate-400';
          empty.textContent = 'Ranking ainda não disponível.';
          simpleWrap.appendChild(empty);
        } else {
          entries.slice(0, 5).forEach(item => {
            const row = document.createElement('div');
            row.textContent = `${item.pos}º — ${item.name || 'Participante'} • ${formatNumber(item.xp)} XP`;
            simpleWrap.appendChild(row);
          });
        }
      }
      if (adminWrap) {
        adminWrap.innerHTML = '';
        if (!entries.length) {
          const empty = document.createElement('div');
          empty.className = 'text-xs text-slate-500 dark:text-slate-400';
          empty.textContent = 'Ranking ainda não disponível.';
          adminWrap.appendChild(empty);
        } else {
          entries.forEach(item => {
            const row = document.createElement('div');
            row.textContent = `${item.pos}º — ${item.name || 'Participante'} • ${formatNumber(item.xp)} XP`;
            adminWrap.appendChild(row);
          });
        }
      }
    };

    const renderAdminLeaderboard = entries => {
      if (achievementsRankingBadgeEl) {
        let label = 'Atualizado agora';
        if (timeFormatter) {
          try {
            label = `Atualizado às ${timeFormatter.format(new Date())}`;
          } catch (err) {
            label = 'Atualizado agora';
          }
        }
        achievementsRankingBadgeEl.textContent = label;
      }

      if (achievementsPodiumEl) {
        achievementsPodiumEl.innerHTML = '';
        const podiumByRank = {};
        entries.forEach(item => {
          if (item && item.pos && item.pos <= 3 && !podiumByRank[item.pos]) {
            podiumByRank[item.pos] = item;
          }
        });
        const order = [2, 1, 3];
        order.forEach(rank => {
          const entry = podiumByRank[rank];
          if (!entry) return;
          const card = document.createElement('div');
          let classes = 'podium-card';
          if (rank === 1) classes += ' podium-card-first';
          else if (rank === 2) classes += ' podium-card-second';
          else if (rank === 3) classes += ' podium-card-third';
          card.className = classes;
          const rankLabel = document.createElement('div');
          rankLabel.className = 'podium-rank';
          rankLabel.textContent = `${rank}º lugar`;
          const nameEl = document.createElement('div');
          nameEl.className = 'podium-name';
          nameEl.textContent = entry.name || 'Participante';
          const scoreEl = document.createElement('div');
          scoreEl.className = 'podium-score';
          scoreEl.textContent = `Nível ${formatNumber(entry.level)} • ${formatNumber(entry.xp)} XP`;
          card.append(rankLabel, nameEl, scoreEl);
          achievementsPodiumEl.appendChild(card);
        });
        if (!achievementsPodiumEl.children.length) {
          const empty = document.createElement('p');
          empty.className = 'text-sm text-slate-500 dark:text-slate-300';
          empty.textContent = 'Ranking ainda não possui participantes suficientes.';
          achievementsPodiumEl.appendChild(empty);
        }
      }

      if (achievementsLeaderboardTableEl) {
        achievementsLeaderboardTableEl.innerHTML = '';
        if (!entries.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 2;
          td.className = 'px-4 py-4 text-sm text-slate-500 dark:text-slate-300';
          td.textContent = 'Nenhum aluno ranqueado ainda.';
          tr.appendChild(td);
          achievementsLeaderboardTableEl.appendChild(tr);
        } else {
          entries.forEach(entry => {
            const tr = document.createElement('tr');
            const infoTd = document.createElement('td');
            infoTd.className = 'px-4 py-3 align-middle';
            const nameDiv = document.createElement('div');
            nameDiv.className = 'leaderboard-name';
            nameDiv.textContent = `${entry.pos}º — ${entry.name || 'Participante'}`;
            const metaDiv = document.createElement('div');
            metaDiv.className = 'leaderboard-meta';
            metaDiv.textContent = `Nível ${formatNumber(entry.level)} • ${formatNumber(entry.xp)} XP`;
            infoTd.append(nameDiv, metaDiv);
            const xpTd = document.createElement('td');
            xpTd.className = 'px-4 py-3 text-right align-middle font-semibold text-slate-600 dark:text-slate-200';
            xpTd.textContent = `${formatNumber(entry.xp)} XP`;
            tr.append(infoTd, xpTd);
            achievementsLeaderboardTableEl.appendChild(tr);
          });
        }
      }

      if (achievementsLeaderboardEl) {
        achievementsLeaderboardEl.classList.remove('hidden');
      }
      if (achievementsRankingBadgeEl && !entries.length) {
        achievementsRankingBadgeEl.textContent = 'Sem participantes';
      }
    };

    const resetAdminNotice = () => {
      if (!achievementsAdminNoticeEl) return;
      if (achievementsAdminNoticeDefaultText) {
        achievementsAdminNoticeEl.textContent = achievementsAdminNoticeDefaultText;
      }
    };

    resetAdminNotice();
    if (!isAdmin) {
      if (achievementsAdminNoticeEl) achievementsAdminNoticeEl.classList.remove('hidden');
      if (achievementsLeaderboardEl) achievementsLeaderboardEl.classList.add('hidden');
      if (achievementsPodiumEl) achievementsPodiumEl.innerHTML = '';
      if (achievementsLeaderboardTableEl) achievementsLeaderboardTableEl.innerHTML = '';
      if (achievementsRankingBadgeEl) achievementsRankingBadgeEl.textContent = 'Restrito à coordenação';
    } else {
      if (achievementsAdminNoticeEl) achievementsAdminNoticeEl.classList.add('hidden');
      if (achievementsLeaderboardEl) achievementsLeaderboardEl.classList.remove('hidden');
      if (achievementsPodiumEl) {
        achievementsPodiumEl.innerHTML = '';
        const placeholder = document.createElement('p');
        placeholder.className = 'text-sm text-slate-500 dark:text-slate-300';
        placeholder.textContent = 'Carregando ranking...';
        achievementsPodiumEl.appendChild(placeholder);
      }
      if (achievementsLeaderboardTableEl) achievementsLeaderboardTableEl.innerHTML = '';
      if (achievementsRankingBadgeEl) achievementsRankingBadgeEl.textContent = 'Atualizando...';
    }

    google.script.run
      .withFailureHandler(err => {
        renderSimpleList([]);
        if (isAdmin) {
          if (achievementsLeaderboardEl) achievementsLeaderboardEl.classList.add('hidden');
          if (achievementsAdminNoticeEl) {
            achievementsAdminNoticeEl.textContent = err?.message || 'Não foi possível carregar o ranking agora.';
            achievementsAdminNoticeEl.classList.remove('hidden');
          }
          if (achievementsRankingBadgeEl) achievementsRankingBadgeEl.textContent = 'Falha ao atualizar';
        }
        console.error('Falha ao carregar ranking:', err);
      })
      .withSuccessHandler(list => {
        const entries = Array.isArray(list) ? list : [];
        renderSimpleList(entries);
        if (isAdmin) {
          if (achievementsAdminNoticeEl) achievementsAdminNoticeEl.classList.add('hidden');
          renderAdminLeaderboard(entries);
        }
      })
      .getRanking();
  }

  // AUTH
  if (btnSignup) {
    btnSignup.addEventListener('click', () => {
      clearCardMessage(signupMessageEl);
      Object.values(signupFields).forEach(field => { field.touched = true; });
      const isValid = requiredSignupKeys.every(key => evaluateField(key, { force: true }));
      updateSignupButton();
      if (!isValid) {
        renderCardMessage(signupMessageEl, 'error', 'Revise os campos destacados.');
        return;
      }

      const payload = {
        name: signupFields.name.input.value.trim(),
        email: signupFields.email.input.value.trim(),
        password: signupFields.password.input.value,
        adminCode: signupFields.adminCode.input.value.trim()
      };

      isSignupSubmitting = true;
      updateSignupButton();

      google.script.run
        .withFailureHandler(err => {
          isSignupSubmitting = false;
          renderCardMessage(signupMessageEl, 'error', err.message || err);
          updateSignupButton();
        })
        .withSuccessHandler(res => {
          isSignupSubmitting = false;
          updateSignupButton();

          if (res && res.ok && res.requiresConfirmation && res.confirmation) {
            renderCardMessage(signupMessageEl, 'success', res.message || 'Enviamos um código de confirmação para o seu e-mail.');
            openConfirmationView(res.confirmation, { remember: rememberPreference });
            renderCardMessage(confirmMsgEl, 'success', res.message || 'Insira o código enviado para ativar sua conta.');
            return;
          }

          if (res && res.ok && res.user && res.token) {
            clearCardMessage(signupMessageEl);
            currentUser = res.user;
            persistSession(res.token, res.user, { remember: rememberPreference });
            updateUI();
            return;
          }

          if (res && res.errors) {
            Object.entries(res.errors).forEach(([fieldKey, message]) => {
              const field = signupFields[fieldKey];
              if (field) {
                field.touched = true;
                field.customError = message;
                evaluateField(fieldKey, { force: true });
              }
            });
          }

          let messageText = 'Revise os campos destacados.';
          if (res && res.message) {
            messageText = res.message;
          } else if (!res || !res.errors || Object.keys(res.errors).length === 0) {
            messageText = 'Não foi possível criar a conta. Tente novamente.';
          }
          renderCardMessage(signupMessageEl, 'error', messageText);
        })
        .registerUser(payload);
    });
  }

  function handleLoginSubmit() {
    if (isLoginSubmitting) return;
    clearCardMessage(loginMessageEl);
    const email = loginEmailInput ? loginEmailInput.value.trim() : '';
    const password = loginPasswordInput ? loginPasswordInput.value.trim() : '';
    rememberPreference = !!(rememberMeCheckbox && rememberMeCheckbox.checked);
    if (!email || !password) {
      renderCardMessage(loginMessageEl, 'error', 'Informe e-mail e senha.');
      return;
    }

    isLoginSubmitting = true;
    updateLoginButton();

    google.script.run
      .withFailureHandler(err => {
        isLoginSubmitting = false;
        updateLoginButton();
        renderCardMessage(loginMessageEl, 'error', err.message || err);
      })
      .withSuccessHandler(res => {
        isLoginSubmitting = false;
        updateLoginButton();
        if (res && res.ok && res.user && res.token) {
          clearCardMessage(loginMessageEl);
          currentUser = res.user;
          persistSession(res.token, res.user, { remember: rememberPreference });
          updateUI();
          return;
        }
        if (res && res.requiresConfirmation && res.confirmation) {
          renderCardMessage(loginMessageEl, 'success', res.message || 'Confirme o código enviado para ativar seu acesso.');
          openConfirmationView(res.confirmation, { remember: rememberPreference });
          renderCardMessage(confirmMsgEl, 'success', 'Digite o código enviado para concluir o login.');
          return;
        }
        renderCardMessage(loginMessageEl, 'error', (res && res.message) || 'Não foi possível entrar. Tente novamente.');
      })
      .loginUser({ email, password });
  }

  if (loginForm) {
    loginForm.addEventListener('submit', event => {
      event.preventDefault();
      handleLoginSubmit();
    });
  }

  if (confirmForm) {
    confirmForm.addEventListener('submit', event => {
      event.preventDefault();
      if (isConfirmSubmitting) return;
      if (!pendingConfirmation || !pendingConfirmation.email) {
        renderCardMessage(confirmMsgEl, 'error', 'Solicite o cadastro novamente para receber um novo código.');
        return;
      }
      const codeValue = confirmCodeInput ? confirmCodeInput.value.trim() : '';
      if (!codeValue) {
        renderCardMessage(confirmMsgEl, 'error', 'Informe o código enviado por e-mail.');
        return;
      }
      isConfirmSubmitting = true;
      updateConfirmButton();
      google.script.run
        .withFailureHandler(err => {
          isConfirmSubmitting = false;
          updateConfirmButton();
          renderCardMessage(confirmMsgEl, 'error', err.message || err);
        })
        .withSuccessHandler(res => {
          isConfirmSubmitting = false;
          updateConfirmButton();
          if (res && res.ok && res.user && res.token) {
            clearCardMessage(confirmMsgEl);
            const remember = pendingConfirmation && Object.prototype.hasOwnProperty.call(pendingConfirmation, 'remember')
              ? !!pendingConfirmation.remember
              : rememberPreference;
            currentUser = res.user;
            persistSession(res.token, res.user, { remember });
            pendingConfirmation = null;
            resetConfirmationCountdown();
            updateUI();
            return;
          }
          if (res && res.alreadyConfirmed && res.user && res.token) {
            clearCardMessage(confirmMsgEl);
            const remember = pendingConfirmation && Object.prototype.hasOwnProperty.call(pendingConfirmation, 'remember')
              ? !!pendingConfirmation.remember
              : rememberPreference;
            currentUser = res.user;
            persistSession(res.token, res.user, { remember });
            pendingConfirmation = null;
            resetConfirmationCountdown();
            updateUI();
            return;
          }
          if (res && res.expired) {
            renderCardMessage(confirmMsgEl, 'error', res.message || 'O código informado expirou. Solicite um novo envio.');
            return;
          }
          renderCardMessage(confirmMsgEl, 'error', (res && res.message) || 'Não foi possível confirmar o cadastro. Tente novamente.');
        })
        .confirmUserRegistration({ email: pendingConfirmation.email, code: codeValue });
    });
  }

  if (btnResendConfirmation) {
    btnResendConfirmation.addEventListener('click', () => {
      if (!pendingConfirmation || !pendingConfirmation.email) {
        renderCardMessage(confirmMsgEl, 'error', 'Cadastre-se novamente para gerar um novo código.');
        return;
      }
      const originalLabel = btnResendConfirmation.textContent;
      btnResendConfirmation.disabled = true;
      btnResendConfirmation.textContent = 'Reenviando...';
      google.script.run
        .withFailureHandler(err => {
          btnResendConfirmation.disabled = false;
          btnResendConfirmation.textContent = originalLabel;
          renderCardMessage(confirmMsgEl, 'error', err.message || err);
        })
        .withSuccessHandler(res => {
          btnResendConfirmation.disabled = false;
          btnResendConfirmation.textContent = originalLabel;
          if (res && res.ok && res.confirmation) {
            openConfirmationView(res.confirmation, { remember: pendingConfirmation && pendingConfirmation.remember });
            renderCardMessage(confirmMsgEl, 'success', 'Enviamos um novo código de confirmação para seu e-mail.');
            return;
          }
          if (res && res.alreadyConfirmed && currentUser) {
            renderCardMessage(confirmMsgEl, 'info', 'Este acesso já foi confirmado. Faça login normalmente.');
            showAuthView('login');
            return;
          }
          renderCardMessage(confirmMsgEl, 'error', (res && res.message) || 'Não foi possível reenviar o código agora.');
        })
        .resendConfirmationCode({ email: pendingConfirmation.email });
    });
  }

  $('#btnLogout').onclick = () => {
    const finish = () => {
      clearStoredSession();
      currentUser = null;
      sessionExpiryNotified = false;
      updateUI();
    };
    const stored = getStoredSession();
    const token = stored && stored.token;
    if (!token) {
      finish();
      return;
    }
    google.script.run
      .withFailureHandler(() => finish())
      .withSuccessHandler(() => finish())
      .logout(token);
  };

  // Check-in
  $('#btnCheckin').onclick = ()=>{
    if (!currentUser) return showToast({ message: 'Faça login primeiro.', type: 'warning' });
    const token = getSessionToken();
    if (!token) {
      expireSession(SESSION_EXPIRED_FALLBACK);
      return;
    }
    google.script.run
      .withFailureHandler(err => {
        if (handleSessionExpiredError(err, { onHandled: () => { $('#checkinMsg').textContent = ''; } })) {
          return;
        }
        showToast({ message: err?.message || err, type: 'error' });
      })
      .withSuccessHandler(res=>{
        if (res && res.ok) {
          const bonusXP = Number(res.achievementBonusXP || 0);
          const unlockedAchievements = Array.isArray(res.achievementsUnlocked) ? res.achievementsUnlocked : [];
          if (res.achievementsOverview) {
            applyAchievementsUpdate(res.achievementsOverview, unlockedAchievements);
          } else if (unlockedAchievements.length) {
            handleAchievementToasts(unlockedAchievements);
          }
          updateStudentStoryState({ checkinToday: true });
          const extra = formatLevelProgressMessage(res);
          const totalXP = Number.isFinite(Number(res.totalXP)) ? Number(res.totalXP) : res.totalXP;
          const bonusText = bonusXP > 0 ? ` Bônus de conquistas: +${bonusXP} XP.` : '';
          $('#checkinMsg').textContent = `Presença registrada (+${res.xpGanho} XP).${bonusText} Total: ${totalXP} XP.${extra}`;
          if (Number.isFinite(Number(totalXP))) $('#xpBox').textContent = totalXP;
          if (Number.isFinite(Number(res.level))) $('#lvlBox').textContent = res.level;
          updateLevelIndicator(res);
          updateUI({ keepLevelIndicator: true, skipAchievements: true, skipCommunity: true });
        } else {
          $('#checkinMsg').textContent = res?.msg || 'Não foi possível registrar o check-in.';
        }
        setTimeout(()=> $('#checkinMsg').textContent='', 3000);
      })
      .checkin({ token, userId: currentUser.id });
  };

  // Embeds
  if (btnSaveEmbeds) {
    btnSaveEmbeds.addEventListener('click', () => {
      if (!currentUser?.isAdmin) {
        showToast({ message: 'Somente administradores podem atualizar os materiais.', type: 'warning' });
        return;
      }
      const token = getSessionToken();
      if (!token) {
        expireSession(SESSION_EXPIRED_FALLBACK);
        return;
      }
      const excel = excelLinkInput ? excelLinkInput.value.trim() : '';
      const ppt = pptLinkInput ? pptLinkInput.value.trim() : '';
      const recommendedResources = collectTextareaList(resourcesInputEl);
      const upcomingEvents = collectTextareaList(eventsInputEl);
      google.script.run
        .withFailureHandler(err => {
          if (handleSessionExpiredError(err)) {
            return;
          }
          showToast({ message: err?.message || err, type: 'error' });
        })
        .withSuccessHandler(() => {
          showToast({ message: 'Materiais atualizados com sucesso.', type: 'success' });
          loadEmbeds();
        })
        .saveEmbeds({ excel, ppt, token, recommendedResources, upcomingEvents });
    });
  }
  if (btnLoadEmbeds) {
    btnLoadEmbeds.addEventListener('click', () => loadEmbeds());
  }
  function loadEmbeds() {
    if (!currentUser) return;
    google.script.run
      .withFailureHandler(err => {
        console.error('Falha ao carregar materiais compartilhados:', err);
      })
      .withSuccessHandler(data => {
        hasLoadedEmbeds = true;
        if (excelFrameEl) excelFrameEl.src = normalizeEmbed(data.excel || '');
        if (pptFrameEl) pptFrameEl.src = normalizeEmbed(data.ppt || '');
        if (excelLinkInput) excelLinkInput.value = data.excel || '';
        if (pptLinkInput) pptLinkInput.value = data.ppt || '';
        renderHighlightList(resourcesListEl, data?.recommendedResources, resourcesEmptyEl);
        renderHighlightList(eventsListEl, data?.upcomingEvents, eventsEmptyEl);
        if (resourcesInputEl) {
          const list = Array.isArray(data?.recommendedResources) ? data.recommendedResources : [];
          resourcesInputEl.value = list.join('\n');
        }
        if (eventsInputEl) {
          const list = Array.isArray(data?.upcomingEvents) ? data.upcomingEvents : [];
          eventsInputEl.value = list.join('\n');
        }
      })
      .getEmbeds();
  }

  if (btnSaveBulletinEl) {
    btnSaveBulletinEl.addEventListener('click', () => {
      if (!currentUser?.isAdmin) {
        showToast({ message: 'Somente administradores podem publicar informativos.', type: 'warning' });
        return;
      }
      const text = adminBulletinInputEl ? adminBulletinInputEl.value.trim() : '';
      adminBulletinState = {
        content: text,
        updatedAt: new Date()
      };
      renderAdminBulletin();
      showToast({ message: 'Informativo atualizado para toda a turma.', type: 'success' });
    });
  }

  if (btnDiscardBulletinEl) {
    btnDiscardBulletinEl.addEventListener('click', () => {
      if (!currentUser?.isAdmin) return;
      if (adminBulletinInputEl) adminBulletinInputEl.value = adminBulletinState?.content || '';
      showToast({ message: 'Rascunho restaurado.', type: 'info' });
    });
  }

  if (btnResetMission) {
    btnResetMission.addEventListener('click', () => {
      if (missionTitleInput) missionTitleInput.value = '';
      if (missionDescriptionInput) missionDescriptionInput.value = '';
      if (missionXPInput) missionXPInput.value = '';
      if (missionValidityInput) missionValidityInput.value = '';
      if (missionAudienceSelect) missionAudienceSelect.value = 'all';
      if (missionAttachmentsInput) missionAttachmentsInput.value = '';
    });
  }

  if (btnLaunchMission) {
    btnLaunchMission.addEventListener('click', () => {
      if (!currentUser?.isAdmin) {
        showToast({ message: 'Somente administradores podem lançar missões.', type: 'warning' });
        return;
      }
      const title = missionTitleInput ? missionTitleInput.value.trim() : '';
      const description = missionDescriptionInput ? missionDescriptionInput.value.trim() : '';
      const xpValue = missionXPInput ? Number(missionXPInput.value) : NaN;
      const validity = missionValidityInput ? missionValidityInput.value : '';
      const audience = missionAudienceSelect ? missionAudienceSelect.value : 'all';
      const attachments = collectTextareaList(missionAttachmentsInput);
      if (!title) {
        showToast({ message: 'Informe um título para a missão.', type: 'error' });
        return;
      }
      if (!Number.isFinite(xpValue) || xpValue < 5 || xpValue > 60) {
        showToast({ message: 'Defina um XP entre 5 e 60 pontos.', type: 'error' });
        return;
      }
      const mission = {
        id: `mission-${Date.now()}`,
        title,
        description,
        xp: Math.round(xpValue),
        audience,
        validity,
        attachments
      };
      adminMissionsState.unshift(mission);
      renderAdminMissionList();
      if (btnResetMission) btnResetMission.click();
      showToast({ message: 'Missão lançada para a turma!', type: 'success' });
    });
  }

  // Boot
  (function init(){
    bootstrapRouter();
    syncAdminVisibility();
    updateCommunityAccess();
    syncNavAvailability();
    renderAdminBulletin();
    renderAdminMissionList();
    renderPanelPage();
    const stored = getStoredSession();
    if (stored && stored.token) {
      currentSessionToken = stored.token;
    }
    const authSection = $('#authSection');
    if (authSection) authSection.classList.add('hidden');

    if (stored && stored.token) {
      google.script.run
        .withFailureHandler(() => {
          clearStoredSession();
          updateUI();
        })
        .withSuccessHandler(user => {
          if (user && user.id) {
            currentUser = user;
            persistSession(stored.token, user);
          } else {
            clearStoredSession();
          }
          updateUI();
        })
        .resumeSession(stored.token);
    } else {
      updateUI();
    }
  })();
</script>
</body>
</html>
